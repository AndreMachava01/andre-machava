{% extends 'base_admin.html' %}
{% load static %}

{% block title %}Adicionar Item Rapidamente - {{ requisicao.codigo }}{% endblock %}

{% block extra_style %}
<style>
    /* Estilos específicos do módulo - apenas gradiente no header */
    .page-header,
    .hero-section,
    .dashboard-header,
    .nav-top {
        background: var(--purple-gradient);
    }
</style>
{% endblock %}

{% block content %}
<div class="modern-container">
    <!-- Header -->
    <div class="hero-section">
        <h1 class="hero-title">
            <i class="fas fa-plus-circle"></i> Adicionar Item Rapidamente
        </h1>
        <div class="hero-actions">
            <a href="{% url 'stock:requisicoes:detail' requisicao.id %}" class="btn-modern btn-secondary-modern">
                <i class="fas fa-arrow-left"></i>Voltar
            </a>
        </div>
    </div>

    <!-- Content -->
    <div class="content-area">
        <div class="form-container">
            <!-- Informações do Item -->
            <div class="item-info">
                <h4><i class="fas fa-box"></i> Item Selecionado</h4>
                <div class="item-details">
                    <div class="item-detail">
                        <div class="item-detail-label">Nome</div>
                        <div class="item-detail-value">{{ item.nome }}</div>
                    </div>
                    <div class="item-detail">
                        <div class="item-detail-label">Código</div>
                        <div class="item-detail-value">{{ item.codigo }}</div>
                    </div>
                    <div class="item-detail">
                        <div class="item-detail-label">Tipo</div>
                        <div class="item-detail-value">{{ item.get_tipo_display }}</div>
                    </div>
                    <div class="item-detail">
                        <div class="item-detail-label">Unidade</div>
                        <div class="item-detail-value">{{ item.unidade_medida }}</div>
                    </div>
                    <div class="item-detail">
                        <div class="item-detail-label">Preço</div>
                        <div class="item-detail-value">{{ item.preco_custo|floatformat:2 }} MT</div>
                    </div>
                    <div class="item-detail">
                        <div class="item-detail-label">Stock Disponível</div>
                        <div class="item-detail-value">{{ stock_disponivel }}</div>
                    </div>
                </div>
                
                {% if stock_disponivel == 0 %}
                <div class="stock-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    Este item não está disponível na sucursal {{ requisicao.sucursal_destino.nome }}!
                </div>
                {% elif stock_disponivel < 10 %}
                <div class="stock-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    Atenção: O stock disponível é limitado!
                </div>
                {% endif %}
            </div>

            <!-- Formulário -->
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="item" value="{{ item.id }}">
                
                <!-- Sugestões de Quantidade -->
                {% if sugestoes %}
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-lightbulb"></i> Sugestões de Quantidade
                    </label>
                    <div class="sugestoes-container">
                        <div class="sugestao-item" data-quantidade="{{ sugestoes.minima }}">
                            <div class="sugestao-label">Mínima</div>
                            <div class="sugestao-desc">Para atingir estoque mínimo</div>
                            <div class="sugestao-valor">{{ sugestoes.minima }}</div>
                        </div>
                        <div class="sugestao-item" data-quantidade="{{ sugestoes.recomendada }}">
                            <div class="sugestao-label">Recomendada</div>
                            <div class="sugestao-desc">Para estoque equilibrado</div>
                            <div class="sugestao-valor">{{ sugestoes.recomendada }}</div>
                        </div>
                        <div class="sugestao-item" data-quantidade="{{ sugestoes.maxima }}">
                            <div class="sugestao-label">Máxima</div>
                            <div class="sugestao-desc">Para atingir estoque máximo</div>
                            <div class="sugestao-valor">{{ sugestoes.maxima }}</div>
                        </div>
                    </div>
                    <div class="form-help">Clique em uma sugestão para usar a quantidade</div>
                </div>
                {% endif %}

                <div class="form-group">
                    <label class="form-label" for="quantidade">
                        <i class="fas fa-hashtag"></i> Quantidade Solicitada
                    </label>
                    <input type="number" name="quantidade" id="quantidade" class="form-control-modern" 
                           min="1" max="{{ stock_disponivel }}" required 
                           placeholder="Digite a quantidade desejada"
                           {% if stock_disponivel == 0 %}disabled{% endif %}>
                    <div class="form-help">
                        {% if stock_disponivel > 0 %}
                            Máximo disponível: {{ stock_disponivel }} unidades
                        {% else %}
                            Item não disponível na sucursal de destino
                        {% endif %}
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="observacoes">
                        <i class="fas fa-comment"></i> Observações
                    </label>
                    <textarea name="observacoes" id="observacoes" class="form-control-modern form-textarea" 
                              placeholder="Observações sobre este item (opcional)"></textarea>
                    <div class="form-help">Informações adicionais sobre este item</div>
                </div>

                <div class="form-actions">
                    <a href="{% url 'stock:requisicoes:detail' requisicao.id %}" class="btn-form btn-cancel">
                        <i class="fas fa-times"></i>Cancelar
                    </a>
                    <button type="submit" class="btn-form btn-submit" {% if stock_disponivel == 0 %}disabled{% endif %}>
                        <i class="fas fa-plus"></i>Adicionar à Requisição
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const quantidadeInput = document.getElementById('quantidade');
    const sugestoesItems = document.querySelectorAll('.sugestao-item');
    
    // Adicionar event listeners para sugestões
    sugestoesItems.forEach(item => {
        item.addEventListener('click', function() {
            const quantidade = this.dataset.quantidade;
            if (quantidade) {
                quantidadeInput.value = quantidade;
                
                // Destacar sugestão selecionada
                sugestoesItems.forEach(i => i.classList.remove('selected'));
                this.classList.add('selected');
            }
        });
    });
    
    // Validação do formulário
    document.querySelector('form').addEventListener('submit', function(e) {
        const quantidade = parseInt(quantidadeInput.value);
        const stockDisponivel = {{ stock_disponivel }};
        
        if (stockDisponivel === 0) {
            alert('Este item não está disponível na sucursal de destino!');
            e.preventDefault();
            return false;
        }
        
        if (!quantidade || quantidade <= 0) {
            alert('Por favor, digite uma quantidade válida!');
            e.preventDefault();
            return false;
        }
        
        if (quantidade > stockDisponivel) {
            alert(`A quantidade solicitada (${quantidade}) não pode ser maior que o stock disponível (${stockDisponivel})!`);
            e.preventDefault();
            return false;
        }
    });
});
</script>
{% endblock %}
