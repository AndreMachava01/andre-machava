<script>

let charts = {};

// Configuração padrão do Chart.js para tema escuro
Chart.defaults.font.family = "'Inter', sans-serif";
Chart.defaults.font.size = 12;
Chart.defaults.color = '#d1d5db';

// Inicializar gráficos
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM carregado, inicializando gráficos...');
    initializeCharts();
});

// Função de teste para verificar se os cliques estão funcionando
function testClick() {
    console.log('=== ATUALIZANDO GRÁFICOS ===');
    console.log('Botão funcionando corretamente');
    console.log('=============================');
    
    // Chamar a função original
    updateCharts();
}

// Função de debug (disponível no console)
function debugElements() {
    console.log('=== DEBUG ELEMENTOS ===');
    console.log('periodoSelect:', document.getElementById('periodoSelect'));
    console.log('tipoItemSelect:', document.getElementById('tipoItemSelect'));
    console.log('updateButton:', document.querySelector('button[onclick="testClick()"]'));
    console.log('charts object:', charts);
    console.log('=======================');
}

function initializeCharts() {
    // Gráfico de Movimentações
    const movimentacoesCtx = document.getElementById('movimentacoesChart').getContext('2d');
    charts.movimentacoes = new Chart(movimentacoesCtx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: []
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            aspectRatio: 2,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        color: '#d1d5db'
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        color: '#d1d5db'
                    },
                    grid: {
                        color: '#4b5563'
                    }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#d1d5db'
                    },
                    grid: {
                        color: '#4b5563'
                    }
                }
            }
        }
    });

    // Gráfico de Estoque por Sucursal
    const estoqueSucursalCtx = document.getElementById('estoqueSucursalChart').getContext('2d');
    charts.estoqueSucursal = new Chart(estoqueSucursalCtx, {
        type: 'doughnut',
        data: {
            labels: [],
            datasets: []
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            aspectRatio: 1,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#d1d5db'
                    }
                }
            }
        }
    });

    // Gráfico de Categorias
    const categoriasCtx = document.getElementById('categoriasChart').getContext('2d');
    charts.categorias = new Chart(categoriasCtx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: []
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            aspectRatio: 2,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        color: '#d1d5db'
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        color: '#d1d5db'
                    },
                    grid: {
                        color: '#4b5563'
                    }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#d1d5db'
                    },
                    grid: {
                        color: '#4b5563'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    beginAtZero: true,
                    ticks: {
                        color: '#d1d5db'
                    },
                    grid: {
                        color: '#4b5563'
                    }
                }
            }
        }
    });

    // Gráfico de Tendências
    const tendenciasCtx = document.getElementById('tendenciasChart').getContext('2d');
    charts.tendencias = new Chart(tendenciasCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: []
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            aspectRatio: 2,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        color: '#d1d5db'
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        color: '#d1d5db'
                    },
                    grid: {
                        color: '#4b5563'
                    }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#d1d5db'
                    },
                    grid: {
                        color: '#4b5563'
                    }
                }
            }
        }
    });

    // Carregar dados iniciais
    updateCharts();
}

function updateCharts() {
    console.log('Atualizando gráficos...');
    
    // Verificar se os elementos existem
    const periodoSelect = document.getElementById('periodoSelect');
    const tipoItemSelect = document.getElementById('tipoItemSelect');
    
    const periodo = periodoSelect ? periodoSelect.value : '30';
    const tipoItem = tipoItemSelect ? tipoItemSelect.value : '';
    
    console.log('Período:', periodo, 'Tipo|default:0 items:', tipoItem);
    
    // Mostrar indicador de carregamento
    const updateButton = document.querySelector('button[onclick="updateCharts()"]');
    if (updateButton) {
        const originalText = updateButton.innerHTML;
        updateButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Atualizando...';
        updateButton.disabled = true;
        
        // Restaurar botão após 3 segundos
        setTimeout(() => {
            updateButton.innerHTML = originalText;
            updateButton.disabled = false;
        }, 3000);
    }
    
    // Atualizar gráfico de movimentações
    fetch(`/stock/dashboard/chart-movimentacoes/?dias=${periodo}&tipo_item=${tipoItem}`)
        .then(response => {
            console.log('Resposta movimentações:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Dados movimentações:', data);
            if (data.error) {
                console.error('Erro ao carregar movimentações:', data.error);
                return;
            }
            if (charts.movimentacoes) {
                charts.movimentacoes.data.labels = data.labels;
                charts.movimentacoes.data.datasets = data.datasets;
                charts.movimentacoes.update();
                console.log('Gráfico movimentações atualizado');
            }
        })
        .catch(error => console.error('Erro movimentações:', error));

    // Atualizar gráfico de estoque por sucursal
    fetch('/stock/dashboard/chart-estoque-sucursal/')
        .then(response => {
            console.log('Resposta estoque sucursal:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Dados estoque sucursal:', data);
            if (data.error) {
                console.error('Erro ao carregar estoque sucursal:', data.error);
                return;
            }
            if (charts.estoqueSucursal) {
                charts.estoqueSucursal.data.labels = data.labels;
                charts.estoqueSucursal.data.datasets = data.datasets;
                charts.estoqueSucursal.update();
                console.log('Gráfico estoque sucursal atualizado');
            }
        })
        .catch(error => console.error('Erro estoque sucursal:', error));

    // Atualizar gráfico de categorias
    fetch('/stock/dashboard/chart-categorias/')
        .then(response => {
            console.log('Resposta categorias:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Dados categorias:', data);
            if (data.error) {
                console.error('Erro ao carregar categorias:', data.error);
                return;
            }
            if (charts.categorias) {
                charts.categorias.data.labels = data.labels;
                charts.categorias.data.datasets = data.datasets;
                charts.categorias.update();
                console.log('Gráfico categorias atualizado');
            }
        })
        .catch(error => console.error('Erro categorias:', error));

    // Atualizar gráfico de tendências
    fetch(`/stock/dashboard/chart-tendencias/?dias=${periodo}`)
        .then(response => {
            console.log('Resposta tendências:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Dados tendências:', data);
            if (data.error) {
                console.error('Erro ao carregar tendências:', data.error);
                return;
            }
            if (charts.tendencias) {
                charts.tendencias.data.labels = data.labels;
                charts.tendencias.data.datasets = data.datasets;
                charts.tendencias.update();
                console.log('Gráfico tendências atualizado');
            }
        })
        .catch(error => console.error('Erro tendências:', error));
}

// Atualizar gráficos a cada 5 minutos
setInterval(updateCharts, 300000);

// Redimensionar gráficos quando a janela for redimensionada
window.addEventListener('resize', function() {
    if (charts.movimentacoes) charts.movimentacoes.resize();
    if (charts.estoqueSucursal) charts.estoqueSucursal.resize();
    if (charts.categorias) charts.categorias.resize();
    if (charts.tendencias) charts.tendencias.resize();
});

</script>

{% extends "base_admin.html" %}
{% load static %}

{% block title %}Dashboard Executivo - Stock{% endblock %}

{% block extra_style %}

{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Header -->
    <div class="dashboard-header">
        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
            <div>
                <h1 class="dashboard-title">
                    <i class="fas fa-chart-line"></i>
                    Dashboard Executivo
                </h1>
                <p class="dashboard-subtitle">
                    Visão geral do sistema de gestão de stock - {{ periodo_analise }}
                </p>
            </div>
            <div style="display: flex; gap: 15px; align-items: center; position: relative; z-index: 1000;">
                <button onclick="this.style.background='rgba(255, 255, 255, 0.2)'" class="btn btn-primary btn-responsive" id="btn-update" aria-label="Botão de atualização" title="Clique para atualizar gráficos" tabindex="0" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação"" tabindex="0" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação"" tabindex="0" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação"" tabindex="0" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação"" tabindex="0" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação"" tabindex="0" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação"" tabindex="0">
                    <i class="fas fa-sync-alt"></i> Atualizar
                </button>
                </div>
            </div>
            
            <!-- Grid de Gráficos -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
                <!-- Gráfico de Movimentações -->
                <div style="background: #1f2937; border-radius: 12px; padding: 20px; border: 1px solid #4b5563;">
                    <h4 style="color: #f9fafb; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-chart-bar" style="color: #8b5cf6;"></i>
                        Movimentações por Dia
                    </h4>
                    <div style="position: relative; height: 300px; width: 100%;">
                        <canvas id="movimentacoesChart"></canvas>
                    </div>
                </div>

                <!-- Gráfico de Estoque por Sucursal -->
                <div style="background: #1f2937; border-radius: 12px; padding: 20px; border: 1px solid #4b5563;">
                    <h4 style="color: #f9fafb; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-chart-pie" style="color: #8b5cf6;"></i>
                        Estoque por Sucursal
                    </h4>
                    <div style="position: relative; height: 300px; width: 100%;">
                        <canvas id="estoqueSucursalChart"></canvas>
                    </div>
                </div>

                <!-- Gráfico de Categorias -->
                <div style="background: #1f2937; border-radius: 12px; padding: 20px; border: 1px solid #4b5563;">
                    <h4 style="color: #f9fafb; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-chart-area" style="color: #8b5cf6;"></i>
                        Top 10 Categorias
                    </h4>
                    <div style="position: relative; height: 300px; width: 100%;">
                        <canvas id="categoriasChart"></canvas>
                    </div>
                </div>

                <!-- Gráfico de Tendências -->
                <div style="background: #1f2937; border-radius: 12px; padding: 20px; border: 1px solid #4b5563;">
                    <h4 style="color: #f9fafb; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-chart-line" style="color: #8b5cf6;"></i>
                        Tendências de Valor
                    </h4>
                    <div style="position: relative; height: 300px; width: 100%;">
                        <canvas id="tendenciasChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navegação -->
        <div class="nav-btns-container -responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive" role="button" role="button" role="button" role="button" role="button" role="button">
            <h3 style="color: #f9fafb; margin-bottom: 25px; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 1.3rem;">
                <i class="fas fa-compass" style="color: #8b5cf6;"></i>
                Navegação Rápida
            </h3>
            
            <div class="nav-btns-grid -responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive" role="button" role="button" role="button" role="button" role="button" role="button">
                <a href="#"stock:requisicoes:list' %}" class="nav-btn -responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive">
                    <i class="fas fa-list"></i>
                    <span>Requisições</span>
                </a>
                
                <a href="#"stock:movimentos' %}" class="nav-btn -responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive">
                    <i class="fas fa-exchange-alt"></i>
                    <span>Movimentações</span>
                </a>
                
                <a href="#"stock:notificacoes_list' %}" class="nav-btn -responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive">
                    <i class="fas fa-bell"></i>
                    <span>Notificações</span>
                </a>
                
                <a href="#"stock:alertas_gerenciar' %}" class="nav-btn -responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Alertas</span>
                </a>
                
                <a href="#"stock:relatorios' %}" class="nav-btn -responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive">
                    <i class="fas fa-chart-bar"></i>
                    <span>Relatórios</span>
                </a>
                
                <a href="#"stock:inventario:list' %}" class="nav-btn -responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive">
                    <i class="fas fa-clipboard-check"></i>
                    <span>Inventário</span>
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}

{% endblock %}
