{% extends "base_detail.html" %}
{% load static %}

{% block title %}Detalhes do Produto{% endblock %}

{% block detail_cards %}
<!-- Informações Básicas -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-box"></i>Informações Básicas
        </h5>
    </div>
    <div class="card-body">
        <div class="info-row">
            <span class="info-label">
                <i class="fas fa-hashtag"></i>Código:
            </span>
            <span class="info-value">{{ produto.codigo }}</span>
        </div>
        <div class="info-row">
            <span class="info-label">
                <i class="fas fa-tag"></i>Nome:
            </span>
            <span class="info-value">{{ produto.nome }}</span>
        </div>
        <div class="info-row">
            <span class="info-label">
                <i class="fas fa-layer-group"></i>Categoria:
            </span>
            <span class="info-value">{{ produto.categoria.nome|default:"Não definida" }}</span>
        </div>
        <div class="info-row">
            <span class="info-label">
                <i class="fas fa-cog"></i>Tipo:
            </span>
            <span class="badge {% if produto.produto_tipo == 'PRODUTO_FINAL' %}bg-success{% elif produto.produto_tipo == 'PRODUTO_COMPRADO' %}bg-info{% else %}bg-warning{% endif %}">
                {{ produto.get_produto_tipo_display|default:"Não definido" }}
            </span>
        </div>
        <div class="info-row">
            <span class="info-label">
                <i class="fas fa-ruler"></i>Unidade de Medida:
            </span>
            <span class="info-value">{{ produto.get_unidade_medida_display }}</span>
        </div>
        <div class="info-row">
            <span class="info-label">
                <i class="fas fa-toggle-on"></i>Status:
            </span>
            <span class="badge {% if produto.status == 'ATIVO' %}bg-success{% else %}bg-secondary{% endif %}">
                {{ produto.get_status_display }}
            </span>
        </div>
    </div>
</div>

<!-- Informações Comerciais -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-dollar-sign"></i>Informações Comerciais
        </h5>
    </div>
    <div class="card-body">
        <div class="info-row">
            <span class="info-label">
                <i class="fas fa-money-bill-wave"></i>Preço de Compra:
            </span>
            <span class="info-value" style="font-weight: 700; color: #dc3545;">
                {{ produto.preco_compra|floatformat:2 }} MT
            </span>
        </div>
        <div class="info-row">
            <span class="info-label">
                <i class="fas fa-tags"></i>Preço de Venda:
            </span>
            <span class="info-value" style="font-weight: 700; color: #28a745;">
                {{ produto.preco_venda|floatformat:2 }} MT
            </span>
        </div>
        <div class="info-row">
            <span class="info-label">
                <i class="fas fa-percentage"></i>Margem:
            </span>
            <span class="info-value" style="font-weight: 700; color: #17a2b8;">
                {% if produto.preco_compra and produto.preco_venda %}
                    {% widthratio produto.preco_venda produto.preco_compra 100 as margem %}
                    {{ margem|add:"-100" }}%
                {% else %}
                    N/A
                {% endif %}
            </span>
        </div>
        <div class="info-row">
            <span class="info-label">
                <i class="fas fa-barcode"></i>Código de Barras:
            </span>
            <span class="info-value">{{ produto.codigo_barras|default:"Não informado" }}</span>
        </div>
    </div>
</div>

<!-- Controle de Estoque -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-warehouse"></i>Controle de Estoque
        </h5>
    </div>
    <div class="card-body">
        <div class="info-row">
            <span class="info-label">
                <i class="fas fa-boxes"></i>Quantidade Atual:
            </span>
            <span class="info-value" style="font-weight: 700; color: #495057;">
                {% if stocks_sucursais %}
                    {% for stock in stocks_sucursais %}
                        {{ stock.quantidade_atual|default:"0" }}{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                {% else %}
                    0
                {% endif %} {{ produto.get_unidade_medida_display }}
            </span>
        </div>
        <div class="info-row">
            <span class="info-label">
                <i class="fas fa-exclamation-triangle"></i>Estoque Mínimo:
            </span>
            <span class="info-value">{{ produto.estoque_minimo|default:"0" }} {{ produto.get_unidade_medida_display }}</span>
        </div>
        <div class="info-row">
            <span class="info-label">
                <i class="fas fa-arrow-up"></i>Estoque Máximo:
            </span>
            <span class="info-value">{{ produto.estoque_maximo|default:"0" }} {{ produto.get_unidade_medida_display }}</span>
        </div>
        <div class="info-row">
            <span class="info-label">
                <i class="fas fa-calendar"></i>Data de Cadastro:
            </span>
            <span class="info-value">{{ produto.data_cadastro|date:"d/m/Y" }}</span>
        </div>
    </div>
</div>

<!-- Informações Adicionais -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-info-circle"></i>Informações Adicionais
        </h5>
    </div>
    <div class="card-body">
        <div class="info-row">
            <span class="info-label">
                <i class="fas fa-building"></i>Fornecedor Principal:
            </span>
            <span class="info-value">{{ produto.fornecedor_principal.nome|default:"Não definido" }}</span>
        </div>
        <div class="info-row">
            <span class="info-label">
                <i class="fas fa-cogs"></i>Pode ser Produzido:
            </span>
            <span class="badge {% if produto.pode_ser_produzido %}bg-success{% else %}bg-secondary{% endif %}">
                {% if produto.pode_ser_produzido %}Sim{% else %}Não{% endif %}
            </span>
        </div>
        <div class="info-row">
            <span class="info-label">
                <i class="fas fa-calendar-check"></i>Última Atualização:
            </span>
            <span class="info-value">{{ produto.data_atualizacao|date:"d/m/Y H:i" }}</span>
        </div>
        {% if produto.descricao %}
        <div class="info-row">
            <span class="info-label">
                <i class="fas fa-align-left"></i>Descrição:
            </span>
            <span class="info-value">{{ produto.descricao|truncatewords:10 }}</span>
        </div>
        {% endif %}
    </div>
</div>

<!-- Stock por Sucursal -->
{% if stocks_sucursais %}
<div class="card card-full-width">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-map-marker-alt"></i>Stock por Sucursal
        </h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th><i class="fas fa-building"></i> Sucursal</th>
                        <th><i class="fas fa-boxes"></i> Quantidade Atual</th>
                        <th><i class="fas fa-exclamation-triangle"></i> Estoque Mínimo</th>
                        <th><i class="fas fa-arrow-up"></i> Estoque Máximo</th>
                        <th><i class="fas fa-toggle-on"></i> Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stock in stocks_sucursais %}
                    <tr>
                        <td><strong>{{ stock.sucursal.nome }}</strong></td>
                        <td>{{ stock.quantidade_atual|default:"0" }} {{ produto.get_unidade_medida_display }}</td>
                        <td>{{ produto.estoque_minimo|default:"0" }} {{ produto.get_unidade_medida_display }}</td>
                        <td>{{ produto.estoque_maximo|default:"0" }} {{ produto.get_unidade_medida_display }}</td>
                        <td>
                            {% if stock.quantidade_atual <= produto.estoque_minimo %}
                                <span class="badge bg-warning">Baixo</span>
                            {% elif stock.quantidade_atual >= produto.estoque_maximo %}
                                <span class="badge bg-info">Alto</span>
                            {% else %}
                                <span class="badge bg-success">Normal</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Produção Interna -->
{% if produto.pode_ser_produzido and produto.get_receita_ativa %}
<div class="card card-full-width">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-cogs"></i>Produção Interna
        </h5>
    </div>
    <div class="card-body">
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            Este produto pode ser produzido internamente.
        </div>
        <div class="info-row">
            <span class="info-label">
                <i class="fas fa-list"></i>Receita Ativa:
            </span>
            <span class="info-value">{{ produto.get_receita_ativa.nome }}</span>
        </div>
        <div class="info-row">
            <span class="info-label">
                <i class="fas fa-dollar-sign"></i>Custo de Produção:
            </span>
            <span class="info-value" style="font-weight: 700; color: #dc3545;">
                {{ produto.get_receita_ativa.calcular_custo_total|floatformat:2 }} MT
            </span>
        </div>
    </div>
</div>
{% endif %}

<!-- Observações -->
{% if produto.observacoes %}
<div class="card card-full-width">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-sticky-note"></i>Observações
        </h5>
    </div>
    <div class="card-body">
        <div style="background: white; padding: 16px; border-radius: 8px; border-left: 4px solid #f59e0b;">
            <p style="margin: 0; font-style: italic; color: #374151;">{{ produto.observacoes }}</p>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
