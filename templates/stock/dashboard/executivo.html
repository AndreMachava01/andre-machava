{% extends 'base_admin.html' %}
{% load static %}

{% block title %}Dashboard Executivo - Sistema de Gestão{% endblock %}

{% block extra_css %}
<style>
    .dashboard-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        padding: 25px;
        color: white;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
    }
    
    .dashboard-card:hover {
        transform: translateY(-5px);
    }
    
    .dashboard-card.success {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }
    
    .dashboard-card.warning {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .dashboard-card.info {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .dashboard-card.danger {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }
    
    .chart-container {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        margin-bottom: 30px;
    }
    
    .chart-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
    }
    
    .chart-title i {
        margin-right: 10px;
        color: #3b82f6;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
    }
    
    .filter-controls {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        margin-bottom: 30px;
    }
    
    .filter-group {
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .filter-group label {
        font-weight: 600;
        color: #374151;
        margin-bottom: 0;
    }
    
    .filter-group select {
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        padding: 8px 12px;
        font-size: 0.9rem;
        transition: border-color 0.3s ease;
    }
    
    .filter-group select:focus {
        outline: none;
        border-color: #3b82f6;
    }
    
    .refresh-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 8px 16px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: transform 0.3s ease;
    }
    
    .refresh-btn:hover {
        transform: scale(1.05);
    }
    
    .loading {
        text-align: center;
        padding: 40px;
        color: #6b7280;
    }
    
    .error-message {
        background: #fef2f2;
        border: 1px solid #fecaca;
        color: #dc2626;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">
                <i class="fas fa-chart-line text-primary"></i>
                Dashboard Executivo
            </h1>
            <p class="text-muted mb-0">Visão geral do sistema de gestão de stock</p>
        </div>
        <div>
            <button class="btn btn-outline-primary" onclick="refreshDashboard()">
                <i class="fas fa-sync-alt"></i> Atualizar
            </button>
            <a href="{% url 'stock:main' %}" class="btn btn-primary">
                <i class="fas fa-arrow-left"></i> Voltar
            </a>
        </div>
    </div>

    {% if error %}
    <div class="error-message">
        <i class="fas fa-exclamation-triangle"></i>
        Erro ao carregar dashboard: {{ error }}
    </div>
    {% endif %}

    <!-- Estatísticas Principais -->
    <div class="stats-grid">
        <div class="dashboard-card success">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h3 class="h4 mb-1">{{ stats.total_produtos|default:"0" }}</h3>
                    <p class="mb-0">Produtos Ativos</p>
                </div>
                <i class="fas fa-box fa-2x opacity-75"></i>
            </div>
        </div>
        
        <div class="dashboard-card info">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h3 class="h4 mb-1">{{ stats.total_materiais|default:"0" }}</h3>
                    <p class="mb-0">Materiais Ativos</p>
                </div>
                <i class="fas fa-cogs fa-2x opacity-75"></i>
            </div>
        </div>
        
        <div class="dashboard-card warning">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h3 class="h4 mb-1">{{ stats.total_movimentos|default:"0" }}</h3>
                    <p class="mb-0">Movimentações (30d)</p>
                </div>
                <i class="fas fa-exchange-alt fa-2x opacity-75"></i>
            </div>
        </div>
        
        <div class="dashboard-card danger">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h3 class="h4 mb-1">{{ stats.estoque_baixo|default:"0" }}</h3>
                    <p class="mb-0">Estoque Baixo</p>
                </div>
                <i class="fas fa-exclamation-triangle fa-2x opacity-75"></i>
            </div>
        </div>
        
        <div class="dashboard-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h3 class="h4 mb-1">{{ stats.total_notificacoes|default:"0" }}</h3>
                    <p class="mb-0">Notificações</p>
                </div>
                <i class="fas fa-bell fa-2x opacity-75"></i>
            </div>
        </div>
        
        <div class="dashboard-card success">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h3 class="h4 mb-1">{{ stats.valor_total_estoque|floatformat:0|default:"0" }}</h3>
                    <p class="mb-0">Valor Total (MT)</p>
                </div>
                <i class="fas fa-dollar-sign fa-2x opacity-75"></i>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="filter-controls">
        <div class="filter-group">
            <label>Período:</label>
            <select id="periodoSelect" onchange="updateCharts()">
                <option value="7">Últimos 7 dias</option>
                <option value="30" selected>Últimos 30 dias</option>
                <option value="90">Últimos 90 dias</option>
            </select>
            
            <label>Tipo de Item:</label>
            <select id="tipoItemSelect" onchange="updateCharts()">
                <option value="">Todos</option>
                <option value="PRODUTO">Produtos</option>
                <option value="MATERIAL">Materiais</option>
            </select>
            
            <button class="refresh-btn" onclick="updateCharts()">
                <i class="fas fa-sync-alt"></i> Atualizar Gráficos
            </button>
        </div>
    </div>

    <!-- Gráficos -->
    <div class="charts-grid">
        <!-- Gráfico de Movimentações -->
        <div class="chart-container">
            <div class="chart-title">
                <i class="fas fa-chart-bar"></i>
                Movimentações por Dia
            </div>
            <canvas id="movimentacoesChart" width="400" height="200"></canvas>
        </div>

        <!-- Gráfico de Estoque por Sucursal -->
        <div class="chart-container">
            <div class="chart-title">
                <i class="fas fa-chart-pie"></i>
                Estoque por Sucursal
            </div>
            <canvas id="estoqueSucursalChart" width="400" height="200"></canvas>
        </div>

        <!-- Gráfico de Categorias -->
        <div class="chart-container">
            <div class="chart-title">
                <i class="fas fa-chart-area"></i>
                Top 10 Categorias
            </div>
            <canvas id="categoriasChart" width="400" height="200"></canvas>
        </div>

        <!-- Gráfico de Tendências -->
        <div class="chart-container">
            <div class="chart-title">
                <i class="fas fa-chart-line"></i>
                Tendências de Valor
            </div>
            <canvas id="tendenciasChart" width="400" height="200"></canvas>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let charts = {};

// Configuração padrão do Chart.js
Chart.defaults.font.family = "'Inter', sans-serif";
Chart.defaults.font.size = 12;
Chart.defaults.color = '#6b7280';

// Inicializar gráficos
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
});

function initializeCharts() {
    // Gráfico de Movimentações
    const movimentacoesCtx = document.getElementById('movimentacoesChart').getContext('2d');
    charts.movimentacoes = new Chart(movimentacoesCtx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: []
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Gráfico de Estoque por Sucursal
    const estoqueSucursalCtx = document.getElementById('estoqueSucursalChart').getContext('2d');
    charts.estoqueSucursal = new Chart(estoqueSucursalCtx, {
        type: 'doughnut',
        data: {
            labels: [],
            datasets: []
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                }
            }
        }
    });

    // Gráfico de Categorias
    const categoriasCtx = document.getElementById('categoriasChart').getContext('2d');
    charts.categorias = new Chart(categoriasCtx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: []
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    beginAtZero: true
                }
            }
        }
    });

    // Gráfico de Tendências
    const tendenciasCtx = document.getElementById('tendenciasChart').getContext('2d');
    charts.tendencias = new Chart(tendenciasCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: []
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Carregar dados iniciais
    updateCharts();
}

function updateCharts() {
    const periodo = document.getElementById('periodoSelect').value;
    const tipoItem = document.getElementById('tipoItemSelect').value;
    
    // Atualizar gráfico de movimentações
    fetch(`/stock/dashboard/chart-movimentacoes/?dias=${periodo}&tipo_item=${tipoItem}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Erro ao carregar movimentações:', data.error);
                return;
            }
            charts.movimentacoes.data.labels = data.labels;
            charts.movimentacoes.data.datasets = data.datasets;
            charts.movimentacoes.update();
        })
        .catch(error => console.error('Erro:', error));

    // Atualizar gráfico de estoque por sucursal
    fetch('/stock/dashboard/chart-estoque-sucursal/')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Erro ao carregar estoque sucursal:', data.error);
                return;
            }
            charts.estoqueSucursal.data.labels = data.labels;
            charts.estoqueSucursal.data.datasets = data.datasets;
            charts.estoqueSucursal.update();
        })
        .catch(error => console.error('Erro:', error));

    // Atualizar gráfico de categorias
    fetch('/stock/dashboard/chart-categorias/')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Erro ao carregar categorias:', data.error);
                return;
            }
            charts.categorias.data.labels = data.labels;
            charts.categorias.data.datasets = data.datasets;
            charts.categorias.update();
        })
        .catch(error => console.error('Erro:', error));

    // Atualizar gráfico de tendências
    fetch(`/stock/dashboard/chart-tendencias/?dias=${periodo}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Erro ao carregar tendências:', data.error);
                return;
            }
            charts.tendencias.data.labels = data.labels;
            charts.tendencias.data.datasets = data.datasets;
            charts.tendencias.update();
        })
        .catch(error => console.error('Erro:', error));
}

function refreshDashboard() {
    // Recarregar a página para atualizar estatísticas
    location.reload();
}

// Atualizar gráficos a cada 5 minutos
setInterval(updateCharts, 300000);
</script>
{% endblock %}
