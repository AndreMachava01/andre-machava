{% extends 'base_list.html' %}
{% load static %}

{% block title %}Verificar Stock Baixo{% endblock %}

{% block extra_style %}
<style>
    /* Estilos específicos do módulo - apenas gradiente no header */
    .page-header,
    .hero-section,
    .dashboard-header,
    .nav-top {
        background: var(--purple-gradient);
    }
</style>
{% endblock %}

{% block content %}
<!-- Formulário oculto para compra externa -->
<form id="compra-externa-form" method="post" action="/stock/requisicoes/compra-externa/create/" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="item_id" id="form-item-id">
    <input type="hidden" name="sucursal_id" id="form-sucursal-id">
    <input type="hidden" name="quantidade" id="form-quantidade">
    <input type="hidden" name="observacoes" id="form-observacoes">
</form>

<div class="modern-container">
    <!-- Header -->
    <div class="hero-section">
        <div class="hero-content">
            <h1 class="hero-title">
                <i class="fas fa-exclamation-triangle me-2"></i>Verificar Stock Baixo
            </h1>
            <div class="hero-actions">
                <a href="" class="btn-modern -secondary-modern">
                    <i class="fas fa-arrow-left"></i>Voltar às Requisições
                </a>
                <a href="" class="btn-modern -primary-modern">
                    <i class="fas fa-plus"></i>Nova Requisição
                </a>
            </div>
        </div>
    </div>

    <!-- Statistics Grid -->
    <div class="stats-grid">
        <div class="summary-card">
            <div class="stat-icon">
                <i class="fas fa-building"></i>
            </div>
            <div class="summary-value">{{ total_sucursais_afetadas }}</div>
            <div class="summary-card h3">Sucursais Afetadas</div>
        </div>
        <div class="summary-card">
            <div class="stat-icon">
                <i class="fas fa-boxes"></i>
            </div>
            <div class="summary-value">{{ total_itens_stock_baixo }}</div>
            <div class="summary-card h3">Itens com Stock Baixo</div>
        </div>
        <div class="summary-card">
            <div class="stat-icon">
                <i class="fas fa-dollar-sign"></i>
            </div>
            <div class="summary-value">{{ valor_total_stock_baixo|floatformat:0 }}</div>
            <div class="summary-card h3">Valor|default:0 total (MT)</div>
        </div>
    </div>

    <!-- Filters -->
    <!-- Sistema Unificado de Filtros -->
    {% include 'includes/filters_unified.html' with entity_name='stock_baixo' %}

    <!-- Content Area -->
    <div class="content-area">
        {% if sucursais_com_stock_baixo %}
            {% for sucursal_data in sucursais_com_stock_baixo.values %}
            <div class="sucursal-section">
                <div class="sucursal-header">
                    <h3 class="sucursal-title">
                        <i class="fas fa-warehouse"></i> {{ sucursal_data.sucursal.nome }}
                    </h3>
                    <div class="sucursal-stats">
                        <div class="sucursal-stat">
                            <div class="sucursal-stat-number">{{ sucursal_data.total|default:0_itens }}</div>
                            <div class="sucursal-stat-label">Itens</div>
                        </div>
                        <div class="sucursal-stat">
                            <div class="sucursal-stat-number">{{ sucursal_data.valor_total|floatformat:0 }}</div>
                            <div class="sucursal-stat-label">Valor (MT)</div>
                        </div>
                    </div>
                </div>

                <table class="table-modern">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Código</th>
                            <th>Tipo</th>
                            <th>Stock Atual</th>
                            <th>Stock Mínimo</th>
                            <th>Status</th>
                            <th>Valor Unitário</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stock_item in sucursal_data.itens %}
                        <tr>
                            <td>
                                <strong>{{ stock_item.item.nome }}</strong>
                            </td>
                            <td>{{ stock_item.item.codigo }}</td>
                            <td>
                                <span class="badge bg-info">
                                    {{ stock_item.item.get_tipo_display }}
                                </span>
                            </td>
                            <td>
                                <span class="badge bg-warning">{{ stock_item.quantidade_atual }}</span>
                            </td>
                            <td>{{ stock_item.item.estoque_minimo }}</td>
                            <td>
                                {% if stock_item.quantidade_atual == 0 %}
                                    <span class="stock-status stock-critico">Crítico</span>
                                {% else %}
                                    <span class="stock-status stock-baixo">Baixo</span>
                                {% endif %}
                            </td>
                            <td>{{ stock_item.item.preco_custo|floatformat:2 }} MT</td>
                            <td>
                                <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                    <a href="{% url 'stock:requisicoes:create' %}?sucursal_solicitante={{ sucursal_data.sucursal.id }}&item={{ stock_item.item.id }}" 
                                       class="btn-action -requisitar" title="Criar requisição e adicionar|default:0 items">
                                        <i class="fas fa-exchange-alt"></i>Interna
                                    </a>
                                    <a href="#" onclick="event.preventDefault(); criarCompraExterna({{ stock_item.item.id }}, "{{ stock_item.item.nome }}', {{ sucursal_data.sucursal.id }})" 
                                       class="btn-action" style="background: #8b5cf6; color: white;" title="Criar requisição de compra externa">
                                        <i class="fas fa-shopping-cart"></i>Externa
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <i class="fas fa-check-circle"></i>
                <h3>Nenhum|default:0 items com stock baixo</h3>
                <p>Parabéns! Todas as sucursais possuem stock adequado.</p>
                <a href="{% url 'stock:requisicoes:list' %}">Voltar às requisições</a>
            </div>
        {% endif %}
    </div>
</div>

<script>
function criarCompraExterna(itemId, itemNome, sucursalId) {
    // Criar modal para compra externa
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    `;
    
    modal.innerHTML = `
        <div style="background: #374151; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%; border: 1px solid #4b5563;">
            <h3 style="color: #d1d5db; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-shopping-cart"></i> Requisição de Compra Externa
            </h3>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; color: #9ca3af; font-size: 0.9rem; margin-bottom: 5px;">Item:</label>
                <div style="background: #4b5563; padding: 10px; border-radius: 6px; color: #e5e7eb;">
                    <strong>${itemNome}</strong>
                </div>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; color: #9ca3af; font-size: 0.9rem; margin-bottom: 5px;">Quantidade:</label>
                <input type="number" id="quantidadeCompra" min="1" value="1" 
                       style="width: 100%; background: #4b5563; border: 1px solid #6b7280; border-radius: 6px; padding: 8px; color: white;">
            </div>
            
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; color: #9ca3af; font-size: 0.9rem; margin-bottom: 5px;">Observações:</label>
                <textarea id="observacoesCompra" rows="3" 
                          style="width: 100%; background: #4b5563; border: 1px solid #6b7280; border-radius: 6px; padding: 8px; color: white; resize: vertical;"></textarea>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="fecharModal()" 
                        style="background: #6b7280; color: white; border: none; border-radius: 6px; padding: 10px 20px; cursor: pointer;">
                    Cancelar
                </button>
                <button onclick="" 
                        style="background: #8b5cf6; color: white; border: none; border-radius: 6px; padding: 10px 20px; cursor: pointer;">
                    <i class="fas fa-shopping-cart"></i> Criar Requisição
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Fechar modal ao clicar fora
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            fecharModal();
        }
    });
}

function fecharModal() {
    const modal = document.querySelector('div[style*="position: fixed"]');
    if (modal) {
        modal.remove();
    }
}

function confirmarCompraExterna(itemId, sucursalId) {
    const quantidade = document.getElementById('quantidadeCompra').value;
    const observacoes = document.getElementById('observacoesCompra').value;
    
    if (!quantidade || quantidade <= 0) {
        alert('Por favor, digite uma quantidade válida!');
        return;
    }
    
    // Usar formulário oculto
    const form = document.getElementById('compra-externa-form');
    if (!form) {
        alert('Erro: Formulário não encontrado. Recarregue a página.');
        return;
    }
    
    // Preencher campos do formulário
    document.getElementById('form-item-id').value = itemId;
    document.getElementById('form-sucursal-id').value = sucursalId;
    document.getElementById('form-quantidade').value = quantidade;
    document.getElementById('form-observacoes').value = observacoes;
    
    // Enviar formulário
    form.submit();
    fecharModal();
}

// Fechar modal com ESC
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        fecharModal();
    }
});
</script>
{% endblock %}
