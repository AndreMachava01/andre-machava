{% extends "base_admin.html" %}


{% block title %}Editar Prioridade - Operação {{ notificacao.id }}{% endblock %}

{% block extra_style %}

{% endblock %}

{% block content %}
<div class="container">
    <!-- Breadcrumb -->
    <nav class="breadcrumb-modern">
        <a href="/dashboard/">
            <i class="fas fa-home"></i>
            Dashboard
        </a>
        <i class="fas fa-chevron-right"></i>
        <a href="/stock/">
            <i class="fas fa-warehouse"></i>
            Stock
        </a>
        <i class="fas fa-chevron-right"></i>
        <a href="/stock/logistica/">
            <i class="fas fa-truck"></i>
            Logística
        </a>
        <i class="fas fa-chevron-right"></i>
        <a href="{% url "stock:logistica:operacoes_list" %}">Operações</a>
        <i class="fas fa-chevron-right"></i>
        <a href="{% url 'stock:logistica:operacao_detail' notificacao.id %}">Operação #{{ notificacao.id }}</a>
        <i class="fas fa-chevron-right"></i>
        <span>Editar Prioridade</span>
    </nav>

    <!-- Page Header -->
    
{% include "includes/header.html" with
    title="Editar Prioridade da Operação"
    subtitle="Altere a prioridade desta operação logística"
    icon="fas fa-exclamation-triangle"
%}    </div>

    <!-- Messages -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
                <i class="fas fa-{% if message.tags == 'error' %}exclamation-triangle{% elif message.tags == 'success' %}check-circle{% else %}info-circle{% endif %}"></i>
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <!-- Aviso sobre edição de prioridade -->
    {% if notificacao.status not in 'PENDENTE,ATRIBUIDA' %}
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Atenção:</strong> Esta operação já foi coletada (Status: {{ notificacao.get_status_display }}). 
            A prioridade não pode mais ser alterada pois o processo logístico já foi iniciado.
        </div>
    {% endif %}

    <!-- Informações da Operação -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-info-circle"></i>
                Informações da Operação
            </h3>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="info-item">
                        <div class="info-label">ID da Operação</div>
                        <div class="info-value">#{{ notificacao.id }}</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="info-item">
                        <div class="info-label">Tipo de Operação</div>
                        <div class="info-value">
                            <span class="badge badge-{{ notificacao.get_tipo_operacao_color }}">
                                <i class="{{ notificacao.get_tipo_operacao_icon }}"></i>
                                {{ notificacao.get_tipo_operacao_display }}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="info-item">
                        <div class="info-label">Status Atual</div>
                        <div class="info-value">
                            <span class="badge badge-{{ notificacao.get_status_color }}">
                                {{ notificacao.get_status_display }}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="info-item">
                        <div class="info-label">Prioridade Atual</div>
                        <div class="info-value">
                            <span class="badge badge-{{ notificacao.get_prioridade_color }}" id="current-priority-badge">
                                {{ notificacao.get_prioridade_display }}
                            </span>
                        </div>
                    </div>
                </div>
                {% if notificacao.data_criacao %}
                <div class="col-md-6">
                    <div class="info-item">
                        <div class="info-label">Data de Criação</div>
                        <div class="info-value">{{ notificacao.data_criacao|date:"d/m/Y H:i" }}</div>
                    </div>
                </div>
                {% endif %}
                {% if notificacao.usuario_notificacao %}
                <div class="col-md-6">
                    <div class="info-item">
                        <div class="info-label">Criado por</div>
                        <div class="info-value">{{ notificacao.usuario_notificacao.get_full_name|default:notificacao.usuario_notificacao.username }}</div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Formulário de Edição -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-edit"></i>
                Alterar Prioridade
            </h3>
        </div>
        <div class="card-body">
            {% if notificacao.status in 'PENDENTE,ATRIBUIDA' %}
                <form method="post" action="." method="post"action="."method="post"action="."method="post"action="."method="post"action="."method="post"action="."method="post">{% csrf_token %}{% csrf_token %}{% csrf_token %}{% csrf_token %}{% csrf_token %}{% csrf_token %}
                    {% csrf_token %}
                    
                    <div class="form-group">
                        <label for="prioridade" class="form-label">
                            <i class="fas fa-exclamation-triangle"></i> Nova Prioridade
                        </label>
                        <select name="prioridade" id="prioridade" class="form-control" required>
                            <option value="">Selecione uma prioridade</option>
                            {% for value, label in prioridade_choices %}
                                <option value="{{ value }}" {% if notificacao.prioridade == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle"></i> 
                            Selecione a nova prioridade para esta operação
                        </small>
                    </div>

                    <div class="form-group">
                        <label for="observacoes" class="form-label">
                            <i class="fas fa-comment-alt"></i> Observações (Opcional)
                        </label>
                        <textarea name="observacoes" id="observacoes" class="form-control" rows="3" 
                                  placeholder="Motivo da alteração de prioridade..."></textarea>
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle"></i> 
                            Explique o motivo da alteração de prioridade
                        </small>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação">
                            <i class="fas fa-save"></i> Salvar Prioridade
                        </button>
                        <a href="#"stock:logistica:operacao_detail' notificacao.id %}" class="btn btn btn btn btn btn btn-secondary btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive">
                            <i class="fas fa-times"></i> Cancelar
                        </a>
                    </div>
                </form>
            {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Prioridade Atual:</strong> {{ notificacao.get_prioridade_display }}
                    <br>
                    <small>Esta operação já foi coletada e a prioridade não pode mais ser alterada.</small>
                </div>
                <div class="form-actions">
                    <a href="#"stock:logistica:operacao_detail' notificacao.id %}" class="btn btn btn btn btn btn btn-secondary btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive">
                        <i class="fas fa-arrow-left"></i> Voltar à Operação
                    </a>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Informações Adicionais -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-info-circle"></i>
                Sobre as Prioridades
            </h3>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="d-flex align-items-center mb-3">
                        <span class="badge badge-info me-3">BAIXA</span>
                        <span class="text-muted">Operações de rotina, sem urgência</span>
                    </div>
                    <div class="d-flex align-items-center mb-3">
                        <span class="badge badge-success me-3">NORMAL</span>
                        <span class="text-muted">Operações padrão, prazo normal</span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex align-items-center mb-3">
                        <span class="badge badge-warning me-3">ALTA</span>
                        <span class="text-muted">Operações importantes, requer atenção</span>
                    </div>
                    <div class="d-flex align-items-center mb-3">
                        <span class="badge badge-danger me-3">URGENTE</span>
                        <span class="text-muted">Operações críticas, máxima prioridade</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Elementos
    const prioridadeSelect = document.getElementById('prioridade');
    const currentPriorityBadge = document.getElementById('current-priority-badge');
    
    // Mapeamento de cores
    const colorMap = {
        'BAIXA': 'info',
        'NORMAL': 'success', 
        'ALTA': 'warning',
        'URGENTE': 'danger'
    };
    
    // Função para atualizar cor da prioridade
    function updatePriorityColor() {
        const selectedValue = prioridadeSelect.value;
        
        if (selectedValue && colorMap[selectedValue]) {
            // Atualizar badge atual
            if (currentPriorityBadge) {
                currentPriorityBadge.className = `badge badge-${colorMap[selectedValue]}`;
                currentPriorityBadge.textContent = prioridadeSelect.options[prioridadeSelect.selectedIndex].text;
            }
            
            // Destacar opção selecionada
            const options = prioridadeSelect.querySelectorAll('option');
            options.forEach(option => {
                option.style.backgroundColor = '';
            });
            
            if (prioridadeSelect.selectedIndex > 0) {
                prioridadeSelect.options[prioridadeSelect.selectedIndex].style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
            }
        }
    }
    
    // Event listeners
    prioridadeSelect.addEventListener('change', updatePriorityColor);
    
    // Validação do formulário
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        const prioridade = prioridadeSelect.value;
        
        if (!prioridade) {
            e.preventDefault();
            alert('Por favor, selecione uma prioridade.');
            prioridadeSelect.focus();
            return false;
        }
        
        // Confirmar alteração
        const currentPriority = '{{ notificacao.prioridade }}';
        if (prioridade !== currentPriority) {
            const confirmMessage = `Tem certeza que deseja alterar a prioridade de "${currentPriority}" para "${prioridadeSelect.options[prioridadeSelect.selectedIndex].text}"?`;
            if (!confirm(confirmMessage)) {
                e.preventDefault();
                return false;
            }
        }
    });
    
    // Inicializar cores
    updatePriorityColor();
});
</script>
{% endblock %}
