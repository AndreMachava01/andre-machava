{% extends "base_admin.html" %}
{% load static %}

{% block title %}
    {% if beneficio %}Editar Benefício{% else %}Adicionar Benefício{% endif %}
{% endblock %}

{% block extra_style %}

{% endblock %}

{% block content %}
  <div class="alert alert-info">Os benefícios podem ter valor fixo ou percentual. Para percentual, informe a base de cálculo.</div>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags|default:'info' }}">{{ message }}</div>
    {% endfor %}
  {% endif %}

  <form method="post" class="card p-3"action="." method="post"action="."method="post"action="."method="post"action="."method="post"action="."method="post"action="."method="post">{% csrf_token %}{% csrf_token %}{% csrf_token %}{% csrf_token %}{% csrf_token %}{% csrf_token %}
    {% csrf_token %}

    <!-- Identificação -->
    <div class="mb-3">
      <h5 class="mb-3"><i class="fas fa-id-card me-2"></i>Identificação</h5>
      <div class="row g-3">
        <div class="col-md-6">
          <label for="nome" class="form-label">Nome do Benefício <span class="text-danger">*</span></label>
          <input type="text" class="form-control" id="nome" name="nome" value="{{ beneficio.nome|default:'' }}" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">Código</label>
          {% if beneficio and beneficio.codigo %}
            <div class="form-control-plaintext"><strong>{{ beneficio.codigo }}</strong></div>
            <input type="hidden" name="codigo" id="codigo" value="{{ beneficio.codigo }}">input type="hidden" name="codigo" id="codigo-2" value="">
          {% endif %}
        </div>
        <div class="col-md-3">
          <label for="tipo" class="form-label">Categoria <span class="text-danger">*</span></label>
          <select id="tipo" name="tipo" class="form-select" required>
            <option value="">Selecione…</option>
            {% for codigo, nome in tipo_choices %}
              <option value="{{ codigo }}" {% if beneficio.tipo == codigo %}selected{% endif %}>{{ nome }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>

    <!-- Configuração do Valor -->
    <div class="mb-3">
      <h5 class="mb-3"><i class="fas fa-calculator me-2"></i>Configuração do Valor</h5>
      <div class="row g-3">
        <div class="col-12">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="nao_monetario" name="is_nao_monetario" value="on" {% if beneficio.is_nao_monetario or beneficio.tipo_valor == 'NAO_MONETARIO' %}checked{% endif %}>
            <label class="form-check-label" for="nao_monetario">Benefício não monetário</label>
          </div>
        </div>
        <div class="col-md-4" id="grupo_tipo_valor">
          <label for="tipo_valor" class="form-label">Tipo de Valor <span class="text-danger">*</span></label>
          <select id="tipo_valor" name="tipo_valor" class="form-select" required>
            <option value="">Selecione…</option>
            <option value="FIXO" {% if beneficio.tipo_valor == 'FIXO' %}selected{% endif %}>Valor Fixo</option>
            <option value="PERCENTUAL" {% if beneficio.tipo_valor == 'PERCENTUAL' %}selected{% endif %}>Percentual</option>
            <option value="NAO_MONETARIO" {% if beneficio.tipo_valor == 'NAO_MONETARIO' %}selected{% endif %} hidden>Não Monetário</option>
          </select>
        </div>
        <div class="col-md-4" id="grupo_valor">
          <label for="valor" class="form-label">Valor <span class="text-danger">*</span></label>
          <input type="number" step="0.01" min="0" class="form-control" id="valor" name="valor" value="{{ beneficio.valor|default:'' }}" required>
          <div class="form-text" id="valor_help">Valor do benefício (em MT ou %)</div>
        </div>
        <div class="col-md-4" id="grupo_base">
          <label for="base_calculo" class="form-label">Base de Cálculo <span class="text-danger">*</span></label>
          <select id="base_calculo" name="base_calculo" class="form-select" required>
            <option value="">Selecione…</option>
            {% for codigo, nome in base_calculo_choices %}
              <option value="{{ codigo }}" {% if beneficio.base_calculo == codigo %}selected{% endif %}>{{ nome }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-12" id="grupo_base_outro" style="display:none;">
          <label for="base_calculo_personalizada" class="form-label">Base de Cálculo (personalizada)</label>
          <input type="text" class="form-control" id="base_calculo_personalizada" name="base_calculo_personalizada" value="{{ beneficio.base_calculo_personalizada|default:'' }}" placeholder="Ex: Comissão de Vendas">
        </div>
      </div>
    </div>

    <!-- Informações do Fornecedor (somente não monetário) -->
    <div class="mb-3" id="sec_fornecedor" style="display:none;">
      <h5 class="mb-3"><i class="fas fa-building me-2"></i>Informações do Fornecedor</h5>
      <div class="row g-3">
        <div class="col-md-6">
          <label for="fornecedor" class="form-label">Fornecedor/Prestador</label>
          <input type="text" class="form-control" id="fornecedor" name="fornecedor" value="{{ beneficio.fornecedor|default:'' }}">
        </div>
        <div class="col-md-6">
          <label for="localizacao" class="form-label">Localização</label>
          <input type="text" class="form-control" id="localizacao" name="localizacao" value="{{ beneficio.localizacao|default:'' }}">
        </div>
        <div class="col-md-4">
          <label for="horario_funcionamento" class="form-label">Horário</label>
          <input type="text" class="form-control" id="horario_funcionamento" name="horario_funcionamento" value="{{ beneficio.horario_funcionamento|default:'' }}">
        </div>
        <div class="col-md-4">
          <label for="limite_uso" class="form-label">Limite de Uso</label>
          <input type="text" class="form-control" id="limite_uso" name="limite_uso" value="{{ beneficio.limite_uso|default:'' }}">
        </div>
        <div class="col-md-4">
          <label for="documento_necessario" class="form-label">Documentos Necessários</label>
          <input type="text" class="form-control" id="documento_necessario" name="documento_necessario" value="{{ beneficio.documento_necessario|default:'' }}">
        </div>
      </div>
    </div>

    <!-- Contacto do Fornecedor (somente não monetário) -->
    <div class="mb-3" id="sec_contato" style="display:none;">
      <h5 class="mb-3"><i class="fas fa-phone me-2"></i>Contacto do Fornecedor</h5>
      <div class="row g-3">
        <div class="col-md-4">
          <label for="contato_responsavel" class="form-label">Responsável</label>
          <input type="text" class="form-control" id="contato_responsavel" name="contato_responsavel" value="{{ beneficio.contato_responsavel|default:'' }}">
        </div>
        <div class="col-md-4">
          <label for="telefone_contato" class="form-label">Telefone</label>
          <input type="tel" class="form-control" id="telefone_contato" name="telefone_contato" value="{{ beneficio.telefone_contato|default:'' }}">
        </div>
        <div class="col-md-4">
          <label for="email_contato" class="form-label">Email</label>
          <input type="email" class="form-control" id="email_contato" name="email_contato" value="{{ beneficio.email_contato|default:'' }}">
        </div>
      </div>
    </div>

    <!-- Observações e Status -->
    <div class="mb-3">
      <h5 class="mb-3"><i class="fas fa-info-circle me-2"></i>Informações Adicionais</h5>
      <div class="row g-3">
        <div class="col-12">
          <label for="observacoes" class="form-label">Observações</label>
          <textarea class="form-control" id="observacoes" name="observacoes" rows="3">{{ beneficio.observacoes|default:'' }}</textarea>
        </div>
        <div class="col-12">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="ativo" name="ativo" {% if beneficio.ativo or not beneficio %}checked{% endif %}>
            <label class="form-check-label" for="ativo">Benefício ativo</label>
          </div>
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-end gap-2">
      <a href="#"rh:beneficios_salariais' %}" class="btn btn btn btn btn btn btn-secondary btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive">Cancelar</a>
      <button type="submit" class="btn btn-primary" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação">
        <i class="fas fa-save me-1"></i>{% if beneficio %}Atualizar Benefício{% else %}Adicionar Benefício{% endif %}
      </button>
    </div>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const cbNaoMonet = document.getElementById('nao_monetario');
  const grupoTipoValor = document.getElementById('grupo_tipo_valor');
  const grupoValor = document.getElementById('grupo_valor');
  const grupoBase = document.getElementById('grupo_base');
  const valor = document.getElementById('valor');
  const valorHelp = document.getElementById('valor_help');
  const tipoValor = document.getElementById('tipo_valor');
  const base = document.getElementById('base_calculo');
  const baseOutroGroup = document.getElementById('grupo_base_outro');
  const basePers = document.getElementById('base_calculo_personalizada');
  const tipo = document.getElementById('tipo');
  const codigoPreview = document.getElementById('codigo-preview');

  function syncNaoMonetario() {
    const isNM = cbNaoMonet.checked;
    if (isNM) {
      grupoTipoValor.style.display = 'none';
      grupoValor.style.display = 'none';
      grupoBase.style.display = 'none';
      valor.required = false;
      base.required = false;
      tipoValor.required = false;
      tipoValor.value = 'NAO_MONETARIO';
      valor.value = '0';
      document.getElementById('sec_fornecedor').style.display = 'block';
      document.getElementById('sec_contato').style.display = 'block';
    } else {
      grupoTipoValor.style.display = '';
      grupoValor.style.display = '';
      grupoBase.style.display = '';
      valor.required = true;
      base.required = true;
      tipoValor.required = true;
      document.getElementById('sec_fornecedor').style.display = 'none';
      document.getElementById('sec_contato').style.display = 'none';
      valorHelp.textContent = (tipoValor.value === 'PERCENTUAL') ? 'Percentual sobre a base de cálculo (0-100)' : 'Valor do benefício (em MT)';
    }
    toggleBaseOutro();
  }

  function toggleBaseOutro() {
    if (cbNaoMonet.checked) {
      baseOutroGroup.style.display = 'none';
      basePers.required = false;
      basePers.value = '';
      return;
    }
    const isOutro = base.value === 'OUTRO';
    baseOutroGroup.style.display = isOutro ? 'block' : 'none';
    basePers.required = isOutro;
    if (!isOutro) basePers.value = '';
  }

  tipoValor.addEventListener('change', function() {
    if (this.value === 'PERCENTUAL') {
      valorHelp.textContent = 'Percentual sobre a base de cálculo (0-100)';
    } else {
      valorHelp.textContent = 'Valor do benefício (em MT)';
    }
  });

  base.addEventListener('change', toggleBaseOutro);
  cbNaoMonet.addEventListener('change', syncNaoMonetario);
  if (tipo && codigoPreview) {
    tipo.addEventListener('change', function(){
      codigoPreview.textContent = this.value ? `${this.value}XXX (será gerado automaticamente)` : 'Será gerado automaticamente';
    });
  }

  // inicializar
  syncNaoMonetario();
});
</script>
{% endblock %}
