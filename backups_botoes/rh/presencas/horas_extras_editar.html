{% extends "base_admin.html" %}
{% load static %}

{% block title %}Editar Horas Extras{% endblock %}

{% block extra_style %}

{% endblock %}

{% block content %}
<div class="form-container">
    <div class="header-section">
        <a href="#" class="back-btn -responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive">
            <i class="fas fa-arrow-left"></i>
            Voltar
        </a>
        <h1 class="header-title">
            <i class="fas fa-edit"></i>
            Editar Horas Extras
        </h1>
    </div>

    <div class="form-section">
        <h2 class="form-title">
            <i class="fas fa-clock"></i>
            Editar Horas Extras - {{ horas_extras.funcionario.nome_completo }}
        </h2>

        <form method="post" id="horasExtrasForm"action="." method="post"action="."method="post"action="."method="post"action="."method="post"action="."method="post"action="."method="post">{% csrf_token %}{% csrf_token %}{% csrf_token %}{% csrf_token %}{% csrf_token %}{% csrf_token %}
            {% csrf_token %}
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="funcionario">
                        Funcionário <span class="required">*</span>
                    </label>
                    <select name="funcionario" id="funcionario" required>
                        <option value="">Selecione o funcionário</option>
                        {% for funcionario in funcionarios %}
                        <option value="{{ funcionario.id }}" {% if funcionario.id == horas_extras.funcionario.id %}selected{% endif %}>
                            {{ funcionario.nome_completo }} - {{ funcionario.codigo_funcionario }}
                        </option>
                        {% endfor %}
                    </select>
                    <div class="help-text">Selecione o funcionário que trabalhou as horas extras</div>
                </div>

                <div class="form-group">
                    <label for="data">
                        Data <span class="required">*</span>
                    </label>
                    <input type="date" name="data" id="data" required value="{{ horas_extras.data|date:'Y-m-d' }}">
                    <div class="help-text">Data em que as horas extras foram trabalhadas</div>
                </div>
            </div>

            <!-- Campos separados para cada tipo de horas extras -->
            <div class="form-group">
                <label>
                    <i class="fas fa-sun"></i> Horas Extras Diurnas (50%)
                </label>
                <input type="number" name="horas_diurnas" id="horas_diurnas" step="0.5" min="0" max="24" placeholder="Ex: 2.0" value="{% if horas_extras.tipo == 'DI' %}{{ horas_extras.quantidade_horas }}{% else %}0{% endif %}">
                <div class="help-text">Horas trabalhadas entre 8h00 e 20h00</div>
            </div>

            <div class="form-group">
                <label>
                    <i class="fas fa-moon"></i> Horas Extras Noturnas (100%)
                </label>
                <input type="number" name="horas_noturnas" id="horas_noturnas" step="0.5" min="0" max="24" placeholder="Ex: 3.0" value="{% if horas_extras.tipo == 'NO' %}{{ horas_extras.quantidade_horas }}{% else %}0{% endif %}">
                <div class="help-text">Horas trabalhadas entre 20h00 e 8h00</div>
            </div>

            <div class="form-group">
                <label>
                    <i class="fas fa-star"></i> Horas Extras Extraordinárias (100%)
                </label>
                <input type="number" name="horas_extraordinarias" id="horas_extraordinarias" step="0.5" min="0" max="24" placeholder="Ex: 0.0" value="{% if horas_extras.tipo == 'EX' %}{{ horas_extras.quantidade_horas }}{% else %}0{% endif %}">
                <div class="help-text">Horas trabalhadas em feriados e fins de semana</div>
            </div>

            <!-- Botão para detectar automaticamente -->
            <div class="form-group">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                    <input type="checkbox" id="auto_detect" checked>
                    <label for="auto_detect" style="margin: 0; font-weight: normal; color: #666;">
                        <i class="fas fa-magic"></i> Detectar automaticamente baseado no horário
                    </label>
                    <button type="button" id="btn_detectar" class="btn btn-sm"  class="btn btn-primary btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação">button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    Atualizar Horas Extras
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Focar no primeiro campo
    document.getElementById('funcionario').focus();
    
    // Novos campos de horas por tipo
    const horasDiurnasInput = document.getElementById('horas_diurnas');
    const horasNoturnasInput = document.getElementById('horas_noturnas');
    const horasExtraordinariasInput = document.getElementById('horas_extraordinarias');
    const horaInicioInput = document.getElementById('hora_inicio');
    const horaFimInput = document.getElementById('hora_fim');
    
    // Elementos do resumo de cálculo
    const totalDiurnas = document.getElementById('total_diurnas');
    const totalNoturnas = document.getElementById('total_noturnas');
    const totalExtraordinarias = document.getElementById('total_extraordinarias');
    const valorDiurnas = document.getElementById('valor_diurnas');
    const valorNoturnas = document.getElementById('valor_noturnas');
    const valorExtraordinarias = document.getElementById('valor_extraordinarias');
    const valorTotalGeral = document.getElementById('valor_total_geral');
    const totalHorasGeral = document.getElementById('total_horas_geral');
    
    // Funcionalidade de detecção automática
    const autoDetectCheckbox = document.getElementById('auto_detect');
    const btnDetectar = document.getElementById('btn_detectar');
    const tipoJustificativa = document.getElementById('tipo_justificativa');
    const justificativaText = document.getElementById('justificativa_text');
    const tipoHelp = document.getElementById('tipo_help');
    
    // Elementos de input para detecção automática
    const funcionarioSelect = document.getElementById('funcionario');
    const dataInput = document.getElementById('data');
    
    // Validação dos campos de horas
    [horasDiurnasInput, horasNoturnasInput, horasExtraordinariasInput].forEach(input => {
        if (input) {
            input.addEventListener('input', function() {
                const value = parseFloat(this.value);
                if (value > 24) {
                    this.setCustomValidity('As horas extras não podem exceder 24 horas por dia');
                } else if (value < 0) {
                    this.setCustomValidity('As horas extras não podem ser negativas');
                } else {
                    this.setCustomValidity('');
                }
                calcularResumo();
            });
            
            // Formatação automática
            input.addEventListener('blur', function() {
                const value = parseFloat(this.value);
                if (!isNaN(value)) {
                    const rounded = Math.round(value * 2) / 2;
                    this.value = rounded;
                    calcularResumo();
                }
            });
        }
    });
    
    // Função para calcular resumo automático
    function calcularResumo() {
        if (!funcionarioSelect.value) return;
        
        const horasDiurnas = parseFloat(horasDiurnasInput.value) || 0;
        const horasNoturnas = parseFloat(horasNoturnasInput.value) || 0;
        const horasExtraordinarias = parseFloat(horasExtraordinariasInput.value) || 0;
        
        // Atualizar totais de horas|default:0 totalDiurnas.textContent = horasDiurnas.toFixed(1) + 'h';
        totalNoturnas.textContent = horasNoturnas.toFixed(1) + 'h';
        totalExtraordinarias.textContent = horasExtraordinarias.toFixed(1) + 'h';
        
        const totalHoras = horasDiurnas + horasNoturnas + horasExtraordinarias;
        totalHorasGeral.textContent = totalHoras.toFixed(1) + 'h';
        
        // Calcular valores (assumindo valor base de 726 MT para CONS001)
        const valorBase = 726; // Este valor será obtido dinamicamente
        const valorDiurno = horasDiurnas * valorBase * 0.5;
        const valorNoturno = horasNoturnas * valorBase * 1.0;
        const valorExtraordinario = horasExtraordinarias * valorBase * 1.0;
        const valorTotal = valorDiurno + valorNoturno + valorExtraordinario;
        
        // Atualizar valores
        valorDiurnas.textContent = valorDiurno.toFixed(2) + ' MT';
        valorNoturnas.textContent = valorNoturno.toFixed(2) + ' MT';
        valorExtraordinarias.textContent = valorExtraordinario.toFixed(2) + ' MT';
        valorTotalGeral.textContent = valorTotal.toFixed(2) + ' MT';
    }
    
    // Cálculo automático de horas baseado no horário
    function calcularHoras() {
        if (horaInicioInput.value && horaFimInput.value) {
            const inicio = new Date('2000-01-01T' + horaInicioInput.value);
            const fim = new Date('2000-01-01T' + horaFimInput.value);
            
            if (fim <= inicio) {
                fim.setDate(fim.getDate() + 1);
            }
            
            const diffMs = fim - inicio;
            const diffHoras = diffMs / (1000 * 60 * 60);
            
            // Detectar automaticamente as horas por período
            detectarHorasPorPeriodo(horaInicioInput.value, horaFimInput.value, diffHoras);
        }
    }
    
    // Função para detectar horas por período
    function detectarHorasPorPeriodo(horaInicio, horaFim, totalHoras) {
        const inicio = new Date('2000-01-01T' + horaInicio);
        const fim = new Date('2000-01-01T' + horaFim);
        
        // Período diurno: 8h00 - 20h00
        const diurnoInicio = new Date('2000-01-01T08:00');
        const diurnoFim = new Date('2000-01-01T20:00');
        
        // Período noturno: 20h00 - 8h00
        const noturnoInicio = new Date('2000-01-01T20:00');
        const noturnoFim = new Date('2000-01-02T08:00');
        
        let horasDiurnas = 0;
        let horasNoturnas = 0;
        
        // Calcular horas diurnas
        if (inicio < diurnoFim && fim > diurnoInicio) {
            const inicioDiurno = inicio > diurnoInicio ? inicio : diurnoInicio;
            const fimDiurno = fim < diurnoFim ? fim : diurnoFim;
            horasDiurnas = (fimDiurno - inicioDiurno) / (1000 * 60 * 60);
        }
        
        // Calcular horas noturnas
        if (inicio < noturnoFim && fim > noturnoInicio) {
            const inicioNoturno = inicio > noturnoInicio ? inicio : noturnoInicio;
            const fimNoturno = fim < noturnoFim ? fim : noturnoFim;
            horasNoturnas = (fimNoturno - inicioNoturno) / (1000 * 60 * 60);
        }
        
        // Arredondar para 0.5
        horasDiurnas = Math.round(horasDiurnas * 2) / 2;
        horasNoturnas = Math.round(horasNoturnas * 2) / 2;
        
        // Atualizar campos
        horasDiurnasInput.value = horasDiurnas;
        horasNoturnasInput.value = horasNoturnas;
        horasExtraordinariasInput.value = 0; // Por padrão, não há horas extraordinárias
        
        // Calcular resumo
        calcularResumo();
    }
    
    if (horaInicioInput && horaFimInput) {
        horaInicioInput.addEventListener('change', function() {
            if (autoDetectCheckbox.checked) {
                calcularHoras();
            }
        });
        horaFimInput.addEventListener('change', function() {
            if (autoDetectCheckbox.checked) {
                calcularHoras();
            }
        });
    }
    
    // Calcular resumo quando funcionário for selecionado
    if (funcionarioSelect) {
        funcionarioSelect.addEventListener('change', function() {
            calcularResumo();
        });
    }
    
    // Inicializar cálculo do resumo
    calcularResumo();
    
    // Função para detectar tipo automaticamente
    function detectarTipoAutomatico() {
        const funcionarioId = funcionarioSelect.value;
        const data = dataInput.value;
        const horaInicio = horaInicioInput.value;
        const horaFim = horaFimInput.value;
        
        if (!funcionarioId || !data || !horaInicio || !horaFim) {
            return;
        }
        
        // Mostrar loading
        btnDetectar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Detectando...';
        btnDetectar.disabled = true;
        
        // Fazer requisição AJAX
        fetch('{% url "rh:detectar_tipo_horas_extras" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                funcionario_id: funcionarioId,
                data: data,
                hora_inicio: horaInicio,
                hora_fim: horaFim
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Atualizar campos de horas baseado na detecção
                if (data.sugestao_misto) {
                    const detalhes = data.sugestao_misto;
                    horasDiurnasInput.value = detalhes.diurno.horas;
                    horasNoturnasInput.value = detalhes.noturno.horas;
                    horasExtraordinariasInput.value = 0;
                } else {
                    // Detecção simples baseada no tipo
                    if (data.tipo === 'DI') {
                        horasDiurnasInput.value = parseFloat(quantidadeHorasInput.value) || 0;
                        horasNoturnasInput.value = 0;
                        horasExtraordinariasInput.value = 0;
                    } else if (data.tipo === 'NO') {
                        horasDiurnasInput.value = 0;
                        horasNoturnasInput.value = parseFloat(quantidadeHorasInput.value) || 0;
                        horasExtraordinariasInput.value = 0;
                    } else if (data.tipo === 'EX') {
                        horasDiurnasInput.value = 0;
                        horasNoturnasInput.value = 0;
                        horasExtraordinariasInput.value = parseFloat(quantidadeHorasInput.value) || 0;
                    }
                }
                
                // Mostrar justificativa
                justificativaText.textContent = data.justificativa;
                tipoJustificativa.style.display = 'block';
                
                // Calcular resumo
                calcularResumo();
                
                // Atualizar texto de ajuda
                tipoHelp.textContent = 'Tipo detectado automaticamente';
                
            } else {
                alert('Erro ao detectar tipo: ' + (data.error || 'Erro desconhecido'));
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao detectar tipo automaticamente');
        })
        .finally(() => {
            // Restaurar botão
            btnDetectar.innerHTML = '<i class="fas fa-sync-alt"></i> Detectar';
            btnDetectar.disabled = false;
        });
    }
    
    // Event listeners
    btnDetectar.addEventListener('click', detectarTipoAutomatico);
    
    // Validar formulário antes do envio
    document.getElementById('horasExtrasForm').addEventListener('submit', function(e) {
        // Validação básica
        if (!funcionarioSelect.value) {
            e.preventDefault();
            alert('Por favor, selecione um funcionário.');
            funcionarioSelect.focus();
            return false;
        }
        
        if (!dataInput.value) {
            e.preventDefault();
            alert('Por favor, selecione a data.');
            dataInput.focus();
            return false;
        }
        
        if (!horaInicioInput.value) {
            e.preventDefault();
            alert('Por favor, selecione a hora de início.');
            horaInicioInput.focus();
            return false;
        }
        
        if (!horaFimInput.value) {
            e.preventDefault();
            alert('Por favor, selecione a hora de fim.');
            horaFimInput.focus();
            return false;
        }
        
        // Verificar se pelo menos um tipo de horas foi preenchido
        const horasDiurnas = parseFloat(horasDiurnasInput.value) || 0;
        const horasNoturnas = parseFloat(horasNoturnasInput.value) || 0;
        const horasExtraordinarias = parseFloat(horasExtraordinariasInput.value) || 0;
        
        if (horasDiurnas === 0 && horasNoturnas === 0 && horasExtraordinarias === 0) {
            e.preventDefault();
            alert('Por favor, preencha pelo menos um tipo de horas extras.');
            return false;
        }
        
        // Validação de|default:0 total de horas não pode exceder 24 horas
        const totalHoras = horasDiurnas + horasNoturnas + horasExtraordinarias;
        if (totalHoras > 24) {
            e.preventDefault();
            alert('O|default:0 total de horas extras não pode exceder 24 horas por dia.');
            return false;
        }
    });
});
</script>
{% endblock %}
