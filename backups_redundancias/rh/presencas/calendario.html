{% extends "base_admin.html" %}


{% block title %}Calendário de Presenças{% endblock %}

{% block extra_style %}

{% endblock %}

{% block content %}
<div class="modern-container">
    <!-- Breadcrumb Navigation -->
    <div class="breadcrumb-nav">
        <a href="{% url "rh:main" %}">
            <i class="fas fa-home"></i> RH
        </a>
        <i class="fas fa-chevron-right"></i>
        <a href="">Presenças</a>
        <i class="fas fa-chevron-right"></i>
        <span>Calendário</span>
    </div>

    <!-- Page Header -->
    
{% include "includes/header.html" with
    title="Calendário de Presenças"
    subtitle="Controle interativo de presenças e frequência dos funcionários"
    icon="fas fa-calendar-check"
%}    </div>

    <div class="calendario-container">
        <!-- Controles do Calendário -->
        <div class="calendario-controls">
            <button class="btn-nav" onclick="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação"" tabindex="0" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação"" tabindex="0" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação"" tabindex="0" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação"" tabindex="0" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação"" tabindex="0" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação"" tabindex="0">button class="btn-nav" onclick=" id="btn-proximo" class="btn btn-primary btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação"" tabindex="0">
                Próximo <i class="fas fa-chevron-right"></i>
            </button>
            <button class="btn-marcar-todos" onclick="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação"" tabindex="0" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação"" tabindex="0" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação"" tabindex="0" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação"" tabindex="0" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação"" tabindex="0" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação"" tabindex="0">button class="btn-marcar-feriados" onclick=" title="Marcar automaticamente todos os feriados do ano. Se nenhum funcionário estiver selecionado, marca para todos os funcionários visíveis." class="btn btn-primary btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação"" tabindex="0">
                 <i class="fas fa-calendar-check"></i> Marcar Feriados
             </button>
            <a href="#"rh:feriados' %}" class="btn-feriados btn-responsive -responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive" title="Gerenciar feriados">
                <i class="fas fa-calendar-alt"></i> Feriados
            </a>
        </div>

        <!-- Barra de ações em lote -->
        <div id="batchActions" class="batch-actions" style="display: none;">
            <div class="batch-actions-content">
                <div class="batch-info">
                    <i class="fas fa-check-circle"></i>
                    <span id="batchCount">0</span> campos selecionados
                </div>
                <div class="batch-btns -responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive btn-responsive" role="button" role="button" role="button" role="button" role="button">
                    <button class="batch-btn" onclick="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação"" tabindex="0" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação"" tabindex="0" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação"" tabindex="0" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação"" tabindex="0" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação"" tabindex="0" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação"" tabindex="0">button class="batch-btn" onclick="A')" class="btn btn-primary btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação"" tabindex="0">
                        <i class="fas fa-times"></i> Ausente
                    </button>
                    <button class="batch-btn" onclick="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação"" tabindex="0" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação"" tabindex="0" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação"" tabindex="0" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação"" tabindex="0" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação"" tabindex="0" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação"" tabindex="0">button class="batch-btn" onclick="F')" class="btn btn-primary btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação"" tabindex="0">
                        <i class="fas fa-clock"></i> Férias
                    </button>
                    <button class="batch-btn danger" class="btn btn-primary btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação"" tabindex="0" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação">button class="btn btn btn-success" class="btn btn-primary btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação"" tabindex="0">
                        <i class="fas fa-save"></i> Guardar Todas
                    </button>
                    <button class="btn btn btn btn btn btn btn btn-warning" class="btn btn-primary btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação"" tabindex="0" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação">button class="btn btn-primary" class="btn btn-primary btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação"" tabindex="0">
                    <i class="fas fa-save"></i> Salvar
                </button>
                <button class="btn btn btn btn btn btn btn btn-danger" onclick="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação"" tabindex="0" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação"" tabindex="0" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação"" tabindex="0" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação"" tabindex="0" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação"" tabindex="0" class="btn btn btn-primary btn-responsive btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação"" tabindex="0">button class="btn btn btn-secondary" class="btn btn-primary btn-responsive" id="btn-{{ forloop.counter|default:"1" }}" aria-label="Botão de ação" title="Clique para executar ação" title="Clique para executar ação"" tabindex="0">
                    <i class="fas fa-times"></i> Cancelar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Inicialização segura das variáveis JavaScript
let presencasData = {};
let tiposPresenca = [];
let cicloPresencas = [];
let feriadosData = {};

// Variáveis globais
let funcionarioAtual = null;
let diaAtual = null;
let mesAtual = parseInt('{{ mes }}') || new Date().getMonth() + 1;
let anoAtual = parseInt('{{ ano }}') || new Date().getFullYear();
let presencaAtual = null;

// Controle de alterações em lote
let alteracoesPendentes = new Map(); // Map para rastrear alterações não salvas
let estadoOriginal = new Map(); // Map para armazenar estado original

// Inicialização quando o DOM estiver pronto
document.addEventListener('DOMContentLoaded', function() {
    try {
        // Carregar dados das presenças
        const presencasJson = '{{ presencas_dict|escapejs|safe }}';
        console.log('=== DADOS RECEBIDOS DO SERVIDOR ===');
        console.log('Presenças JSON:', presencasJson);
        console.log('Tipo:', typeof presencasJson);
        
        if (presencasJson && presencasJson !== 'None') {
            try {
                presencasData = JSON.parse(presencasJson);
                console.log('Presenças parseadas com sucesso:', presencasData);
            } catch (error) {
                console.error('Erro ao fazer parse das presenças:', error);
                presencasData = {};
            }
        } else {
            console.log('Nenhuma presença encontrada ou dados inválidos');
            presencasData = {};
        }
        
        // Carregar tipos de presença
        const tiposJson = '{{ tipos_presenca_json|escapejs|safe }}';
        if (tiposJson && tiposJson !== 'None') {
            tiposPresenca = JSON.parse(tiposJson);
        }
        
        // Carregar dados dos feriados
        const feriadosJson = '{{ feriados_dict|escapejs|safe }}';
        console.log('=== DADOS DE FERIADOS RECEBIDOS DO SERVIDOR ===');
        console.log('Feriados JSON:', feriadosJson);
        console.log('Tipo:', typeof feriadosJson);
        
        if (feriadosJson && feriadosJson !== 'None') {
            try {
                feriadosData = JSON.parse(feriadosJson);
                console.log('✅ Feriados parseados com sucesso:', feriadosData);
                console.log('Número de feriados:', Object.keys(feriadosData).length);
            } catch (error) {
                console.error('❌ Erro ao fazer parse dos feriados:', error);
                feriadosData = {};
            }
        } else {
            console.log('❌ Nenhum feriado encontrado ou dados inválidos');
            console.log('Isso pode significar que não há feriados cadastrados para este mês/ano');
            feriadosData = {};
        }
        
        // Ordem de ciclo dos tipos de presença (mais impactantes primeiro)
        cicloPresencas = [
            { codigo: '', nome: 'Vazio', cor: '#e9ecef', classe: 'vazio', display: '' },
            { codigo: 'PR', nome: 'Presente', cor: '#28a745', classe: 'presente', display: 'PR' },
            { codigo: 'AU', nome: 'Ausente', cor: '#dc3545', classe: 'ausente', display: 'AU' },
            { codigo: 'FJ', nome: 'Falta Justificada', cor: '#ffc107', classe: 'falta-justificada', display: 'FJ' },
            { codigo: 'FE', nome: 'Férias', cor: '#6f42c1', classe: 'ferias', display: 'FE' },
            { codigo: 'FG', nome: 'Folga', cor: '#6c757d', classe: 'folga', display: 'FG' },
            { codigo: 'FD', nome: 'Feriado', cor: '#e83e8c', classe: 'feriado', display: 'FD' },
            { codigo: 'AT', nome: 'Atraso', cor: '#fd7e14', classe: 'atraso', display: 'AT' }
        ];
        
        console.log('Dados carregados:', { presencasData, tiposPresenca, cicloPresencas });
        
        // Inicializar o calendário após carregar os dados
        // Limpar seleção ao clicar fora do calendário
    document.addEventListener('click', function(event) {
        if (selecaoAtiva && !event.target.closest('.calendario-grid')) {
            limparSelecao();
        }
    });
    
    // Prevenir seleção de texto durante o arrasto
    document.addEventListener('selectstart', function(event) {
        if (selecaoAtiva) {
            event.preventDefault();
        }
    });
    
    inicializarCalendario();
    } catch (error) {
        console.error('Erro ao carregar dados do calendário:', error);
    }
});

function inicializarCalendario() {
    console.log('Calendário inicializado:', mesAtual, anoAtual);
    atualizarTituloMes();
    
    // Aguardar um pouco para garantir que o DOM esteja|default:0 totalmente carregado
    setTimeout(() => {
        console.log('=== INICIANDO CARREGAMENTO DAS PRESENÇAS ===');
        carregarPresencas();
        exibirFeriadosAutomaticamente();
        exibirFinaisSemanaAutomaticamente();
        console.log('Calendário inicializado com sucesso');
    }, 100);
}

// Função para atualizar o título do mês/ano
function atualizarTituloMes() {
    const meses = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
    const elementoMesAno = document.getElementById('mes-ano');
    if (elementoMesAno) {
        elementoMesAno.textContent = `${meses[mesAtual - 1]} ${anoAtual}`;
    }
}

// Navegar entre meses
function navegarMes(direcao) {
    const novoMes = mesAtual + direcao;
    if (novoMes < 1) {
        mesAtual = 12;
        anoAtual--;
    } else if (novoMes > 12) {
        mesAtual = 1;
        anoAtual++;
    } else {
        mesAtual = novoMes;
    }
    recarregarCalendario();
}

// Filtrar por funcionário
function filtrarFuncionario() {
    const funcionarioId = document.getElementById('funcionario').value;
    const url = new URL(window.location);
    if (funcionarioId) {
        url.searchParams.set('funcionario', funcionarioId);
    } else {
        url.searchParams.delete('funcionario');
    }
    window.location.href = url.toString();
}

// Filtrar por mês
function filtrarMes() {
    const mes = document.getElementById('mes').value;
    const url = new URL(window.location);
    url.searchParams.set('mes', mes);
    window.location.href = url.toString();
}

// Filtrar por ano
function filtrarAno() {
    const ano = document.getElementById('ano').value;
    const url = new URL(window.location);
    url.searchParams.set('ano', ano);
    window.location.href = url.toString();
}

// Recarregar calendário
function recarregarCalendario() {
    const baseUrl = window.location.pathname;
    const urlParams = new URLSearchParams(window.location.search);
    urlParams.set('mes', mesAtual);
    urlParams.set('ano', anoAtual);
    const newUrl = `${baseUrl}?${urlParams.toString()}`;
    window.location.href = newUrl;
}

// Carregar presenças no calendário
function carregarPresencas() {
    console.log('=== CARREGANDO PRESENÇAS ===');
    console.log('Dados recebidos:', presencasData);
    console.log('Número de presenças:', Object.keys(presencasData).length);
    
    Object.keys(presencasData).forEach(key => {
        const [funcionarioId, dia] = key.split('_');
        const presenca = presencasData[key];
        const indicador = document.querySelector(`[data-funcionario="${funcionarioId}"][data-dia="${dia}"]`);
        
        if (indicador && presenca) {
            const classeTipo = getClasseTipo(presenca.tipo);
            indicador.className = `presenca-indicator ${classeTipo}`;
            indicador.textContent = presenca.tipo;
            
            let tooltip = presenca.tipo_nome;
            if (presenca.observacoes) {
                tooltip += ` - ${presenca.observacoes}`;
            }
            indicador.title = tooltip;
            
            indicador.dataset.presencaId = presenca.id;
            indicador.dataset.tipoAtual = presenca.tipo;
        }
    });
    
    console.log('=== PRESENÇAS CARREGADAS COM SUCESSO ===');
}

// Exibir feriados automaticamente no calendário
function exibirFeriadosAutomaticamente() {
    console.log('=== INICIANDO EXIBIÇÃO DE FERIADOS ===');
    console.log('Dados de feriados recebidos:', feriadosData);
    console.log('Tipo dos dados:', typeof feriadosData);
    console.log('Número de feriados:', Object.keys(feriadosData).length);
    
    if (!feriadosData || Object.keys(feriadosData).length === 0) {
        console.log('❌ Nenhum feriado encontrado para o mês');
        return;
    }
    
    console.log('✅ Feriados encontrados, iniciando marcação...');
    
    Object.keys(feriadosData).forEach(feriadoKey => {
        const feriado = feriadosData[feriadoKey];
        const dia = feriadoKey.replace('feriado_', '');
        
        console.log(`📅 Processando feriado: ${feriado.nome} no dia ${dia}`);
        
        const indicadores = document.querySelectorAll(`[data-dia="${dia}"]`);
        console.log(`🔍 Encontrados ${indicadores.length} indicadores para o dia ${dia}`);
        
        indicadores.forEach(indicador => {
            const funcionarioId = indicador.getAttribute('data-funcionario');
            const chavePresenca = `${funcionarioId}_${dia}`;
            
            // SEMPRE sobrescrever com feriado, independentemente de presença existente
            indicador.className = 'presenca-indicator feriado';
            indicador.textContent = 'FD';
            indicador.title = `Feriado: ${feriado.nome}`;
            
            // Atualizar dados locais sempre
            presencasData[chavePresenca] = {
                tipo: 'FD',
                tipo_nome: 'Feriado',
                observacoes: `Feriado: ${feriado.nome}`
            };
        });
        
        // Verificar se o feriado é domingo e transferir para segunda-feira
        const dataFeriado = new Date(anoAtual, mesAtual - 1, parseInt(dia));
        const diaSemanaFeriado = dataFeriado.getDay(); // 0 = Domingo, 1 = Segunda, etc.
        
        if (diaSemanaFeriado === 0) { // Domingo
            const proximaSegunda = parseInt(dia) + 1;
            const ultimoDiaDoMes = new Date(anoAtual, mesAtual, 0).getDate();
            
            // Verificar se a próxima segunda-feira ainda está no mesmo mês
            if (proximaSegunda <= ultimoDiaDoMes) {
                console.log(`Transferindo feriado de domingo (dia ${dia}) para segunda-feira (dia ${proximaSegunda})`);
                
                const indicadoresSegunda = document.querySelectorAll(`[data-dia="${proximaSegunda}"]`);
                
                indicadoresSegunda.forEach(indicadorSegunda => {
                    const funcionarioIdSegunda = indicadorSegunda.getAttribute('data-funcionario');
                    const chavePresencaSegunda = `${funcionarioIdSegunda}_${proximaSegunda}`;
                    
                    // Marcar segunda-feira como feriado transferido
                    indicadorSegunda.className = 'presenca-indicator feriado';
                    indicadorSegunda.textContent = 'FD';
                    indicadorSegunda.title = `Feriado Transferido: ${feriado.nome} (era domingo)`;
                    
                    // Atualizar dados locais
                    presencasData[chavePresencaSegunda] = {
                        tipo: 'FD',
                        tipo_nome: 'Feriado Transferido',
                        observacoes: `Feriado Transferido: ${feriado.nome} (era domingo)`
                    };
                });
            }
        }
    });
    
    console.log('Feriados exibidos automaticamente com sucesso (sobrescrevendo presenças existentes e transferindo domingos)');
    salvarFeriadosAutomaticamente();
}

// Exibir finais de semana automaticamente no calendário
function exibirFinaisSemanaAutomaticamente() {
    console.log('Exibindo finais de semana automaticamente...');
    
    const funcionarioElement = document.getElementById('funcionario');
    if (!funcionarioElement || !funcionarioElement.value) {
        console.log('Funcionário não selecionado, não marcando finais de semana');
        return;
    }
    
    const diasTrabalho = [1, 2, 3, 4, 5]; // Segunda=1, Domingo=0, Sábado=6
    const dias = document.querySelectorAll('[data-dia]');
    let finaisSemanaMarcados = 0;
    
    dias.forEach(indicador => {
        const dia = parseInt(indicador.getAttribute('data-dia'));
        const funcionarioId = indicador.getAttribute('data-funcionario');
        const chavePresenca = `${funcionarioId}_${dia}`;
        
        const presencaExistente = presencasData[chavePresenca];
        if (presencaExistente) {
            return;
        }
        
        const data = new Date(anoAtual, mesAtual - 1, dia);
        const diaSemana = data.getDay();
        
        if (!diasTrabalho.includes(diaSemana)) {
            const nomeDia = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'][diaSemana];
            
            indicador.className = 'presenca-indicator folga';
            indicador.textContent = 'FG';
            indicador.title = `Folga - ${nomeDia}`;
            
            presencasData[chavePresenca] = {
                tipo: 'FG',
                tipo_nome: 'Folga',
                observacoes: `Folga - ${nomeDia}`
            };
            
            finaisSemanaMarcados++;
        }
    });
    
    console.log(`Dias de folga marcados automaticamente: ${finaisSemanaMarcados}`);
    salvarFinaisSemanaAutomaticamente();
}

// Salvar feriados automaticamente no banco de dados
async function salvarFeriadosAutomaticamente() {
    console.log('=== INICIANDO SALVAMENTO DE FERIADOS ===');
    console.log('Dados de feriados para salvar:', feriadosData);
    
    if (!feriadosData || Object.keys(feriadosData).length === 0) {
        console.log('❌ Nenhum feriado para salvar');
        return;
    }
    
    console.log('✅ Feriados encontrados para salvar, iniciando processo...');
    
    try {
        const funcionarioElement = document.getElementById('funcionario');
        const funcionarioId = funcionarioElement ? funcionarioElement.value : null;
        
        // Se nenhum funcionário específico estiver selecionado, marcar para todos os funcionários visíveis
        if (!funcionarioId) {
            console.log('Nenhum funcionário específico selecionado, marcando feriados para todos os funcionários visíveis...');
            
            const funcionariosVisiveis = document.querySelectorAll('.funcionario-cell');
            if (funcionariosVisiveis.length === 0) {
                console.log('Nenhum funcionário visível encontrado no calendário');
                return;
            }
            
            let funcionariosProcessados = 0;
            
            for (const funcionarioCell of funcionariosVisiveis) {
                const funcionarioRow = funcionarioCell.closest('tr');
                if (!funcionarioRow) continue;
                
                const funcionarioElement = funcionarioRow.querySelector('[data-funcionario]');
                if (!funcionarioElement) continue;
                
                const funcionarioIdAtual = funcionarioElement.getAttribute('data-funcionario');
                if (!funcionarioIdAtual) continue;
                
                try {
                    const response = await fetch('', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: JSON.stringify({
                            funcionario_id: funcionarioIdAtual,
                            mes: mesAtual,
                            ano: anoAtual,
                            sobrescrever: true
                        })
                    });
                    
                    if (response.ok) {
                        funcionariosProcessados++;
                        console.log(`Feriados salvos para funcionário ${funcionarioIdAtual}`);
                    }
                } catch (error) {
                    console.error(`Erro ao salvar feriados para funcionário ${funcionarioIdAtual}:`, error);
                }
            }
            
            console.log(`Feriados salvos automaticamente para ${funcionariosProcessados} funcionários`);
            return;
        }
        
        // Funcionário específico selecionado
        console.log('Salvando feriados automaticamente no banco de dados (sobrescrevendo presenças existentes)...');
        
        const response = await fetch('', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                funcionario_id: funcionarioId,
                mes: mesAtual,
                ano: anoAtual,
                sobrescrever: true  // Flag para indicar que deve sobrescrever presenças existentes
            })
        });
        
        if (response.ok) {
            const data = await response.json();
            console.log('Feriados salvos automaticamente (sobrescrevendo presenças):', data);
        } else {
            console.log('Erro ao salvar feriados automaticamente:', response.status);
        }
    } catch (error) {
        console.error('Erro ao salvar feriados automaticamente:', error);
    }
}

// Salvar finais de semana automaticamente no banco de dados
async function salvarFinaisSemanaAutomaticamente() {
    try {
        const funcionarioElement = document.getElementById('funcionario');
        if (!funcionarioElement || !funcionarioElement.value) {
            console.log('Funcionário não selecionado, não salvando finais de semana');
            return;
        }
        
        const funcionarioId = funcionarioElement.value;
        console.log('Salvando finais de semana automaticamente no banco de dados...');
        
        const response = await fetch('{% url "rh:marcar_finais_semana_automaticos" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                funcionario_id: funcionarioId,
                mes: mesAtual,
                ano: anoAtual
            })
        });
        
        if (response.ok) {
            const data = await response.json();
            console.log('Finais de semana salvos automaticamente:', data);
        } else {
            console.log('Erro ao salvar finais de semana automaticamente:', response.status);
        }
    } catch (error) {
        console.error('Erro ao salvar finais de semana automaticamente:', error);
    }
}

// Seleção múltipla com arrastar (como Windows Explorer)
let elementosSelecionados = new Set();
let arrastando = false;
let elementoInicial = null;
let duploCliqueDetectado = false;
let selecaoAtiva = false;

// Iniciar seleção
function iniciarSelecao(elemento, event) {
    if (event.button !== 0) return; // Apenas botão esquerdo
    
    elementoInicial = elemento;
    arrastando = false;
    duploCliqueDetectado = false;
    selecaoAtiva = true;
    
    // Se Ctrl não está pressionado, limpar seleção anterior
    if (!event.ctrlKey && !event.metaKey) {
        limparSelecao();
    }
    
    // Aguardar um pouco para distinguir clique de arrasto e duplo clique
    setTimeout(() => {
        if (elementoInicial === elemento && !arrastando && !duploCliqueDetectado) {
            // Clique normal - ciclar presença
            ciclarPresenca(elemento);
        }
    }, 300);
}

// Continuar seleção ao arrastar
function continuarSelecao(elemento) {
    if (!elementoInicial) return;
    
    arrastando = true;
    
    // Adicionar à seleção
    if (!elementosSelecionados.has(elemento)) {
        elemento.classList.add('selecionado');
        elementosSelecionados.add(elemento);
        atualizarBarraAcoes();
    }
}

// Finalizar seleção
function finalizarSelecao(elemento) {
    // Resetar após um pequeno delay
    setTimeout(() => {
        elementoInicial = null;
        arrastando = false;
        selecaoAtiva = false;
    }, 100);
}

// Selecionar elemento (Ctrl + clique ou clique normal)
function selecionarElemento(elemento, event) {
    // Se Ctrl está pressionado, adicionar à seleção
    if (event.ctrlKey || event.metaKey) {
        if (elementosSelecionados.has(elemento)) {
            elemento.classList.remove('selecionado');
            elementosSelecionados.delete(elemento);
        } else {
            elemento.classList.add('selecionado');
            elementosSelecionados.add(elemento);
        }
        atualizarBarraAcoes();
    }
    // Removido: não chamar ciclarPresenca aqui para evitar duplicação
    // O ciclarPresenca já é chamado em iniciarSelecao com timeout
}

// Limpar seleção
function limparSelecao() {
    elementosSelecionados.forEach(elemento => {
        elemento.classList.remove('selecionado');
    });
    elementosSelecionados.clear();
    selecaoAtiva = false;
    atualizarBarraAcoes();
}

// Atualizar barra de ações
function atualizarBarraAcoes() {
    const batchActions = document.getElementById('batchActions');
    const batchCount = document.getElementById('batchCount');
    
    if (elementosSelecionados.size|default:0 > 0) {
        batchCount.textContent = elementosSelecionados.size|default:0;
        batchActions.style.display = 'block';
    } else {
        batchActions.style.display = 'none';
    }
}

// Aplicar presença em lote
async function aplicarPresencaLote(tipoCodigo) {
    console.log('=== APLICAR PRESENÇA EM LOTE ===', tipoCodigo, elementosSelecionados.size|default:0);
    
    if (elementosSelecionados.size === 0) {
        alert('Nenhum campo selecionado.');
        return;
    }
    
    // Encontrar o tipo de presença
    const tipoPresencaObj = tiposPresenca.find(t => t.codigo === tipoCodigo);
    console.log('Tipo encontrado:', tipoPresencaObj);
    
    if (!tipoPresencaObj) {
        alert('Tipo de presença não encontrado.');
        return;
    }
    
    // Se for falta justificada, solicitar justificativa
    let justificativa = '';
    if (tipoCodigo === 'FJ') {
        justificativa = prompt('Digite a justificativa para a falta justificada:');
        if (justificativa === null) {
            return; // Usuário cancelou
        }
        if (justificativa.trim() === '') {
            alert('A justificativa é obrigatória para falta justificada.');
            return;
        }
    }
    
    // Confirmar ação
    const confirmacao = confirm(`Deseja aplicar "${tipoPresencaObj.nome}" para ${elementosSelecionados.size} campos selecionados?`);
    if (!confirmacao) {
        return;
    }
    
    // Mostrar loading
    const loading = document.getElementById('loading');
    loading.classList.add('show');
    
    let sucessos = 0;
    let erros = 0;
    
    // Converter Set para Array para processar
    const elementosArray = Array.from(elementosSelecionados);
    console.log('Elementos para processar:', elementosArray.length);
    
    // Processar cada elemento selecionado
    for (let i = 0; i < elementosArray.length; i++) {
        const elemento = elementosArray[i];
        console.log(`Processando elemento ${i + 1}/${elementosArray.length}:`, elemento);
        
        try {
            const funcionarioId = elemento.dataset.funcionario;
            const dia = elemento.dataset.dia;
            const mes = elemento.dataset.mes || mesAtual;
            const ano = elemento.dataset.ano || anoAtual;
            
            console.log('Dados do elemento:', { funcionarioId, dia, mes, ano });
            
            const dados = {
                funcionario_id: funcionarioId,
                dia: dia,
                mes: mes,
                ano: ano,
                tipo_presenca_id: tipoPresencaObj.id,
                observacoes: tipoCodigo === 'FJ' ? justificativa.trim() : 'Marcado em lote'
            };
            
            console.log('Dados enviados:', dados);
            
            const response = await fetch('', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(dados)
            });
            
            const resultado = await response.json();
            console.log('Resposta do servidor:', resultado);
            
            if (resultado.success) {
                // Atualizar visual
                elemento.className = `presenca-indicator ${tipoPresencaObj.classe}`;
                elemento.textContent = tipoPresencaObj.display;
                elemento.dataset.tipoAtual = tipoPresencaObj.codigo;
                
                let tooltip = tipoPresencaObj.nome;
                if (tipoCodigo === 'FJ' && justificativa) {
                    tooltip += ` - ${justificativa}`;
                } else {
                    tooltip += ' - Marcado em lote';
                }
                elemento.title = tooltip;
                
                elemento.dataset.presencaId = resultado.presenca_id;
                
                // Efeito visual
                elemento.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    elemento.style.transform = 'scale(1)';
                }, 200);
                
                // Atualizar dados locais
                const key = `${funcionarioId}_${dia}`;
                presencasData[key] = {
                    id: resultado.presenca_id,
                    tipo: tipoPresencaObj.codigo,
                    tipo_nome: tipoPresencaObj.nome,
                    tipo_cor: tipoPresencaObj.cor,
                    observacoes: tipoCodigo === 'FJ' ? justificativa.trim() : 'Marcado em lote'
                };
                
                sucessos++;
                console.log(`✅ Sucesso ${sucessos}: Campo ${funcionarioId}-${dia} marcado`);
            } else {
                erros++;
                console.error(`❌ Erro ao marcar campo:`, resultado.error);
            }
        } catch (error) {
            erros++;
            console.error(`❌ Erro ao processar campo:`, error);
        }
    }
    
    // Esconder loading
    loading.classList.remove('show');
    
    // Mostrar|default:0 resultsado
    console.log(`Resultado final: ${sucessos} sucessos, ${erros} erros`);
    if (erros === 0) {
        alert(`✅ Sucesso! ${sucessos} campos marcados como "${tipoPresencaObj.nome}"!`);
    } else {
        alert(`⚠️ ${sucessos} campos marcados com sucesso, ${erros} erros encontrados.`);
    }
    
    // Limpar seleção após aplicar
    limparSelecao();
}

// Ciclar presença com clique esquerdo
function ciclarPresenca(elemento) {
    try {
        if (!elemento || !(elemento instanceof Element)) {
            console.error('Elemento inválido na função ciclarPresenca');
            return;
        }
        
        const funcionarioId = elemento.dataset.funcionario;
        const dia = elemento.dataset.dia;
        const mes = elemento.dataset.mes || mesAtual;
        const ano = elemento.dataset.ano || anoAtual;
        const tipoAtual = elemento.dataset.tipoAtual || '';
        
        if (!funcionarioId || !dia) {
            console.error('Dados insuficientes para processar a presença');
            return;
        }
        
        const chave = `${funcionarioId}_${dia}`;
        
        if (!estadoOriginal.has(chave)) {
            estadoOriginal.set(chave, {
                tipo: tipoAtual,
                presencaId: elemento.dataset.presencaId || null,
                classe: elemento.className,
                texto: elemento.textContent,
                titulo: elemento.title
            });
        }
        
        const indiceAtual = cicloPresencas.findIndex(tipo => tipo.codigo === tipoAtual);
        const proximoIndice = (indiceAtual + 1) % cicloPresencas.length;
        const proximoTipo = cicloPresencas[proximoIndice];
        
        if (proximoTipo.codigo === 'FJ') {
            const justificativa = prompt('Digite a justificativa para a falta justificada:');
            if (justificativa === null) {
                return;
            }
            if (justificativa.trim() === '') {
                alert('A justificativa é obrigatória para falta justificada.');
                return;
            }
            
            elemento.className = `presenca-indicator ${proximoTipo.classe}`;
            elemento.textContent = proximoTipo.display;
            elemento.dataset.tipoAtual = proximoTipo.codigo;
            elemento.title = `${proximoTipo.nome} - ${justificativa}`;
            
            const tipoPresencaObj = tiposPresenca.find(t => t.codigo === proximoTipo.codigo);
            alteracoesPendentes.set(chave, {
                acao: 'salvar',
                elemento: elemento,
                dados: {
                    funcionario_id: funcionarioId,
                    dia: parseInt(dia) || 1,
                    mes: parseInt(mes) || new Date().getMonth() + 1,
                    ano: parseInt(ano) || new Date().getFullYear(),
                    tipo_presenca_id: tipoPresencaObj ? tipoPresencaObj.id : null,
                    observacoes: justificativa.trim()
                }
            });
        } else {
            elemento.className = `presenca-indicator ${proximoTipo.classe}`;
            elemento.textContent = proximoTipo.display;
            elemento.dataset.tipoAtual = proximoTipo.codigo;
            elemento.title = proximoTipo.nome;
            
            if (proximoTipo.codigo === '') {
                alteracoesPendentes.set(chave, {
                    acao: 'remover',
                    elemento: elemento,
                    dados: null
                });
            } else {
                const tipoPresencaObj = tiposPresenca.find(t => t.codigo === proximoTipo.codigo);
                alteracoesPendentes.set(chave, {
                    acao: 'salvar',
                    elemento: elemento,
                    dados: {
                        funcionario_id: funcionarioId,
                        dia: parseInt(dia) || 1,
                        mes: parseInt(mes) || new Date().getMonth() + 1,
                        ano: parseInt(ano) || new Date().getFullYear(),
                        tipo_presenca_id: tipoPresencaObj ? tipoPresencaObj.id : null,
                        observacoes: ''
                    }
                });
            }
        }
        
        mostrarBotoesAcao();
    } catch (erro) {
        console.error('Erro ao processar clique no calendário:', erro);
        alert('Ocorreu um erro ao processar sua solicitação. Por favor, tente novamente.');
    }
}

// Remover presença com botão direito
async function removerPresencaRapida(elemento, silencioso = false) {
    const presencaId = elemento.dataset.presencaId;
    
    if (!presencaId) {
        elemento.className = 'presenca-indicator vazio';
        elemento.textContent = '';
        elemento.dataset.tipoAtual = '';
        elemento.title = '';
        delete elemento.dataset.presencaId;
        return;
    }
    
    try {
        const response = await fetch('', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ presenca_id: presencaId })
        });
        
        const resultado = await response.json();
        
        if (resultado.success) {
            elemento.className = 'presenca-indicator vazio';
            elemento.textContent = '';
            elemento.dataset.tipoAtual = '';
            elemento.title = '';
            delete elemento.dataset.presencaId;
            
            const key = `${elemento.dataset.funcionario}_${elemento.dataset.dia}`;
            delete presencasData[key];
            
            if (!silencioso) {
                elemento.style.transform = 'scale(0.8)';
                setTimeout(() => {
                    elemento.style.transform = 'scale(1)';
                }, 200);
            }
        } else {
            console.error('Erro ao remover presença:', resultado.error);
        }
    } catch (error) {
        console.error('Erro ao remover presença:', error);
    }
}

// Obter classe CSS do tipo de presença
function getClasseTipo(codigo) {
    const classes = {
        'PR': 'presente',
        'AU': 'ausente',
        'FJ': 'falta-justificada',
        'FE': 'ferias',
        'FG': 'folga',
        'FD': 'feriado',
        'AT': 'atraso'
    };
    return classes[codigo] || 'vazio';
}

// Fechar modal
function fecharModal() {
    document.getElementById('modal-presenca').style.display = 'none';
}

// Salvar presença
async function salvarPresenca() {
    const tipoPresencaId = document.getElementById('modal-tipo-presenca').value;
    const horasExtras = document.getElementById('modal-horas-extras').value;
    const observacoes = document.getElementById('modal-observacoes').value;
    
    if (!tipoPresencaId) {
        alert('Por favor, selecione um tipo de presença.');
        return;
    }
    
    const dados = {
        funcionario_id: funcionarioAtual,
        dia: parseInt(diaAtual) || 1,
        mes: parseInt(mesAtual) || new Date().getMonth() + 1,
        ano: parseInt(anoAtual) || new Date().getFullYear(),
        tipo_presenca_id: tipoPresencaId,
        observacoes: observacoes
    };
    
    try {
        const response = await fetch('', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(dados)
        });
        
        const resultado = await response.json();
        
        if (resultado.success) {
            const indicador = document.querySelector(`[data-funcionario="${funcionarioAtual}"][data-dia="${diaAtual}"]`);
            const tipoPresenca = tiposPresenca.find(t => t.id == tipoPresencaId);
            
            if (indicador && tipoPresenca) {
                indicador.className = `presenca-indicator ${getClasseTipo(tipoPresenca.codigo)}`;
                indicador.title = `${tipoPresenca.nome}${horasExtras ? ' - ' + horasExtras + 'h extras' : ''}`;
                indicador.dataset.presencaId = resultado.presenca_id;
            }
            
            const key = `${funcionarioAtual}_${diaAtual}`;
            presencasData[key] = {
                id: resultado.presenca_id,
                tipo: tipoPresenca.codigo,
                tipo_nome: tipoPresenca.nome,
                tipo_cor: tipoPresenca.cor,
                observacoes: observacoes
            };
            
            fecharModal();
        } else {
            alert('Erro ao salvar presença: ' + resultado.error);
        }
    } catch (error) {
        alert('Erro ao salvar presença: ' + error.message);
    }
}

// Remover presença
async function removerPresenca() {
    if (!presencaAtual || !confirm('Tem certeza que deseja remover esta presença?')) {
        return;
    }
    
    try {
        const response = await fetch('', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ presenca_id: presencaAtual.id })
        });
        
        const resultado = await response.json();
        
        if (resultado.success) {
            const indicador = document.querySelector(`[data-funcionario="${funcionarioAtual}"][data-dia="${diaAtual}"]`);
            
            if (indicador) {
                indicador.className = 'presenca-indicator vazio';
                indicador.title = '';
                delete indicador.dataset.presencaId;
            }
            
            const key = `${funcionarioAtual}_${diaAtual}`;
            delete presencasData[key];
            
            fecharModal();
        } else {
            alert('Erro ao remover presença: ' + resultado.error);
        }
    } catch (error) {
        alert('Erro ao remover presença: ' + error.message);
    }
}

// Marcar todos os dias úteis do mês
async function marcarTodosDiasUteis() {
    if (!confirm('Tem certeza que deseja marcar todos os dias úteis do mês como Presente? Esta ação irá sobrescrever as marcações existentes.')) {
        return;
    }

    const funcionarioElement = document.getElementById('funcionario');
    if (!funcionarioElement) {
        alert('Erro: Elemento de seleção de funcionário não encontrado.');
        return;
    }
    
    const funcionarioId = funcionarioElement.value;
    
    // Se nenhum funcionário específico estiver selecionado, marcar para todos
    const marcarParaTodos = !funcionarioId;
    
    if (marcarParaTodos) {
        if (!confirm('Nenhum funcionário específico selecionado. Deseja marcar todos os dias úteis para TODOS os funcionários?\n\nIsso pode demorar alguns minutos dependendo do número de funcionários.')) {
            return;
        }
    }

    const diasUteis = [];
    const anoElement = document.getElementById('ano');
    const mesElement = document.getElementById('mes');
    
    if (!anoElement || !mesElement) {
        alert('Erro: Elementos de filtro de data não encontrados.');
        return;
    }
    
    const ano = parseInt(anoElement.value) || new Date().getFullYear();
    const mes = parseInt(mesElement.value) || new Date().getMonth() + 1;
    const ultimoDia = new Date(ano, mes, 0).getDate();
    
    for (let dia = 1; dia <= ultimoDia; dia++) {
        const data = new Date(ano, mes - 1, dia);
        const diaSemana = data.getDay();
        
        if (diaSemana >= 1 && diaSemana <= 5) {
            diasUteis.push(dia);
        }
    }

    if (diasUteis.length === 0) {
        alert('Não há dias úteis neste mês.');
        return;
    }

    const loading = document.getElementById('loading');
    loading.classList.add('show');

    let sucessos = 0;
    let erros = 0;
    let funcionariosProcessados = 0;

    if (marcarParaTodos) {
        // Marcar para todos os funcionários visíveis no calendário
        const funcionariosVisiveis = document.querySelectorAll('.funcionario-cell');
        
        for (const funcionarioCell of funcionariosVisiveis) {
            const funcionarioRow = funcionarioCell.closest('tr');
            const funcionarioIdAtual = funcionarioRow.querySelector('[data-funcionario]').getAttribute('data-funcionario');
            
            for (const dia of diasUteis) {
                try {
                    const dados = {
                        funcionario_id: funcionarioIdAtual,
                        dia: dia,
                        mes: mes,
                        ano: ano,
                        tipo_presenca_id: tiposPresenca.find(t => t.codigo === 'PR').id,
                        observacoes: 'Marcado automaticamente para todos'
                    };

                    const response = await fetch('', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify(dados)
                    });

                    const resultado = await response.json();

                    if (resultado.success) {
                        const indicador = document.querySelector(`[data-funcionario="${funcionarioIdAtual}"][data-dia="${dia}"]`);
                        if (indicador) {
                            indicador.className = 'presenca-indicator presente';
                            indicador.textContent = 'PR';
                            indicador.dataset.tipoAtual = 'PR';
                            indicador.title = 'Presente - Marcado automaticamente para todos';
                            indicador.dataset.presencaId = resultado.presenca_id;
                        }

                        const key = `${funcionarioIdAtual}_${dia}`;
                        presencasData[key] = {
                            id: resultado.presenca_id,
                            tipo: 'PR',
                            tipo_nome: 'Presente',
                            tipo_cor: '#28a745',
                            observacoes: 'Marcado automaticamente para todos'
                        };

                        sucessos++;
                    } else {
                        erros++;
                        console.error(`Erro ao marcar dia ${dia} para funcionário ${funcionarioIdAtual}:`, resultado.error);
                    }
                } catch (error) {
                    erros++;
                    console.error(`Erro ao marcar dia ${dia} para funcionário ${funcionarioIdAtual}:`, error);
                }
            }
            
            funcionariosProcessados++;
        }
    } else {
        // Marcar apenas para o funcionário específico selecionado
        for (const dia of diasUteis) {
            try {
                const dados = {
                    funcionario_id: funcionarioId,
                    dia: dia,
                    mes: mes,
                    ano: ano,
                    tipo_presenca_id: tiposPresenca.find(t => t.codigo === 'PR').id,
                    observacoes: 'Marcado automaticamente'
                };

                const response = await fetch('', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(dados)
                });

                const resultado = await response.json();

                if (resultado.success) {
                    const indicador = document.querySelector(`[data-funcionario="${funcionarioId}"][data-dia="${dia}"]`);
                    if (indicador) {
                        indicador.className = 'presenca-indicator presente';
                        indicador.textContent = 'PR';
                        indicador.dataset.tipoAtual = 'PR';
                        indicador.title = 'Presente - Marcado automaticamente';
                        indicador.dataset.presencaId = resultado.presenca_id;
                    }

                    const key = `${funcionarioId}_${dia}`;
                    presencasData[key] = {
                        id: resultado.presenca_id,
                        tipo: 'PR',
                        tipo_nome: 'Presente',
                        tipo_cor: '#28a745',
                        observacoes: 'Marcado automaticamente'
                    };

                    sucessos++;
                } else {
                    erros++;
                    console.error(`Erro ao marcar dia ${dia}:`, resultado.error);
                }
            } catch (error) {
                erros++;
                console.error(`Erro ao marcar dia ${dia}:`, error);
            }
        }
    }

    loading.classList.remove('show');

    // Mostrar|default:0 resultsado
    if (erros === 0) {
        if (marcarParaTodos) {
            alert(`✅ Todos os ${sucessos} dias úteis foram marcados como Presente para ${funcionariosProcessados} funcionários!`);
        } else {
            alert(`✅ Todos os ${sucessos} dias úteis foram marcados como Presente!`);
        }
    } else {
        if (marcarParaTodos) {
            alert(`⚠️ ${sucessos} dias marcados com sucesso para ${funcionariosProcessados} funcionários, ${erros} erros encontrados.`);
        } else {
            alert(`⚠️ ${sucessos} dias marcados com sucesso, ${erros} erros encontrados.`);
        }
    }
}

// Função para marcar feriados automaticamente
async function marcarFeriadosAutomaticos() {
    const funcionarioElement = document.getElementById('funcionario');
    const anoElement = document.getElementById('ano');
    const mesElement = document.getElementById('mes');
    
    if (!anoElement || !mesElement) {
        alert('Erro: Elementos de filtro não encontrados.');
        return;
    }
    
    const funcionarioId = funcionarioElement ? funcionarioElement.value : null;
    const ano = parseInt(anoElement.value) || new Date().getFullYear();
    const mes = parseInt(mesElement.value) || new Date().getMonth() + 1;
    
    // Se nenhum funcionário específico estiver selecionado, marcar para todos
    const marcarParaTodos = !funcionarioId;
    
    if (marcarParaTodos) {
        if (!confirm(`Tem certeza que deseja marcar automaticamente todos os feriados de ${mes}/${ano} para TODOS os funcionários?\n\nIsso pode demorar alguns minutos dependendo do número de funcionários.`)) {
            return;
        }
    } else {
        if (!confirm(`Tem certeza que deseja marcar automaticamente todos os feriados de ${mes}/${ano} para o funcionário selecionado?`)) {
            return;
        }
    }
    
    const loading = document.getElementById('loading');
    loading.classList.add('show');
    
    try {
        if (marcarParaTodos) {
            // Marcar feriados para todos os funcionários visíveis
            const funcionariosVisiveis = document.querySelectorAll('.funcionario-cell');
            if (funcionariosVisiveis.length === 0) {
                alert('Nenhum funcionário visível encontrado no calendário. Por favor, selecione um funcionário específico ou verifique se há funcionários cadastrados.');
                loading.classList.remove('show');
                return;
            }
            
            let funcionariosProcessados = 0;
            let|default:0 totalSucessos = 0;
            let|default:0 totalErros = 0;
            
            for (const funcionarioCell of funcionariosVisiveis) {
                const funcionarioRow = funcionarioCell.closest('tr');
                if (!funcionarioRow) continue;
                
                const funcionarioElement = funcionarioRow.querySelector('[data-funcionario]');
                if (!funcionarioElement) continue;
                
                const funcionarioIdAtual = funcionarioElement.getAttribute('data-funcionario');
                if (!funcionarioIdAtual) continue;
                
                try {
                    const response = await fetch('', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({
                            funcionario_id: funcionarioIdAtual,
                            ano: ano,
                            mes: mes,
                            sobrescrever: true
                        })
                    });
                    
                    const responseText = await response.text();
                    
                    if (responseText.trim().startsWith('{') || responseText.trim().startsWith('[')) {
                        try {
                            const data = JSON.parse(responseText);
                            if (data && data.success) {
                                totalSucessos += data.criadas || 0;
                                funcionariosProcessados++;
                            } else {
                                totalErros++;
                            }
                        } catch (parseError) {
                            totalErros++;
                        }
                    } else {
                        funcionariosProcessados++;
                    }
                } catch (error) {
                    totalErros++;
                    console.error(`Erro ao marcar feriados para funcionário ${funcionarioIdAtual}:`, error);
                }
            }
            
            alert(`✅ Feriados marcados para ${funcionariosProcessados} funcionários!\n\n📊 Estatísticas:\n• Funcionários processados: ${funcionariosProcessados}\n• Presenças criadas: ${totalSucessos}\n• Erros: ${totalErros}`);
            window.location.reload();
            
        } else {
            // Marcar feriados para funcionário específico
            const response = await fetch('{% url "rh:marcar_feriados_automaticos" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    funcionario_id: funcionarioId,
                    ano: ano,
                    mes: mes,
                    sobrescrever: true
                })
            });

            const responseText = await response.text();
            
            if (responseText.trim().startsWith('{') || responseText.trim().startsWith('[')) {
                try {
                    const data = JSON.parse(responseText);
                    
                    if (data && data.success) {
                        alert(`✅ Sucesso! ${data.message || 'Feriados marcados com sucesso.'}\n\n📊 Estatísticas:\n• Feriados processados: ${data.total|default:0_feriados || 0}\n• Presenças criadas: ${data.criadas || 0}\n• Presenças atualizadas: ${data.atualizadas || 0}`);
                        window.location.reload();
                    } else {
                        const errorMsg = data && data.error ? data.error : 'Resposta inválida do servidor';
                        alert(`❌ Erro: ${errorMsg}`);
                    }
                } catch (parseError) {
                    console.error('Erro ao analisar a resposta JSON:', parseError);
                    console.error('Resposta do servidor:', responseText);
                    alert('A resposta do servidor não pôde ser processada. Verifique o console para mais detalhes.');
                }
            } else {
                console.log('Resposta do servidor (texto):', responseText);
                alert(`ℹ️ ${responseText}`);
            }
        }
    } catch (error) {
        console.error('Erro na requisição:', error);
        alert('❌ Erro ao marcar feriados: ' + (error.message || 'Erro desconhecido'));
    } finally {
        loading.classList.remove('show');
    }
}

// Função para marcar todos os finais de semana do mês
async function marcarTodosFinaisSemana() {
    const funcionarioElement = document.getElementById('funcionario');
    const anoElement = document.getElementById('ano');
    const mesElement = document.getElementById('mes');
    
    if (!funcionarioElement || !anoElement || !mesElement) {
        alert('Erro: Elementos de filtro não encontrados.');
        return;
    }
    
    const funcionarioId = funcionarioElement.value;
    const ano = parseInt(anoElement.value) || new Date().getFullYear();
    const mes = parseInt(mesElement.value) || new Date().getMonth() + 1;
    
    // Exigir funcionário específico
    if (!funcionarioId) {
        alert('Por favor, selecione um funcionário primeiro.');
        return;
    }
    
    const tipoPresenca = prompt('Digite o código do tipo de presença para dias de folga:\n• HE = Horas Extras (trabalho extraordinário)\n• AU = Ausente\n• FJ = Falta Justificada\n• Outro código:', 'HE');
    
    if (!tipoPresenca) {
        return;
    }
    
    const tipoNome = tiposPresenca.find(t => t.codigo === tipoPresenca)?.nome || tipoPresenca;
    
    const funcionarioTexto = funcionarioElement.options[funcionarioElement.selectedIndex].text;
    
    if (!confirm(`Tem certeza que deseja marcar todos os dias de folga de ${mes}/${ano} como ${tipoNome} (${tipoPresenca}) para ${funcionarioTexto}?\n\nIsso sobrescreverá a marcação automática de "Folga".`)) {
        return;
    }
    
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'loading-overlay';
    loadingDiv.innerHTML = '<div class="loading-spinner"></div><div>Marcando dias de folga...</div>';
    document.body.appendChild(loadingDiv);
    
    try {
        const response = await fetch('{% url "rh:marcar_finais_semana" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                funcionario_id: funcionarioId,
                ano: ano,
                mes: mes,
                tipo_presenca: tipoPresenca
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`✅ Sucesso! ${data.sucessos} finais de semana marcados automaticamente.`);
            carregarPresencas();
        } else {
            alert(`❌ Erro: ${data.error}`);
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('❌ Erro ao marcar finais de semana: ' + error.message);
    } finally {
        document.body.removeChild(loadingDiv);
    }
}

// Obter cookie CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Função para marcar semana completa com duplo clique
async function marcarSemanaCompleta(elemento, event) {
    event.preventDefault();
    event.stopPropagation();
    
    // Marcar que foi detectado duplo clique para evitar execução do clique simples
    duploCliqueDetectado = true;
    
    // Limpar qualquer timeout pendente do clique simples
    if (elementoInicial === elemento) {
        elementoInicial = null;
    }
    
    // Reset da flag após um tempo para permitir novos cliques
    setTimeout(() => {
        duploCliqueDetectado = false;
    }, 500);
    
    const funcionarioId = elemento.dataset.funcionario;
    const diaInicial = parseInt(elemento.dataset.dia);
    const mes = parseInt(elemento.dataset.mes || mesAtual);
    const ano = parseInt(elemento.dataset.ano || anoAtual);
    const diaSemanaInicial = parseInt(elemento.dataset.diaSemana);
    
    // Calcular dias até sexta-feira (dia_semana = 4)
    let diasAMarcar = [];
    const ultimoDiaDoMes = new Date(ano, mes, 0).getDate();
    
    for (let dia = diaInicial; dia <= ultimoDiaDoMes; dia++) {
        const dataAtual = new Date(ano, mes - 1, dia);
        const diaSemana = dataAtual.getDay();
        
        // Segunda=1, Terça=2, Quarta=3, Quinta=4, Sexta=5
        // Converter: Domingo do JS (0) para o nosso sistema (6)
        const diaSemanaConvertido = diaSemana === 0 ? 6 : diaSemana - 1;
        
        diasAMarcar.push(dia);
        
        // Parar ao chegar na sexta-feira
        if (diaSemanaConvertido === 4) break;
    }
    
    if (diasAMarcar.length === 0) {
        alert('Nenhum dia para marcar.');
        return;
    }
    
    // Perguntar ao usuário qual tipo de presença marcar
    const tipoPresenca = prompt(
        'Digite o código do tipo de presença para marcar a semana:\n\n' +
        '• PR = Presente\n' +
        '• AU = Ausente\n' +
        '• FJ = Falta Justificada\n' +
        '• FE = Férias\n' +
        '• FG = Folga\n' +
        '• FD = Feriado\n' +
        '• AT = Atraso\n\n' +
        'Código:'
    );
    
    if (!tipoPresenca) return;
    
    const tipoPresencaObj = tiposPresenca.find(t => t.codigo === tipoPresenca.toUpperCase());
    if (!tipoPresencaObj) {
        alert('Código de presença inválido!');
        return;
    }
    
    // Solicitar justificativa se for Falta Justificada
    let justificativa = '';
    if (tipoPresenca.toUpperCase() === 'FJ') {
        justificativa = prompt('Digite a justificativa para a falta justificada:');
        if (justificativa === null) return;
        if (justificativa.trim() === '') {
            alert('A justificativa é obrigatória para falta justificada.');
            return;
        }
    }
    
    // Confirmar ação
    const diasTexto = diasAMarcar.length === 1 ? '1 dia' : `${diasAMarcar.length} dias`;
    if (!confirm(
        `Marcar ${diasTexto} (dias ${diasAMarcar[0]} a ${diasAMarcar[diasAMarcar.length-1]}) como "${tipoPresencaObj.nome}"?\n\n` +
        `Apenas dias vazios serão marcados.`
    )) {
        return;
    }
    
    // Mostrar loading
    const loading = document.getElementById('loading');
    loading.classList.add('show');
    
    let sucessos = 0;
    let ignorados = 0;
    let erros = 0;
    
    // Marcar cada dia
    for (const dia of diasAMarcar) {
        try {
            const indicador = document.querySelector(
                `[data-funcionario="${funcionarioId}"][data-dia="${dia}"]`
            );
            
            if (!indicador) {
                erros++;
                continue;
            }
            
            // Verificar se o dia já tem presença marcada
            const chave = `${funcionarioId}_${dia}`;
            if (presencasData[chave] || indicador.dataset.presencaId) {
                ignorados++;
                continue; // Não sobrescrever
            }
            
            const dados = {
                funcionario_id: funcionarioId,
                dia: dia,
                mes: mes,
                ano: ano,
                tipo_presenca_id: tipoPresencaObj.id,
                observacoes: tipoPresenca.toUpperCase() === 'FJ' 
                    ? justificativa.trim() 
                    : 'Marcado por semana (duplo clique)'
            };
            
            const response = await fetch('', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(dados)
            });
            
            const resultado = await response.json();
            
            if (resultado.success) {
                // Atualizar visual
                indicador.className = `presenca-indicator ${tipoPresencaObj.classe}`;
                indicador.textContent = tipoPresencaObj.display || tipoPresencaObj.codigo;
                indicador.dataset.tipoAtual = tipoPresencaObj.codigo;
                indicador.dataset.presencaId = resultado.presenca_id;
                
                let tooltip = tipoPresencaObj.nome;
                if (tipoPresenca.toUpperCase() === 'FJ' && justificativa) {
                    tooltip += ` - ${justificativa}`;
                } else {
                    tooltip += ' - Marcado por semana';
                }
                indicador.title = tooltip;
                
                // Atualizar dados locais
                presencasData[chave] = {
                    id: resultado.presenca_id,
                    tipo: tipoPresencaObj.codigo,
                    tipo_nome: tipoPresencaObj.nome,
                    tipo_cor: tipoPresencaObj.cor,
                    observacoes: dados.observacoes
                };
                
                sucessos++;
            } else {
                erros++;
                console.error(`Erro ao marcar dia ${dia}:`, resultado.error);
            }
        } catch (error) {
            erros++;
            console.error(`Erro ao processar dia ${dia}:`, error);
        }
    }
    
    // Esconder loading
    loading.classList.remove('show');
    
    // Mostrar|default:0 resultsado
    let mensagem = `✅ ${sucessos} dia(s) marcado(s) com sucesso!`;
    if (ignorados > 0) {
        mensagem += `\n⚠️ ${ignorados} dia(s) já tinham presença marcada (ignorados).`;
    }
    if (erros > 0) {
        mensagem += `\n❌ ${erros} erro(s) encontrado(s).`;
    }
    alert(mensagem);
}

// Mostrar botões de ação em lote
function mostrarBotoesAcao() {
    const batchActions = document.getElementById('batch-actions');
    const batchCount = document.getElementById('batch-count');
    
    if (alteracoesPendentes.size|default:0 > 0) {
        batchCount.textContent = alteracoesPendentes.size|default:0;
        batchActions.style.display = 'block';
    } else {
        batchActions.style.display = 'none';
    }
}

// Guardar todas as alterações pendentes
async function guardarTodasAlteracoes() {
    if (alteracoesPendentes.size === 0) {
        return;
    }
    
    const loading = document.getElementById('loading');
    loading.classList.add('show');
    
    let sucessos = 0;
    let erros = 0;
    
    try {
        for (const [chave, alteracao] of alteracoesPendentes) {
            try {
                if (alteracao.acao === 'salvar') {
                    const response = await fetch('{% url "rh:salvar_presenca_calendario" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify(alteracao.dados)
                    });
                    
                    const resultado = await response.json();
                    
                    if (resultado.success) {
                        const tipoPresencaObj = tiposPresenca.find(t => t.id == alteracao.dados.tipo_presenca_id);
                        presencasData[chave] = {
                            id: resultado.presenca_id,
                            tipo: tipoPresencaObj?.codigo || '',
                            tipo_nome: tipoPresencaObj?.nome || '',
                            tipo_cor: tipoPresencaObj?.cor || '',
                            observacoes: alteracao.dados.observacoes
                        };
                        
                        if (tipoPresencaObj?.codigo === 'FJ' && alteracao.dados.observacoes) {
                            alteracao.elemento.title = `${tipoPresencaObj.nome} - ${alteracao.dados.observacoes}`;
                        } else {
                            alteracao.elemento.title = tipoPresencaObj?.nome || '';
                        }
                        
                        alteracao.elemento.dataset.presencaId = resultado.presenca_id;
                        sucessos++;
                    } else {
                        erros++;
                        console.error('Erro ao salvar presença:', resultado.error);
                    }
                } else if (alteracao.acao === 'remover') {
                    const presencaId = alteracao.elemento.dataset.presencaId;
                    if (presencaId) {
                        const response = await fetch('{% url "rh:remover_presenca_calendario" %}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCookie('csrftoken')
                            },
                            body: JSON.stringify({ presenca_id: presencaId })
                        });
                        
                        const resultado = await response.json();
                        
                        if (resultado.success) {
                            delete presencasData[chave];
                            delete alteracao.elemento.dataset.presencaId;
                            sucessos++;
                        } else {
                            erros++;
                            console.error('Erro ao remover presença:', resultado.error);
                        }
                    } else {
                        sucessos++;
                    }
                }
            } catch (error) {
                erros++;
                console.error('Erro na operação:', error);
            }
        }
        
        alteracoesPendentes.clear();
        estadoOriginal.clear();
        mostrarBotoesAcao();
        contarPresencasAusencias();
        
        if (erros === 0) {
            alert(`✅ Todas as ${sucessos} alterações foram salvas com sucesso!`);
        } else {
            alert(`⚠️ ${sucessos} alterações salvas, ${erros} erros encontrados.`);
        }
        
    } finally {
        loading.classList.remove('show');
    }
}

// Cancelar todas as alterações pendentes
function cancelarTodasAlteracoes() {
    if (alteracoesPendentes.size === 0) {
        return;
    }
    
    if (!confirm(`Tem certeza que deseja cancelar todas as ${alteracoesPendentes.size} alterações pendentes?`)) {
        return;
    }
    
    for (const [chave, alteracao] of alteracoesPendentes) {
        const estadoOrig = estadoOriginal.get(chave);
        if (estadoOrig) {
            alteracao.elemento.className = estadoOrig.classe;
            alteracao.elemento.textContent = estadoOrig.texto;
            alteracao.elemento.dataset.tipoAtual = estadoOrig.tipo;
            alteracao.elemento.title = estadoOrig.titulo;
            
            if (estadoOrig.presencaId) {
                alteracao.elemento.dataset.presencaId = estadoOrig.presencaId;
            } else {
                delete alteracao.elemento.dataset.presencaId;
            }
        }
    }
    
    alteracoesPendentes.clear();
    estadoOriginal.clear();
    mostrarBotoesAcao();
    contarPresencasAusencias();
    
    alert('❌ Todas as alterações foram canceladas.');
}

// Função para contar presenças e ausências
function contarPresencasAusencias() {
    try {
        const elementosPresenca = document.querySelectorAll('.presenca-indicator[data-funcionario]');
        
        let|default:0 totalPresencas = 0;
        let|default:0 totalAusencias = 0;
        let|default:0 totalFeriados = 0;
        let|default:0 totalFaltas = 0;
        
        elementosPresenca.forEach(elemento => {
            const tipoPresenca = elemento.dataset.tipoAtual;
            
            if (tipoPresenca) {
                switch(tipoPresenca) {
                    case 'PR':
                        totalPresencas++;
                        break;
                    case 'AU':
                        totalAusencias++;
                        break;
                    case 'FD':
                        totalFeriados++;
                        break;
                    case 'FJ':
                        totalFaltas++;
                        break;
                }
            }
        });
        
        const contadorPresencas = document.getElementById('contador-presencas');
        const contadorAusencias = document.getElementById('contador-ausencias');
        const contadorFeriados = document.getElementById('contador-feriados');
        const contadorFaltas = document.getElementById('contador-faltas');
        
        if (contadorPresencas) contadorPresencas.textContent = totalPresencas;
        if (contadorAusencias) contadorAusencias.textContent = totalAusencias;
        if (contadorFeriados) contadorFeriados.textContent = totalFeriados;
        if (contadorFaltas) contadorFaltas.textContent = totalFaltas;
        
        console.log(`Contadores atualizados - Presenças: ${totalPresencas}, Ausências: ${totalAusencias}, Feriados: ${totalFeriados}, Faltas: ${totalFaltas}`);
        
    } catch (error) {
        console.error('Erro ao contar presenças e ausências:', error);
    }
}

// Fechar modal ao clicar fora dele
window.onclick = function(event) {
    const modal = document.getElementById('modal-presenca');
    if (event.target == modal) {
        fecharModal();
    }
}
</script>
{% endblock %}