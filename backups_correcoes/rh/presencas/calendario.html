{% extends 'base_admin.html' %}
{% load static %}

{% block title %}Calend√°rio de Presen√ßas{% endblock %}

{% block extra_style %}
<style>
    /* Estilos espec√≠ficos do m√≥dulo - apenas gradiente no header */
    .page-header,
    .hero-section,
    .dashboard-header {
        background: var(--blue-gradient);
    }
    
    /* Estilos espec√≠ficos do calend√°rio */
    .calendario-container {
        padding: 20px;
        max-width: 100%;
        overflow-x: auto;
    }
    
    .calendario-controls {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 25px;
        padding: 20px;
        background: var(--surface-medium);
        border-radius: var(--radius-xl);
        border: 1px solid var(--border-color);
    }
    
    .btn-nav {
        background: var(--gradient-primary);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: var(--radius-lg);
        cursor: pointer;
        font-weight: 600;
        transition: all var(--transition-fast);
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .btn-nav:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }
    
    .mes-ano {
        font-size: var(--text-xl);
        font-weight: var(--font-bold);
        color: var(--text-primary);
        text-align: center;
        min-width: 200px;
    }
    
    .btn-marcar-todos,
    .btn-marcar-finais,
    .btn-marcar-feriados,
    .btn-feriados {
        background: var(--gradient-success);
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: var(--radius-lg);
        cursor: pointer;
        font-weight: 600;
        transition: all var(--transition-fast);
        display: flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
        font-size: var(--text-sm);
    }
    
    .btn-marcar-finais {
        background: var(--gradient-warning);
    }
    
    .btn-marcar-feriados {
        background: var(--gradient-info);
    }
    
    .btn-feriados {
        background: var(--gradient-secondary);
    }
    
    .btn-marcar-todos:hover,
    .btn-marcar-finais:hover,
    .btn-marcar-feriados:hover,
    .btn-feriados:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
        color: white;
        text-decoration: none;
    }
    
    }
    
    .legenda-section,
    .legenda-visual-section {
        background: var(--surface-medium);
        border-radius: var(--radius-xl);
        padding: 20px;
        margin-bottom: 25px;
        border: 1px solid var(--border-color);
    }
    
    .legenda-section h3,
    .legenda-visual-section h3 {
        color: var(--text-primary);
        margin-bottom: 15px;
        font-size: var(--text-lg);
        font-weight: var(--font-semibold);
    }
    
    .legenda {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 10px;
    }
    
    .legenda-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 12px;
        background: var(--surface-light);
        border-radius: var(--radius-md);
        font-size: var(--text-sm);
    }
    
    .legenda-item i {
        color: var(--accent-primary);
        width: 16px;
        text-align: center;
    }
    
    .legenda-visual {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
    }
    
    .legenda-item-visual {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 12px;
        background: var(--surface-light);
        border-radius: var(--radius-md);
        font-size: var(--text-sm);
    }
    
    .presenca-indicator {
        width: 30px;
        height: 30px;
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: var(--text-xs);
        font-weight: var(--font-bold);
        cursor: pointer;
        transition: all var(--transition-fast);
        border: 2px solid transparent;
    }
    
    .presenca-indicator:hover {
        transform: scale(1.1);
        box-shadow: var(--shadow-md);
    }
    
    .presenca-indicator.vazio {
        background: var(--surface-light);
        border-color: var(--border-color);
        color: var(--text-tertiary);
    }
    
    .presenca-indicator.presente {
        background: var(--accent-success);
        color: white;
    }
    
    .presenca-indicator.ausente {
        background: var(--accent-danger);
        color: white;
    }
    
    .presenca-indicator.falta-justificada {
        background: var(--accent-warning);
        color: white;
    }
    
    .presenca-indicator.ferias {
        background: var(--accent-primary);
        color: white;
    }
    
    .presenca-indicator.folga {
        background: var(--accent-secondary);
        color: white;
    }
    
    .presenca-indicator.feriado {
        background: var(--accent-info);
        color: white;
    }
    
    .presenca-indicator.atraso {
        background: var(--accent-warning);
        color: white;
    }
    
    /* Estilos para sele√ß√£o m√∫ltipla */
    .presenca-indicator.selecionado {
        border: 3px solid var(--accent-primary);
        box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
        transform: scale(1.05);
    }
    
    .presenca-indicator.arrastando {
        opacity: 0.7;
        border: 2px dashed var(--accent-primary);
    }
    
    .selecao-ativa {
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
    }
    
    .batch-actions {
        background: var(--gradient-warning);
        color: white;
        padding: 15px 20px;
        border-radius: var(--radius-xl);
        margin-bottom: 25px;
        box-shadow: var(--shadow-md);
    }
    
    .batch-actions-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
    }
    
    .batch-info {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: var(--font-semibold);
    }
    
    .batch-buttons {
        display: flex;
        gap: 10px;
    }
    
    .calendario-grid {
        background: var(--surface-medium);
        border-radius: var(--radius-xl);
        padding: 20px;
        border: 1px solid var(--border-color);
        overflow-x: auto;
    }
    
    .calendario-table {
        width: 100%;
        border-collapse: collapse;
        background: var(--surface-light);
        border-radius: var(--radius-lg);
        overflow: hidden;
    }
    
    .calendario-table th {
        background: var(--accent-primary);
        color: white;
        padding: 12px 8px;
        text-align: center;
        font-weight: var(--font-semibold);
        font-size: var(--text-sm);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .calendario-table th.funcionario-cell {
        background: var(--accent-primary-dark);
        text-align: left;
        min-width: 200px;
    }
    
    .calendario-table th.fim-semana {
        background: var(--accent-secondary);
    }
    
    .calendario-table td {
        padding: 8px;
        text-align: center;
        border: 1px solid var(--border-color);
        background: var(--surface-light);
    }
    
    .calendario-table td.funcionario-cell {
        text-align: left;
        background: var(--surface-medium);
        font-weight: var(--font-semibold);
    }
    
    .calendario-table td.fim-semana {
        background: var(--surface-dark);
    }
    
    .dia-semana {
        font-size: var(--text-xs);
        opacity: 0.8;
        margin-top: 2px;
    }
    
    .loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--surface-medium);
        padding: 20px 30px;
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-lg);
        z-index: 1000;
        display: none;
        align-items: center;
        gap: 15px;
        font-weight: var(--font-semibold);
        color: var(--text-primary);
    }
    
    .loading.show {
        display: flex;
    }
    
    .loading i {
        font-size: var(--text-lg);
        color: var(--accent-primary);
    }
    
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
    }
    
    .modal-content {
        background: var(--surface-medium);
        margin: 5% auto;
        padding: 0;
        border-radius: var(--radius-xl);
        width: 90%;
        max-width: 500px;
        box-shadow: var(--shadow-lg);
    }
    
    .modal-header {
        background: var(--gradient-primary);
        color: white;
        padding: 20px;
        border-radius: var(--radius-xl) var(--radius-xl) 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal-title {
        margin: 0;
        font-size: var(--text-lg);
        font-weight: var(--font-semibold);
    }
    
    .close {
        font-size: var(--text-xl);
        font-weight: var(--font-bold);
        cursor: pointer;
        opacity: 0.8;
    }
    
    .close:hover {
        opacity: 1;
    }
    
    .modal-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        padding: 20px;
        background: var(--surface-light);
        border-radius: 0 0 var(--radius-xl) var(--radius-xl);
    }
    
    @media (max-width: 768px) {
        .calendario-controls {
            flex-direction: column;
            align-items: stretch;
        }
        
        .filtros {
            grid-template-columns: 1fr;
        }
        
        .filtro-acoes {
            flex-direction: column;
        }
        
        .legenda,
        .legenda-visual {
            grid-template-columns: 1fr;
        }
        
        .batch-actions-content {
            flex-direction: column;
            text-align: center;
        }
        
        .calendario-table {
            font-size: var(--text-xs);
        }
        
        .presenca-indicator {
            width: 25px;
            height: 25px;
            font-size: 10px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="modern-container">
    <!-- Breadcrumb Navigation -->
    <div class="breadcrumb-nav">
        <a href="{% url 'rh:main' %}">
            <i class="fas fa-home"></i> RH
        </a>
        <i class="fas fa-chevron-right"></i>
        <a href="{% url 'rh:presencas' %}">Presen√ßas</a>
        <i class="fas fa-chevron-right"></i>
        <span>Calend√°rio</span>
    </div>

    <!-- Page Header -->
    <div class="page-header">
        <div class="page-header-content">
            <div>
                <h1 class="page-title">
                    <i class="fas fa-calendar-check"></i>
                    Calend√°rio de Presen√ßas
                </h1>
                <p class="page-subtitle">
                    Controle interativo de presen√ßas e frequ√™ncia dos funcion√°rios
                </p>
            </div>
            <div class="header-actions">
                <a href="{% url 'rh:presencas' %}" class="btn btn-primary">
                    <i class="fas fa-arrow-left"></i>
                    Voltar √†s Presen√ßas
                </a>
            </div>
        </div>
    </div>

    <div class="calendario-container">
        <!-- Controles do Calend√°rio -->
        <div class="calendario-controls">
            <button class="btn-nav" onclick="navegarMes(-1)" id="btn-anterior">
                <i class="fas fa-chevron-left"></i> Anterior
            </button>
            <div class="mes-ano" id="mes-ano">{{ mes_nome|title }} {{ ano }}</div>
            <button class="btn-nav" onclick="navegarMes(1)" id="btn-proximo">
                Pr√≥ximo <i class="fas fa-chevron-right"></i>
            </button>
            <button class="btn-marcar-todos" onclick="marcarTodosDiasUteis()" title="Marcar todos os dias √∫teis do m√™s como Presente. Se nenhum funcion√°rio estiver selecionado, marca para todos os funcion√°rios vis√≠veis.">
                <i class="fas fa-calendar-check"></i> Dias √öteis
            </button>
            <a href="{% url 'rh:horas_extras' %}" class="btn-marcar-finais" title="Ver lista de horas extras registradas">
                <i class="fas fa-clock"></i> Horas Extras
            </a>
             <button class="btn-marcar-feriados" onclick="marcarFeriadosAutomaticos()" title="Marcar automaticamente todos os feriados do ano. Se nenhum funcion√°rio estiver selecionado, marca para todos os funcion√°rios vis√≠veis.">
                 <i class="fas fa-calendar-check"></i> Marcar Feriados
             </button>
            <a href="{% url 'rh:feriados' %}" class="btn-feriados" title="Gerenciar feriados">
                <i class="fas fa-calendar-alt"></i> Feriados
            </a>
        </div>

        <!-- Barra de a√ß√µes em lote -->
        <div id="batchActions" class="batch-actions" style="display: none;">
            <div class="batch-actions-content">
                <div class="batch-info">
                    <i class="fas fa-check-circle"></i>
                    <span id="batchCount">0</span> campos selecionados
                </div>
                <div class="batch-buttons">
                    <button class="batch-btn" onclick="aplicarPresencaLote('P')">
                        <i class="fas fa-check"></i> Presen√ßa
                    </button>
                    <button class="batch-btn" onclick="aplicarPresencaLote('A')">
                        <i class="fas fa-times"></i> Ausente
                    </button>
                    <button class="batch-btn" onclick="aplicarPresencaLote('FJ')">
                        <i class="fas fa-file-medical"></i> Falta Justificada
                    </button>
                    <button class="batch-btn" onclick="aplicarPresencaLote('F')">
                        <i class="fas fa-clock"></i> F√©rias
                    </button>
                    <button class="batch-btn danger" onclick="limparSelecao()">
                        <i class="fas fa-times"></i> Limpar Sele√ß√£o
                    </button>
                </div>
            </div>
        </div>

        <!-- Sistema Unificado de Filtros -->
        {% include 'includes/filters_unified.html' with entity_name='calendario_presencas' %}

        <!-- Instru√ß√µes de Uso -->
        <div class="legenda-section">
            <h3>
                <i class="fas fa-info-circle"></i>
                Como Usar
            </h3>
            <div class="legenda">
                <div class="legenda-item">
                    <i class="fas fa-mouse-pointer"></i>
                    <span><strong>Clique normal:</strong> Marcar presen√ßa (cicla entre tipos)</span>
                </div>
                <div class="legenda-item">
                    <i class="fas fa-hand-paper"></i>
                    <span><strong>Arrastar:</strong> Selecionar m√∫ltiplos campos arrastando o mouse</span>
                </div>
                <div class="legenda-item">
                    <i class="fas fa-keyboard"></i>
                    <span><strong>Ctrl + Clique:</strong> Adicionar/remover campos individuais da sele√ß√£o</span>
                </div>
                <div class="legenda-item">
                    <i class="fas fa-hand-point-up"></i>
                    <span><strong>Clique direito:</strong> Remover marca√ß√£o</span>
                </div>
                <div class="legenda-item">
                    <i class="fas fa-save"></i>
                    <span><strong>Guardar Todas:</strong> Salva todas as altera√ß√µes pendentes na base de dados</span>
                </div>
                <div class="legenda-item">
                    <i class="fas fa-undo"></i>
                    <span><strong>Cancelar Todas:</strong> Desfaz todas as altera√ß√µes pendentes</span>
                </div>
                <div class="legenda-item">
                    <i class="fas fa-info-circle"></i>
                    <span><strong>Ordem do ciclo:</strong> Vazio ‚Üí PR (Presente) ‚Üí AU (Ausente) ‚Üí FJ (Falta Justificada) ‚Üí FE (F√©rias) ‚Üí FG (Folga) ‚Üí FD (Feriado) ‚Üí AT (Atraso)</span>
                </div>
                <div class="legenda-item">
                    <i class="fas fa-calendar-week"></i>
                    <span><strong>Duplo clique:</strong> Marca do dia clicado at√© sexta-feira da mesma semana. O sistema pergunta qual tipo de presen√ßa marcar e respeita dias j√° marcados.</span>
                </div>
                <div class="legenda-item">
                    <i class="fas fa-lightbulb"></i>
                    <span><strong>Exemplo pr√°tico:</strong> Funcion√°rio est√° vazio na segunda ‚Üí duplo clique ‚Üí marca Presente de segunda a sexta. Na quarta est√° Presente ‚Üí duplo clique ‚Üí marca Ausente de quarta a sexta.</span>
                </div>
                <div class="legenda-item">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span><strong>Falta Justificada:</strong> √â obrigat√≥rio informar a justificativa antes de salvar</span>
                </div>
                <div class="legenda-item">
                    <i class="fas fa-calendar-check"></i>
                    <span><strong>Dias √öteis:</strong> Marca automaticamente todos os dias √∫teis do m√™s como Presente. Se nenhum funcion√°rio estiver selecionado, marca para todos os funcion√°rios vis√≠veis</span>
                </div>
                <div class="legenda-item">
                    <i class="fas fa-calendar-times"></i>
                    <span><strong>Finais de Semana:</strong> Marca automaticamente todos os finais de semana do m√™s</span>
                </div>
                 <div class="legenda-item">
                     <i class="fas fa-calendar-check"></i>
                     <span><strong>Marcar Feriados:</strong> Marca automaticamente todos os feriados do ano para todos os funcion√°rios. Os feriados SEMPRE sobrescrevem qualquer tipo de presen√ßa existente. Feriados em domingo s√£o automaticamente transferidos para segunda-feira.</span>
                 </div>
                <div class="legenda-item">
                    <i class="fas fa-calendar-alt"></i>
                    <span><strong>Feriados:</strong> Gerencia feriados nacionais, regionais e da empresa</span>
                </div>
            </div>
        </div>

        <!-- Legenda Visual -->
        <div class="legenda-visual-section">
            <h3>
                <i class="fas fa-palette"></i>
                Legenda de Cores e C√≥digos
            </h3>
            <div class="legenda-visual">
                <div class="legenda-item-visual">
                    <div class="presenca-indicator vazio" style="margin: 0;"></div>
                    <span>Vazio</span>
                </div>
                <div class="legenda-item-visual">
                    <div class="presenca-indicator presente" style="margin: 0;">PR</div>
                    <span>Presente</span>
                </div>
                <div class="legenda-item-visual">
                    <div class="presenca-indicator ausente" style="margin: 0;">AU</div>
                    <span>Ausente</span>
                </div>
                <div class="legenda-item-visual">
                    <div class="presenca-indicator falta-justificada" style="margin: 0;">FJ</div>
                    <span>Falta Justificada</span>
                </div>
                <div class="legenda-item-visual">
                    <div class="presenca-indicator ferias" style="margin: 0;">FE</div>
                    <span>F√©rias</span>
                </div>
                <div class="legenda-item-visual">
                    <div class="presenca-indicator feriado" style="margin: 0;">FD</div>
                    <span>Feriado</span>
                </div>
                <div class="legenda-item-visual">
                    <div class="presenca-indicator atraso" style="margin: 0;">AT</div>
                    <span>Atraso</span>
                </div>
            </div>
        </div>

        <!-- Bot√µes de A√ß√£o em Lote -->
        <div class="batch-actions" id="batch-actions" style="display: none;">
            <div class="batch-actions-content">
                <div class="batch-info">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Voc√™ tem <strong id="batch-count">0</strong> altera√ß√µes pendentes</span>
                </div>
                <div class="batch-buttons">
                    <button class="btn btn-success" onclick="guardarTodasAlteracoes()">
                        <i class="fas fa-save"></i> Guardar Todas
                    </button>
                    <button class="btn btn-warning" onclick="cancelarTodasAlteracoes()">
                        <i class="fas fa-undo"></i> Cancelar Todas
                    </button>
                </div>
            </div>
        </div>

        <div class="loading" id="loading">
            <i class="fas fa-spinner fa-spin"></i> Carregando...
        </div>

        <!-- Grid do Calend√°rio -->
        <div class="calendario-grid" id="calendario-grid">
            <table class="calendario-table">
                <thead>
                    <tr>
                        <th class="funcionario-cell">Funcion√°rio</th>
                        {% for dia in dias_detalhados %}
                        <th class="{% if dia.e_fim_semana %}fim-semana{% endif %}">
                            <div>{{ dia.dia }}</div>
                            <div class="dia-semana">
                                {% if dia.dia_semana == 0 %}Seg
                                {% elif dia.dia_semana == 1 %}Ter
                                {% elif dia.dia_semana == 2 %}Qua
                                {% elif dia.dia_semana == 3 %}Qui
                                {% elif dia.dia_semana == 4 %}Sex
                                {% elif dia.dia_semana == 5 %}S√°b
                                {% elif dia.dia_semana == 6 %}Dom
                                {% endif %}
                            </div>
                        </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for funcionario in funcionarios_exibir %}
                    <tr>
                        <td class="funcionario-cell">
                            <strong>{{ funcionario.nome_completo }}</strong>
                            <br><small style="color: #6c757d;">{{ funcionario.codigo_funcionario }}</small>
                        </td>
                        {% for dia in dias_detalhados %}
                        <td class="dia-cell {% if dia.e_fim_semana %}fim-semana{% endif %}">
                            <div class="presenca-indicator vazio" 
                                 data-funcionario="{{ funcionario.id }}" 
                                 data-dia="{{ dia.dia }}"
                                 data-mes="{{ mes }}"
                                 data-ano="{{ ano }}"
                                 data-data="{{ ano }}-{{ mes|stringformat:'02d' }}-{{ dia.dia|stringformat:'02d' }}"
                                 data-dia-semana="{{ dia.dia_semana }}"
                                 onmousedown="iniciarSelecao(this, event)"
                                 onmouseenter="continuarSelecao(this)"
                                 onmouseup="finalizarSelecao(this)"
                                 onclick="selecionarElemento(this, event)"
                                 ondblclick="marcarSemanaCompleta(this, event)"
                                 oncontextmenu="event.preventDefault(); removerPresencaRapida(this);">
                            </div>
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal para marcar presen√ßa -->
<div id="modal-presenca" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Marcar Presen√ßa</h3>
            <span class="close" onclick="fecharModal()">√ó</span>
        </div>
        <div id="modal-body" style="padding: 20px;">
            <div class="form-group">
                <label>Funcion√°rio:</label>
                <input type="text" id="modal-funcionario" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
            </div>
            <div class="form-group">
                <label>Data:</label>
                <input type="text" id="modal-data" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
            </div>
            <div class="form-group">
                <label>Tipo de Presen√ßa:</label>
                <select id="modal-tipo-presenca" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                    <option value="">Selecione um tipo</option>
                    {% for tipo in tipos_presenca %}
                    <option value="{{ tipo.id }}" data-cor="{{ tipo.cor }}">{{ tipo.nome }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>Horas Extras (opcional):</label>
                <input type="number" id="modal-horas-extras" step="0.5" min="0" max="24" placeholder="Ex: 2.5" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
            </div>
            <div class="form-group">
                <label>Observa√ß√µes:</label>
                <textarea id="modal-observacoes" placeholder="Observa√ß√µes sobre a presen√ßa..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; resize: vertical; min-height: 60px;"></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="salvarPresenca()" style="background: #79aec8; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                    <i class="fas fa-save"></i> Salvar
                </button>
                <button class="btn btn-danger" onclick="removerPresenca()" id="btn-remover" style="display: none; background: #ba2121; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                    <i class="fas fa-trash"></i> Remover
                </button>
                <button class="btn btn-secondary" onclick="fecharModal()" style="background: #6c757d; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                    <i class="fas fa-times"></i> Cancelar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Inicializa√ß√£o segura das vari√°veis JavaScript
let presencasData = {};
let tiposPresenca = [];
let cicloPresencas = [];
let feriadosData = {};

// Vari√°veis globais
let funcionarioAtual = null;
let diaAtual = null;
let mesAtual = parseInt('{{ mes }}') || new Date().getMonth() + 1;
let anoAtual = parseInt('{{ ano }}') || new Date().getFullYear();
let presencaAtual = null;

// Controle de altera√ß√µes em lote
let alteracoesPendentes = new Map(); // Map para rastrear altera√ß√µes n√£o salvas
let estadoOriginal = new Map(); // Map para armazenar estado original

// Inicializa√ß√£o quando o DOM estiver pronto
document.addEventListener('DOMContentLoaded', function() {
    try {
        // Carregar dados das presen√ßas
        const presencasJson = '{{ presencas_dict|escapejs|safe }}';
        console.log('=== DADOS RECEBIDOS DO SERVIDOR ===');
        console.log('Presen√ßas JSON:', presencasJson);
        console.log('Tipo:', typeof presencasJson);
        
        if (presencasJson && presencasJson !== 'None') {
            try {
                presencasData = JSON.parse(presencasJson);
                console.log('Presen√ßas parseadas com sucesso:', presencasData);
            } catch (error) {
                console.error('Erro ao fazer parse das presen√ßas:', error);
                presencasData = {};
            }
        } else {
            console.log('Nenhuma presen√ßa encontrada ou dados inv√°lidos');
            presencasData = {};
        }
        
        // Carregar tipos de presen√ßa
        const tiposJson = '{{ tipos_presenca_json|escapejs|safe }}';
        if (tiposJson && tiposJson !== 'None') {
            tiposPresenca = JSON.parse(tiposJson);
        }
        
        // Carregar dados dos feriados
        const feriadosJson = '{{ feriados_dict|escapejs|safe }}';
        console.log('=== DADOS DE FERIADOS RECEBIDOS DO SERVIDOR ===');
        console.log('Feriados JSON:', feriadosJson);
        console.log('Tipo:', typeof feriadosJson);
        
        if (feriadosJson && feriadosJson !== 'None') {
            try {
                feriadosData = JSON.parse(feriadosJson);
                console.log('‚úÖ Feriados parseados com sucesso:', feriadosData);
                console.log('N√∫mero de feriados:', Object.keys(feriadosData).length);
            } catch (error) {
                console.error('‚ùå Erro ao fazer parse dos feriados:', error);
                feriadosData = {};
            }
        } else {
            console.log('‚ùå Nenhum feriado encontrado ou dados inv√°lidos');
            console.log('Isso pode significar que n√£o h√° feriados cadastrados para este m√™s/ano');
            feriadosData = {};
        }
        
        // Ordem de ciclo dos tipos de presen√ßa (mais impactantes primeiro)
        cicloPresencas = [
            { codigo: '', nome: 'Vazio', cor: '#e9ecef', classe: 'vazio', display: '' },
            { codigo: 'PR', nome: 'Presente', cor: '#28a745', classe: 'presente', display: 'PR' },
            { codigo: 'AU', nome: 'Ausente', cor: '#dc3545', classe: 'ausente', display: 'AU' },
            { codigo: 'FJ', nome: 'Falta Justificada', cor: '#ffc107', classe: 'falta-justificada', display: 'FJ' },
            { codigo: 'FE', nome: 'F√©rias', cor: '#6f42c1', classe: 'ferias', display: 'FE' },
            { codigo: 'FG', nome: 'Folga', cor: '#6c757d', classe: 'folga', display: 'FG' },
            { codigo: 'FD', nome: 'Feriado', cor: '#e83e8c', classe: 'feriado', display: 'FD' },
            { codigo: 'AT', nome: 'Atraso', cor: '#fd7e14', classe: 'atraso', display: 'AT' }
        ];
        
        console.log('Dados carregados:', { presencasData, tiposPresenca, cicloPresencas });
        
        // Inicializar o calend√°rio ap√≥s carregar os dados
        // Limpar sele√ß√£o ao clicar fora do calend√°rio
    document.addEventListener('click', function(event) {
        if (selecaoAtiva && !event.target.closest('.calendario-grid')) {
            limparSelecao();
        }
    });
    
    // Prevenir sele√ß√£o de texto durante o arrasto
    document.addEventListener('selectstart', function(event) {
        if (selecaoAtiva) {
            event.preventDefault();
        }
    });
    
    inicializarCalendario();
    } catch (error) {
        console.error('Erro ao carregar dados do calend√°rio:', error);
    }
});

function inicializarCalendario() {
    console.log('Calend√°rio inicializado:', mesAtual, anoAtual);
    atualizarTituloMes();
    
    // Aguardar um pouco para garantir que o DOM esteja totalmente carregado
    setTimeout(() => {
        console.log('=== INICIANDO CARREGAMENTO DAS PRESEN√áAS ===');
        carregarPresencas();
        exibirFeriadosAutomaticamente();
        exibirFinaisSemanaAutomaticamente();
        console.log('Calend√°rio inicializado com sucesso');
    }, 100);
}

// Fun√ß√£o para atualizar o t√≠tulo do m√™s/ano
function atualizarTituloMes() {
    const meses = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
    const elementoMesAno = document.getElementById('mes-ano');
    if (elementoMesAno) {
        elementoMesAno.textContent = `${meses[mesAtual - 1]} ${anoAtual}`;
    }
}

// Navegar entre meses
function navegarMes(direcao) {
    const novoMes = mesAtual + direcao;
    if (novoMes < 1) {
        mesAtual = 12;
        anoAtual--;
    } else if (novoMes > 12) {
        mesAtual = 1;
        anoAtual++;
    } else {
        mesAtual = novoMes;
    }
    recarregarCalendario();
}

// Filtrar por funcion√°rio
function filtrarFuncionario() {
    const funcionarioId = document.getElementById('funcionario').value;
    const url = new URL(window.location);
    if (funcionarioId) {
        url.searchParams.set('funcionario', funcionarioId);
    } else {
        url.searchParams.delete('funcionario');
    }
    window.location.href = url.toString();
}

// Filtrar por m√™s
function filtrarMes() {
    const mes = document.getElementById('mes').value;
    const url = new URL(window.location);
    url.searchParams.set('mes', mes);
    window.location.href = url.toString();
}

// Filtrar por ano
function filtrarAno() {
    const ano = document.getElementById('ano').value;
    const url = new URL(window.location);
    url.searchParams.set('ano', ano);
    window.location.href = url.toString();
}

// Recarregar calend√°rio
function recarregarCalendario() {
    const baseUrl = window.location.pathname;
    const urlParams = new URLSearchParams(window.location.search);
    urlParams.set('mes', mesAtual);
    urlParams.set('ano', anoAtual);
    const newUrl = `${baseUrl}?${urlParams.toString()}`;
    window.location.href = newUrl;
}

// Carregar presen√ßas no calend√°rio
function carregarPresencas() {
    console.log('=== CARREGANDO PRESEN√áAS ===');
    console.log('Dados recebidos:', presencasData);
    console.log('N√∫mero de presen√ßas:', Object.keys(presencasData).length);
    
    Object.keys(presencasData).forEach(key => {
        const [funcionarioId, dia] = key.split('_');
        const presenca = presencasData[key];
        const indicador = document.querySelector(`[data-funcionario="${funcionarioId}"][data-dia="${dia}"]`);
        
        if (indicador && presenca) {
            const classeTipo = getClasseTipo(presenca.tipo);
            indicador.className = `presenca-indicator ${classeTipo}`;
            indicador.textContent = presenca.tipo;
            
            let tooltip = presenca.tipo_nome;
            if (presenca.observacoes) {
                tooltip += ` - ${presenca.observacoes}`;
            }
            indicador.title = tooltip;
            
            indicador.dataset.presencaId = presenca.id;
            indicador.dataset.tipoAtual = presenca.tipo;
        }
    });
    
    console.log('=== PRESEN√áAS CARREGADAS COM SUCESSO ===');
}

// Exibir feriados automaticamente no calend√°rio
function exibirFeriadosAutomaticamente() {
    console.log('=== INICIANDO EXIBI√á√ÉO DE FERIADOS ===');
    console.log('Dados de feriados recebidos:', feriadosData);
    console.log('Tipo dos dados:', typeof feriadosData);
    console.log('N√∫mero de feriados:', Object.keys(feriadosData).length);
    
    if (!feriadosData || Object.keys(feriadosData).length === 0) {
        console.log('‚ùå Nenhum feriado encontrado para o m√™s');
        return;
    }
    
    console.log('‚úÖ Feriados encontrados, iniciando marca√ß√£o...');
    
    Object.keys(feriadosData).forEach(feriadoKey => {
        const feriado = feriadosData[feriadoKey];
        const dia = feriadoKey.replace('feriado_', '');
        
        console.log(`üìÖ Processando feriado: ${feriado.nome} no dia ${dia}`);
        
        const indicadores = document.querySelectorAll(`[data-dia="${dia}"]`);
        console.log(`üîç Encontrados ${indicadores.length} indicadores para o dia ${dia}`);
        
        indicadores.forEach(indicador => {
            const funcionarioId = indicador.getAttribute('data-funcionario');
            const chavePresenca = `${funcionarioId}_${dia}`;
            
            // SEMPRE sobrescrever com feriado, independentemente de presen√ßa existente
            indicador.className = 'presenca-indicator feriado';
            indicador.textContent = 'FD';
            indicador.title = `Feriado: ${feriado.nome}`;
            
            // Atualizar dados locais sempre
            presencasData[chavePresenca] = {
                tipo: 'FD',
                tipo_nome: 'Feriado',
                observacoes: `Feriado: ${feriado.nome}`
            };
        });
        
        // Verificar se o feriado √© domingo e transferir para segunda-feira
        const dataFeriado = new Date(anoAtual, mesAtual - 1, parseInt(dia));
        const diaSemanaFeriado = dataFeriado.getDay(); // 0 = Domingo, 1 = Segunda, etc.
        
        if (diaSemanaFeriado === 0) { // Domingo
            const proximaSegunda = parseInt(dia) + 1;
            const ultimoDiaDoMes = new Date(anoAtual, mesAtual, 0).getDate();
            
            // Verificar se a pr√≥xima segunda-feira ainda est√° no mesmo m√™s
            if (proximaSegunda <= ultimoDiaDoMes) {
                console.log(`Transferindo feriado de domingo (dia ${dia}) para segunda-feira (dia ${proximaSegunda})`);
                
                const indicadoresSegunda = document.querySelectorAll(`[data-dia="${proximaSegunda}"]`);
                
                indicadoresSegunda.forEach(indicadorSegunda => {
                    const funcionarioIdSegunda = indicadorSegunda.getAttribute('data-funcionario');
                    const chavePresencaSegunda = `${funcionarioIdSegunda}_${proximaSegunda}`;
                    
                    // Marcar segunda-feira como feriado transferido
                    indicadorSegunda.className = 'presenca-indicator feriado';
                    indicadorSegunda.textContent = 'FD';
                    indicadorSegunda.title = `Feriado Transferido: ${feriado.nome} (era domingo)`;
                    
                    // Atualizar dados locais
                    presencasData[chavePresencaSegunda] = {
                        tipo: 'FD',
                        tipo_nome: 'Feriado Transferido',
                        observacoes: `Feriado Transferido: ${feriado.nome} (era domingo)`
                    };
                });
            }
        }
    });
    
    console.log('Feriados exibidos automaticamente com sucesso (sobrescrevendo presen√ßas existentes e transferindo domingos)');
    salvarFeriadosAutomaticamente();
}

// Exibir finais de semana automaticamente no calend√°rio
function exibirFinaisSemanaAutomaticamente() {
    console.log('Exibindo finais de semana automaticamente...');
    
    const funcionarioElement = document.getElementById('funcionario');
    if (!funcionarioElement || !funcionarioElement.value) {
        console.log('Funcion√°rio n√£o selecionado, n√£o marcando finais de semana');
        return;
    }
    
    const diasTrabalho = [1, 2, 3, 4, 5]; // Segunda=1, Domingo=0, S√°bado=6
    const dias = document.querySelectorAll('[data-dia]');
    let finaisSemanaMarcados = 0;
    
    dias.forEach(indicador => {
        const dia = parseInt(indicador.getAttribute('data-dia'));
        const funcionarioId = indicador.getAttribute('data-funcionario');
        const chavePresenca = `${funcionarioId}_${dia}`;
        
        const presencaExistente = presencasData[chavePresenca];
        if (presencaExistente) {
            return;
        }
        
        const data = new Date(anoAtual, mesAtual - 1, dia);
        const diaSemana = data.getDay();
        
        if (!diasTrabalho.includes(diaSemana)) {
            const nomeDia = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'][diaSemana];
            
            indicador.className = 'presenca-indicator folga';
            indicador.textContent = 'FG';
            indicador.title = `Folga - ${nomeDia}`;
            
            presencasData[chavePresenca] = {
                tipo: 'FG',
                tipo_nome: 'Folga',
                observacoes: `Folga - ${nomeDia}`
            };
            
            finaisSemanaMarcados++;
        }
    });
    
    console.log(`Dias de folga marcados automaticamente: ${finaisSemanaMarcados}`);
    salvarFinaisSemanaAutomaticamente();
}

// Salvar feriados automaticamente no banco de dados
async function salvarFeriadosAutomaticamente() {
    console.log('=== INICIANDO SALVAMENTO DE FERIADOS ===');
    console.log('Dados de feriados para salvar:', feriadosData);
    
    if (!feriadosData || Object.keys(feriadosData).length === 0) {
        console.log('‚ùå Nenhum feriado para salvar');
        return;
    }
    
    console.log('‚úÖ Feriados encontrados para salvar, iniciando processo...');
    
    try {
        const funcionarioElement = document.getElementById('funcionario');
        const funcionarioId = funcionarioElement ? funcionarioElement.value : null;
        
        // Se nenhum funcion√°rio espec√≠fico estiver selecionado, marcar para todos os funcion√°rios vis√≠veis
        if (!funcionarioId) {
            console.log('Nenhum funcion√°rio espec√≠fico selecionado, marcando feriados para todos os funcion√°rios vis√≠veis...');
            
            const funcionariosVisiveis = document.querySelectorAll('.funcionario-cell');
            if (funcionariosVisiveis.length === 0) {
                console.log('Nenhum funcion√°rio vis√≠vel encontrado no calend√°rio');
                return;
            }
            
            let funcionariosProcessados = 0;
            
            for (const funcionarioCell of funcionariosVisiveis) {
                const funcionarioRow = funcionarioCell.closest('tr');
                if (!funcionarioRow) continue;
                
                const funcionarioElement = funcionarioRow.querySelector('[data-funcionario]');
                if (!funcionarioElement) continue;
                
                const funcionarioIdAtual = funcionarioElement.getAttribute('data-funcionario');
                if (!funcionarioIdAtual) continue;
                
                try {
                    const response = await fetch('{% url "rh:marcar_feriados_automaticos" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: JSON.stringify({
                            funcionario_id: funcionarioIdAtual,
                            mes: mesAtual,
                            ano: anoAtual,
                            sobrescrever: true
                        })
                    });
                    
                    if (response.ok) {
                        funcionariosProcessados++;
                        console.log(`Feriados salvos para funcion√°rio ${funcionarioIdAtual}`);
                    }
                } catch (error) {
                    console.error(`Erro ao salvar feriados para funcion√°rio ${funcionarioIdAtual}:`, error);
                }
            }
            
            console.log(`Feriados salvos automaticamente para ${funcionariosProcessados} funcion√°rios`);
            return;
        }
        
        // Funcion√°rio espec√≠fico selecionado
        console.log('Salvando feriados automaticamente no banco de dados (sobrescrevendo presen√ßas existentes)...');
        
        const response = await fetch('{% url "rh:marcar_feriados_automaticos" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                funcionario_id: funcionarioId,
                mes: mesAtual,
                ano: anoAtual,
                sobrescrever: true  // Flag para indicar que deve sobrescrever presen√ßas existentes
            })
        });
        
        if (response.ok) {
            const data = await response.json();
            console.log('Feriados salvos automaticamente (sobrescrevendo presen√ßas):', data);
        } else {
            console.log('Erro ao salvar feriados automaticamente:', response.status);
        }
    } catch (error) {
        console.error('Erro ao salvar feriados automaticamente:', error);
    }
}

// Salvar finais de semana automaticamente no banco de dados
async function salvarFinaisSemanaAutomaticamente() {
    try {
        const funcionarioElement = document.getElementById('funcionario');
        if (!funcionarioElement || !funcionarioElement.value) {
            console.log('Funcion√°rio n√£o selecionado, n√£o salvando finais de semana');
            return;
        }
        
        const funcionarioId = funcionarioElement.value;
        console.log('Salvando finais de semana automaticamente no banco de dados...');
        
        const response = await fetch('{% url "rh:marcar_finais_semana_automaticos" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                funcionario_id: funcionarioId,
                mes: mesAtual,
                ano: anoAtual
            })
        });
        
        if (response.ok) {
            const data = await response.json();
            console.log('Finais de semana salvos automaticamente:', data);
        } else {
            console.log('Erro ao salvar finais de semana automaticamente:', response.status);
        }
    } catch (error) {
        console.error('Erro ao salvar finais de semana automaticamente:', error);
    }
}

// Sele√ß√£o m√∫ltipla com arrastar (como Windows Explorer)
let elementosSelecionados = new Set();
let arrastando = false;
let elementoInicial = null;
let duploCliqueDetectado = false;
let selecaoAtiva = false;

// Iniciar sele√ß√£o
function iniciarSelecao(elemento, event) {
    if (event.button !== 0) return; // Apenas bot√£o esquerdo
    
    elementoInicial = elemento;
    arrastando = false;
    duploCliqueDetectado = false;
    selecaoAtiva = true;
    
    // Se Ctrl n√£o est√° pressionado, limpar sele√ß√£o anterior
    if (!event.ctrlKey && !event.metaKey) {
        limparSelecao();
    }
    
    // Aguardar um pouco para distinguir clique de arrasto e duplo clique
    setTimeout(() => {
        if (elementoInicial === elemento && !arrastando && !duploCliqueDetectado) {
            // Clique normal - ciclar presen√ßa
            ciclarPresenca(elemento);
        }
    }, 300);
}

// Continuar sele√ß√£o ao arrastar
function continuarSelecao(elemento) {
    if (!elementoInicial) return;
    
    arrastando = true;
    
    // Adicionar √† sele√ß√£o
    if (!elementosSelecionados.has(elemento)) {
        elemento.classList.add('selecionado');
        elementosSelecionados.add(elemento);
        atualizarBarraAcoes();
    }
}

// Finalizar sele√ß√£o
function finalizarSelecao(elemento) {
    // Resetar ap√≥s um pequeno delay
    setTimeout(() => {
        elementoInicial = null;
        arrastando = false;
        selecaoAtiva = false;
    }, 100);
}

// Selecionar elemento (Ctrl + clique ou clique normal)
function selecionarElemento(elemento, event) {
    // Se Ctrl est√° pressionado, adicionar √† sele√ß√£o
    if (event.ctrlKey || event.metaKey) {
        if (elementosSelecionados.has(elemento)) {
            elemento.classList.remove('selecionado');
            elementosSelecionados.delete(elemento);
        } else {
            elemento.classList.add('selecionado');
            elementosSelecionados.add(elemento);
        }
        atualizarBarraAcoes();
    }
    // Removido: n√£o chamar ciclarPresenca aqui para evitar duplica√ß√£o
    // O ciclarPresenca j√° √© chamado em iniciarSelecao com timeout
}

// Limpar sele√ß√£o
function limparSelecao() {
    elementosSelecionados.forEach(elemento => {
        elemento.classList.remove('selecionado');
    });
    elementosSelecionados.clear();
    selecaoAtiva = false;
    atualizarBarraAcoes();
}

// Atualizar barra de a√ß√µes
function atualizarBarraAcoes() {
    const batchActions = document.getElementById('batchActions');
    const batchCount = document.getElementById('batchCount');
    
    if (elementosSelecionados.size > 0) {
        batchCount.textContent = elementosSelecionados.size;
        batchActions.style.display = 'block';
    } else {
        batchActions.style.display = 'none';
    }
}

// Aplicar presen√ßa em lote
async function aplicarPresencaLote(tipoCodigo) {
    console.log('=== APLICAR PRESEN√áA EM LOTE ===', tipoCodigo, elementosSelecionados.size);
    
    if (elementosSelecionados.size === 0) {
        alert('Nenhum campo selecionado.');
        return;
    }
    
    // Encontrar o tipo de presen√ßa
    const tipoPresencaObj = tiposPresenca.find(t => t.codigo === tipoCodigo);
    console.log('Tipo encontrado:', tipoPresencaObj);
    
    if (!tipoPresencaObj) {
        alert('Tipo de presen√ßa n√£o encontrado.');
        return;
    }
    
    // Se for falta justificada, solicitar justificativa
    let justificativa = '';
    if (tipoCodigo === 'FJ') {
        justificativa = prompt('Digite a justificativa para a falta justificada:');
        if (justificativa === null) {
            return; // Usu√°rio cancelou
        }
        if (justificativa.trim() === '') {
            alert('A justificativa √© obrigat√≥ria para falta justificada.');
            return;
        }
    }
    
    // Confirmar a√ß√£o
    const confirmacao = confirm(`Deseja aplicar "${tipoPresencaObj.nome}" para ${elementosSelecionados.size} campos selecionados?`);
    if (!confirmacao) {
        return;
    }
    
    // Mostrar loading
    const loading = document.getElementById('loading');
    loading.classList.add('show');
    
    let sucessos = 0;
    let erros = 0;
    
    // Converter Set para Array para processar
    const elementosArray = Array.from(elementosSelecionados);
    console.log('Elementos para processar:', elementosArray.length);
    
    // Processar cada elemento selecionado
    for (let i = 0; i < elementosArray.length; i++) {
        const elemento = elementosArray[i];
        console.log(`Processando elemento ${i + 1}/${elementosArray.length}:`, elemento);
        
        try {
            const funcionarioId = elemento.dataset.funcionario;
            const dia = elemento.dataset.dia;
            const mes = elemento.dataset.mes || mesAtual;
            const ano = elemento.dataset.ano || anoAtual;
            
            console.log('Dados do elemento:', { funcionarioId, dia, mes, ano });
            
            const dados = {
                funcionario_id: funcionarioId,
                dia: dia,
                mes: mes,
                ano: ano,
                tipo_presenca_id: tipoPresencaObj.id,
                observacoes: tipoCodigo === 'FJ' ? justificativa.trim() : 'Marcado em lote'
            };
            
            console.log('Dados enviados:', dados);
            
            const response = await fetch('{% url "rh:salvar_presenca_calendario" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(dados)
            });
            
            const resultado = await response.json();
            console.log('Resposta do servidor:', resultado);
            
            if (resultado.success) {
                // Atualizar visual
                elemento.className = `presenca-indicator ${tipoPresencaObj.classe}`;
                elemento.textContent = tipoPresencaObj.display;
                elemento.dataset.tipoAtual = tipoPresencaObj.codigo;
                
                let tooltip = tipoPresencaObj.nome;
                if (tipoCodigo === 'FJ' && justificativa) {
                    tooltip += ` - ${justificativa}`;
                } else {
                    tooltip += ' - Marcado em lote';
                }
                elemento.title = tooltip;
                
                elemento.dataset.presencaId = resultado.presenca_id;
                
                // Efeito visual
                elemento.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    elemento.style.transform = 'scale(1)';
                }, 200);
                
                // Atualizar dados locais
                const key = `${funcionarioId}_${dia}`;
                presencasData[key] = {
                    id: resultado.presenca_id,
                    tipo: tipoPresencaObj.codigo,
                    tipo_nome: tipoPresencaObj.nome,
                    tipo_cor: tipoPresencaObj.cor,
                    observacoes: tipoCodigo === 'FJ' ? justificativa.trim() : 'Marcado em lote'
                };
                
                sucessos++;
                console.log(`‚úÖ Sucesso ${sucessos}: Campo ${funcionarioId}-${dia} marcado`);
            } else {
                erros++;
                console.error(`‚ùå Erro ao marcar campo:`, resultado.error);
            }
        } catch (error) {
            erros++;
            console.error(`‚ùå Erro ao processar campo:`, error);
        }
    }
    
    // Esconder loading
    loading.classList.remove('show');
    
    // Mostrar resultado
    console.log(`Resultado final: ${sucessos} sucessos, ${erros} erros`);
    if (erros === 0) {
        alert(`‚úÖ Sucesso! ${sucessos} campos marcados como "${tipoPresencaObj.nome}"!`);
    } else {
        alert(`‚ö†Ô∏è ${sucessos} campos marcados com sucesso, ${erros} erros encontrados.`);
    }
    
    // Limpar sele√ß√£o ap√≥s aplicar
    limparSelecao();
}

// Ciclar presen√ßa com clique esquerdo
function ciclarPresenca(elemento) {
    try {
        if (!elemento || !(elemento instanceof Element)) {
            console.error('Elemento inv√°lido na fun√ß√£o ciclarPresenca');
            return;
        }
        
        const funcionarioId = elemento.dataset.funcionario;
        const dia = elemento.dataset.dia;
        const mes = elemento.dataset.mes || mesAtual;
        const ano = elemento.dataset.ano || anoAtual;
        const tipoAtual = elemento.dataset.tipoAtual || '';
        
        if (!funcionarioId || !dia) {
            console.error('Dados insuficientes para processar a presen√ßa');
            return;
        }
        
        const chave = `${funcionarioId}_${dia}`;
        
        if (!estadoOriginal.has(chave)) {
            estadoOriginal.set(chave, {
                tipo: tipoAtual,
                presencaId: elemento.dataset.presencaId || null,
                classe: elemento.className,
                texto: elemento.textContent,
                titulo: elemento.title
            });
        }
        
        const indiceAtual = cicloPresencas.findIndex(tipo => tipo.codigo === tipoAtual);
        const proximoIndice = (indiceAtual + 1) % cicloPresencas.length;
        const proximoTipo = cicloPresencas[proximoIndice];
        
        if (proximoTipo.codigo === 'FJ') {
            const justificativa = prompt('Digite a justificativa para a falta justificada:');
            if (justificativa === null) {
                return;
            }
            if (justificativa.trim() === '') {
                alert('A justificativa √© obrigat√≥ria para falta justificada.');
                return;
            }
            
            elemento.className = `presenca-indicator ${proximoTipo.classe}`;
            elemento.textContent = proximoTipo.display;
            elemento.dataset.tipoAtual = proximoTipo.codigo;
            elemento.title = `${proximoTipo.nome} - ${justificativa}`;
            
            const tipoPresencaObj = tiposPresenca.find(t => t.codigo === proximoTipo.codigo);
            alteracoesPendentes.set(chave, {
                acao: 'salvar',
                elemento: elemento,
                dados: {
                    funcionario_id: funcionarioId,
                    dia: parseInt(dia) || 1,
                    mes: parseInt(mes) || new Date().getMonth() + 1,
                    ano: parseInt(ano) || new Date().getFullYear(),
                    tipo_presenca_id: tipoPresencaObj ? tipoPresencaObj.id : null,
                    observacoes: justificativa.trim()
                }
            });
        } else {
            elemento.className = `presenca-indicator ${proximoTipo.classe}`;
            elemento.textContent = proximoTipo.display;
            elemento.dataset.tipoAtual = proximoTipo.codigo;
            elemento.title = proximoTipo.nome;
            
            if (proximoTipo.codigo === '') {
                alteracoesPendentes.set(chave, {
                    acao: 'remover',
                    elemento: elemento,
                    dados: null
                });
            } else {
                const tipoPresencaObj = tiposPresenca.find(t => t.codigo === proximoTipo.codigo);
                alteracoesPendentes.set(chave, {
                    acao: 'salvar',
                    elemento: elemento,
                    dados: {
                        funcionario_id: funcionarioId,
                        dia: parseInt(dia) || 1,
                        mes: parseInt(mes) || new Date().getMonth() + 1,
                        ano: parseInt(ano) || new Date().getFullYear(),
                        tipo_presenca_id: tipoPresencaObj ? tipoPresencaObj.id : null,
                        observacoes: ''
                    }
                });
            }
        }
        
        mostrarBotoesAcao();
    } catch (erro) {
        console.error('Erro ao processar clique no calend√°rio:', erro);
        alert('Ocorreu um erro ao processar sua solicita√ß√£o. Por favor, tente novamente.');
    }
}

// Remover presen√ßa com bot√£o direito
async function removerPresencaRapida(elemento, silencioso = false) {
    const presencaId = elemento.dataset.presencaId;
    
    if (!presencaId) {
        elemento.className = 'presenca-indicator vazio';
        elemento.textContent = '';
        elemento.dataset.tipoAtual = '';
        elemento.title = '';
        delete elemento.dataset.presencaId;
        return;
    }
    
    try {
        const response = await fetch('{% url "rh:remover_presenca_calendario" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ presenca_id: presencaId })
        });
        
        const resultado = await response.json();
        
        if (resultado.success) {
            elemento.className = 'presenca-indicator vazio';
            elemento.textContent = '';
            elemento.dataset.tipoAtual = '';
            elemento.title = '';
            delete elemento.dataset.presencaId;
            
            const key = `${elemento.dataset.funcionario}_${elemento.dataset.dia}`;
            delete presencasData[key];
            
            if (!silencioso) {
                elemento.style.transform = 'scale(0.8)';
                setTimeout(() => {
                    elemento.style.transform = 'scale(1)';
                }, 200);
            }
        } else {
            console.error('Erro ao remover presen√ßa:', resultado.error);
        }
    } catch (error) {
        console.error('Erro ao remover presen√ßa:', error);
    }
}

// Obter classe CSS do tipo de presen√ßa
function getClasseTipo(codigo) {
    const classes = {
        'PR': 'presente',
        'AU': 'ausente',
        'FJ': 'falta-justificada',
        'FE': 'ferias',
        'FG': 'folga',
        'FD': 'feriado',
        'AT': 'atraso'
    };
    return classes[codigo] || 'vazio';
}

// Fechar modal
function fecharModal() {
    document.getElementById('modal-presenca').style.display = 'none';
}

// Salvar presen√ßa
async function salvarPresenca() {
    const tipoPresencaId = document.getElementById('modal-tipo-presenca').value;
    const horasExtras = document.getElementById('modal-horas-extras').value;
    const observacoes = document.getElementById('modal-observacoes').value;
    
    if (!tipoPresencaId) {
        alert('Por favor, selecione um tipo de presen√ßa.');
        return;
    }
    
    const dados = {
        funcionario_id: funcionarioAtual,
        dia: parseInt(diaAtual) || 1,
        mes: parseInt(mesAtual) || new Date().getMonth() + 1,
        ano: parseInt(anoAtual) || new Date().getFullYear(),
        tipo_presenca_id: tipoPresencaId,
        observacoes: observacoes
    };
    
    try {
        const response = await fetch('{% url "rh:salvar_presenca_calendario" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(dados)
        });
        
        const resultado = await response.json();
        
        if (resultado.success) {
            const indicador = document.querySelector(`[data-funcionario="${funcionarioAtual}"][data-dia="${diaAtual}"]`);
            const tipoPresenca = tiposPresenca.find(t => t.id == tipoPresencaId);
            
            if (indicador && tipoPresenca) {
                indicador.className = `presenca-indicator ${getClasseTipo(tipoPresenca.codigo)}`;
                indicador.title = `${tipoPresenca.nome}${horasExtras ? ' - ' + horasExtras + 'h extras' : ''}`;
                indicador.dataset.presencaId = resultado.presenca_id;
            }
            
            const key = `${funcionarioAtual}_${diaAtual}`;
            presencasData[key] = {
                id: resultado.presenca_id,
                tipo: tipoPresenca.codigo,
                tipo_nome: tipoPresenca.nome,
                tipo_cor: tipoPresenca.cor,
                observacoes: observacoes
            };
            
            fecharModal();
        } else {
            alert('Erro ao salvar presen√ßa: ' + resultado.error);
        }
    } catch (error) {
        alert('Erro ao salvar presen√ßa: ' + error.message);
    }
}

// Remover presen√ßa
async function removerPresenca() {
    if (!presencaAtual || !confirm('Tem certeza que deseja remover esta presen√ßa?')) {
        return;
    }
    
    try {
        const response = await fetch('{% url "rh:remover_presenca_calendario" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ presenca_id: presencaAtual.id })
        });
        
        const resultado = await response.json();
        
        if (resultado.success) {
            const indicador = document.querySelector(`[data-funcionario="${funcionarioAtual}"][data-dia="${diaAtual}"]`);
            
            if (indicador) {
                indicador.className = 'presenca-indicator vazio';
                indicador.title = '';
                delete indicador.dataset.presencaId;
            }
            
            const key = `${funcionarioAtual}_${diaAtual}`;
            delete presencasData[key];
            
            fecharModal();
        } else {
            alert('Erro ao remover presen√ßa: ' + resultado.error);
        }
    } catch (error) {
        alert('Erro ao remover presen√ßa: ' + error.message);
    }
}

// Marcar todos os dias √∫teis do m√™s
async function marcarTodosDiasUteis() {
    if (!confirm('Tem certeza que deseja marcar todos os dias √∫teis do m√™s como Presente? Esta a√ß√£o ir√° sobrescrever as marca√ß√µes existentes.')) {
        return;
    }

    const funcionarioElement = document.getElementById('funcionario');
    if (!funcionarioElement) {
        alert('Erro: Elemento de sele√ß√£o de funcion√°rio n√£o encontrado.');
        return;
    }
    
    const funcionarioId = funcionarioElement.value;
    
    // Se nenhum funcion√°rio espec√≠fico estiver selecionado, marcar para todos
    const marcarParaTodos = !funcionarioId;
    
    if (marcarParaTodos) {
        if (!confirm('Nenhum funcion√°rio espec√≠fico selecionado. Deseja marcar todos os dias √∫teis para TODOS os funcion√°rios?\n\nIsso pode demorar alguns minutos dependendo do n√∫mero de funcion√°rios.')) {
            return;
        }
    }

    const diasUteis = [];
    const anoElement = document.getElementById('ano');
    const mesElement = document.getElementById('mes');
    
    if (!anoElement || !mesElement) {
        alert('Erro: Elementos de filtro de data n√£o encontrados.');
        return;
    }
    
    const ano = parseInt(anoElement.value) || new Date().getFullYear();
    const mes = parseInt(mesElement.value) || new Date().getMonth() + 1;
    const ultimoDia = new Date(ano, mes, 0).getDate();
    
    for (let dia = 1; dia <= ultimoDia; dia++) {
        const data = new Date(ano, mes - 1, dia);
        const diaSemana = data.getDay();
        
        if (diaSemana >= 1 && diaSemana <= 5) {
            diasUteis.push(dia);
        }
    }

    if (diasUteis.length === 0) {
        alert('N√£o h√° dias √∫teis neste m√™s.');
        return;
    }

    const loading = document.getElementById('loading');
    loading.classList.add('show');

    let sucessos = 0;
    let erros = 0;
    let funcionariosProcessados = 0;

    if (marcarParaTodos) {
        // Marcar para todos os funcion√°rios vis√≠veis no calend√°rio
        const funcionariosVisiveis = document.querySelectorAll('.funcionario-cell');
        
        for (const funcionarioCell of funcionariosVisiveis) {
            const funcionarioRow = funcionarioCell.closest('tr');
            const funcionarioIdAtual = funcionarioRow.querySelector('[data-funcionario]').getAttribute('data-funcionario');
            
            for (const dia of diasUteis) {
                try {
                    const dados = {
                        funcionario_id: funcionarioIdAtual,
                        dia: dia,
                        mes: mes,
                        ano: ano,
                        tipo_presenca_id: tiposPresenca.find(t => t.codigo === 'PR').id,
                        observacoes: 'Marcado automaticamente para todos'
                    };

                    const response = await fetch('{% url "rh:salvar_presenca_calendario" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify(dados)
                    });

                    const resultado = await response.json();

                    if (resultado.success) {
                        const indicador = document.querySelector(`[data-funcionario="${funcionarioIdAtual}"][data-dia="${dia}"]`);
                        if (indicador) {
                            indicador.className = 'presenca-indicator presente';
                            indicador.textContent = 'PR';
                            indicador.dataset.tipoAtual = 'PR';
                            indicador.title = 'Presente - Marcado automaticamente para todos';
                            indicador.dataset.presencaId = resultado.presenca_id;
                        }

                        const key = `${funcionarioIdAtual}_${dia}`;
                        presencasData[key] = {
                            id: resultado.presenca_id,
                            tipo: 'PR',
                            tipo_nome: 'Presente',
                            tipo_cor: '#28a745',
                            observacoes: 'Marcado automaticamente para todos'
                        };

                        sucessos++;
                    } else {
                        erros++;
                        console.error(`Erro ao marcar dia ${dia} para funcion√°rio ${funcionarioIdAtual}:`, resultado.error);
                    }
                } catch (error) {
                    erros++;
                    console.error(`Erro ao marcar dia ${dia} para funcion√°rio ${funcionarioIdAtual}:`, error);
                }
            }
            
            funcionariosProcessados++;
        }
    } else {
        // Marcar apenas para o funcion√°rio espec√≠fico selecionado
        for (const dia of diasUteis) {
            try {
                const dados = {
                    funcionario_id: funcionarioId,
                    dia: dia,
                    mes: mes,
                    ano: ano,
                    tipo_presenca_id: tiposPresenca.find(t => t.codigo === 'PR').id,
                    observacoes: 'Marcado automaticamente'
                };

                const response = await fetch('{% url "rh:salvar_presenca_calendario" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(dados)
                });

                const resultado = await response.json();

                if (resultado.success) {
                    const indicador = document.querySelector(`[data-funcionario="${funcionarioId}"][data-dia="${dia}"]`);
                    if (indicador) {
                        indicador.className = 'presenca-indicator presente';
                        indicador.textContent = 'PR';
                        indicador.dataset.tipoAtual = 'PR';
                        indicador.title = 'Presente - Marcado automaticamente';
                        indicador.dataset.presencaId = resultado.presenca_id;
                    }

                    const key = `${funcionarioId}_${dia}`;
                    presencasData[key] = {
                        id: resultado.presenca_id,
                        tipo: 'PR',
                        tipo_nome: 'Presente',
                        tipo_cor: '#28a745',
                        observacoes: 'Marcado automaticamente'
                    };

                    sucessos++;
                } else {
                    erros++;
                    console.error(`Erro ao marcar dia ${dia}:`, resultado.error);
                }
            } catch (error) {
                erros++;
                console.error(`Erro ao marcar dia ${dia}:`, error);
            }
        }
    }

    loading.classList.remove('show');

    // Mostrar resultado
    if (erros === 0) {
        if (marcarParaTodos) {
            alert(`‚úÖ Todos os ${sucessos} dias √∫teis foram marcados como Presente para ${funcionariosProcessados} funcion√°rios!`);
        } else {
            alert(`‚úÖ Todos os ${sucessos} dias √∫teis foram marcados como Presente!`);
        }
    } else {
        if (marcarParaTodos) {
            alert(`‚ö†Ô∏è ${sucessos} dias marcados com sucesso para ${funcionariosProcessados} funcion√°rios, ${erros} erros encontrados.`);
        } else {
            alert(`‚ö†Ô∏è ${sucessos} dias marcados com sucesso, ${erros} erros encontrados.`);
        }
    }
}

// Fun√ß√£o para marcar feriados automaticamente
async function marcarFeriadosAutomaticos() {
    const funcionarioElement = document.getElementById('funcionario');
    const anoElement = document.getElementById('ano');
    const mesElement = document.getElementById('mes');
    
    if (!anoElement || !mesElement) {
        alert('Erro: Elementos de filtro n√£o encontrados.');
        return;
    }
    
    const funcionarioId = funcionarioElement ? funcionarioElement.value : null;
    const ano = parseInt(anoElement.value) || new Date().getFullYear();
    const mes = parseInt(mesElement.value) || new Date().getMonth() + 1;
    
    // Se nenhum funcion√°rio espec√≠fico estiver selecionado, marcar para todos
    const marcarParaTodos = !funcionarioId;
    
    if (marcarParaTodos) {
        if (!confirm(`Tem certeza que deseja marcar automaticamente todos os feriados de ${mes}/${ano} para TODOS os funcion√°rios?\n\nIsso pode demorar alguns minutos dependendo do n√∫mero de funcion√°rios.`)) {
            return;
        }
    } else {
        if (!confirm(`Tem certeza que deseja marcar automaticamente todos os feriados de ${mes}/${ano} para o funcion√°rio selecionado?`)) {
            return;
        }
    }
    
    const loading = document.getElementById('loading');
    loading.classList.add('show');
    
    try {
        if (marcarParaTodos) {
            // Marcar feriados para todos os funcion√°rios vis√≠veis
            const funcionariosVisiveis = document.querySelectorAll('.funcionario-cell');
            if (funcionariosVisiveis.length === 0) {
                alert('Nenhum funcion√°rio vis√≠vel encontrado no calend√°rio. Por favor, selecione um funcion√°rio espec√≠fico ou verifique se h√° funcion√°rios cadastrados.');
                loading.classList.remove('show');
                return;
            }
            
            let funcionariosProcessados = 0;
            let totalSucessos = 0;
            let totalErros = 0;
            
            for (const funcionarioCell of funcionariosVisiveis) {
                const funcionarioRow = funcionarioCell.closest('tr');
                if (!funcionarioRow) continue;
                
                const funcionarioElement = funcionarioRow.querySelector('[data-funcionario]');
                if (!funcionarioElement) continue;
                
                const funcionarioIdAtual = funcionarioElement.getAttribute('data-funcionario');
                if (!funcionarioIdAtual) continue;
                
                try {
                    const response = await fetch('{% url "rh:marcar_feriados_automaticos" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({
                            funcionario_id: funcionarioIdAtual,
                            ano: ano,
                            mes: mes,
                            sobrescrever: true
                        })
                    });
                    
                    const responseText = await response.text();
                    
                    if (responseText.trim().startsWith('{') || responseText.trim().startsWith('[')) {
                        try {
                            const data = JSON.parse(responseText);
                            if (data && data.success) {
                                totalSucessos += data.criadas || 0;
                                funcionariosProcessados++;
                            } else {
                                totalErros++;
                            }
                        } catch (parseError) {
                            totalErros++;
                        }
                    } else {
                        funcionariosProcessados++;
                    }
                } catch (error) {
                    totalErros++;
                    console.error(`Erro ao marcar feriados para funcion√°rio ${funcionarioIdAtual}:`, error);
                }
            }
            
            alert(`‚úÖ Feriados marcados para ${funcionariosProcessados} funcion√°rios!\n\nüìä Estat√≠sticas:\n‚Ä¢ Funcion√°rios processados: ${funcionariosProcessados}\n‚Ä¢ Presen√ßas criadas: ${totalSucessos}\n‚Ä¢ Erros: ${totalErros}`);
            window.location.reload();
            
        } else {
            // Marcar feriados para funcion√°rio espec√≠fico
            const response = await fetch('{% url "rh:marcar_feriados_automaticos" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    funcionario_id: funcionarioId,
                    ano: ano,
                    mes: mes,
                    sobrescrever: true
                })
            });

            const responseText = await response.text();
            
            if (responseText.trim().startsWith('{') || responseText.trim().startsWith('[')) {
                try {
                    const data = JSON.parse(responseText);
                    
                    if (data && data.success) {
                        alert(`‚úÖ Sucesso! ${data.message || 'Feriados marcados com sucesso.'}\n\nüìä Estat√≠sticas:\n‚Ä¢ Feriados processados: ${data.total_feriados || 0}\n‚Ä¢ Presen√ßas criadas: ${data.criadas || 0}\n‚Ä¢ Presen√ßas atualizadas: ${data.atualizadas || 0}`);
                        window.location.reload();
                    } else {
                        const errorMsg = data && data.error ? data.error : 'Resposta inv√°lida do servidor';
                        alert(`‚ùå Erro: ${errorMsg}`);
                    }
                } catch (parseError) {
                    console.error('Erro ao analisar a resposta JSON:', parseError);
                    console.error('Resposta do servidor:', responseText);
                    alert('A resposta do servidor n√£o p√¥de ser processada. Verifique o console para mais detalhes.');
                }
            } else {
                console.log('Resposta do servidor (texto):', responseText);
                alert(`‚ÑπÔ∏è ${responseText}`);
            }
        }
    } catch (error) {
        console.error('Erro na requisi√ß√£o:', error);
        alert('‚ùå Erro ao marcar feriados: ' + (error.message || 'Erro desconhecido'));
    } finally {
        loading.classList.remove('show');
    }
}

// Fun√ß√£o para marcar todos os finais de semana do m√™s
async function marcarTodosFinaisSemana() {
    const funcionarioElement = document.getElementById('funcionario');
    const anoElement = document.getElementById('ano');
    const mesElement = document.getElementById('mes');
    
    if (!funcionarioElement || !anoElement || !mesElement) {
        alert('Erro: Elementos de filtro n√£o encontrados.');
        return;
    }
    
    const funcionarioId = funcionarioElement.value;
    const ano = parseInt(anoElement.value) || new Date().getFullYear();
    const mes = parseInt(mesElement.value) || new Date().getMonth() + 1;
    
    // Exigir funcion√°rio espec√≠fico
    if (!funcionarioId) {
        alert('Por favor, selecione um funcion√°rio primeiro.');
        return;
    }
    
    const tipoPresenca = prompt('Digite o c√≥digo do tipo de presen√ßa para dias de folga:\n‚Ä¢ HE = Horas Extras (trabalho extraordin√°rio)\n‚Ä¢ AU = Ausente\n‚Ä¢ FJ = Falta Justificada\n‚Ä¢ Outro c√≥digo:', 'HE');
    
    if (!tipoPresenca) {
        return;
    }
    
    const tipoNome = tiposPresenca.find(t => t.codigo === tipoPresenca)?.nome || tipoPresenca;
    
    const funcionarioTexto = funcionarioElement.options[funcionarioElement.selectedIndex].text;
    
    if (!confirm(`Tem certeza que deseja marcar todos os dias de folga de ${mes}/${ano} como ${tipoNome} (${tipoPresenca}) para ${funcionarioTexto}?\n\nIsso sobrescrever√° a marca√ß√£o autom√°tica de "Folga".`)) {
        return;
    }
    
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'loading-overlay';
    loadingDiv.innerHTML = '<div class="loading-spinner"></div><div>Marcando dias de folga...</div>';
    document.body.appendChild(loadingDiv);
    
    try {
        const response = await fetch('{% url "rh:marcar_finais_semana" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                funcionario_id: funcionarioId,
                ano: ano,
                mes: mes,
                tipo_presenca: tipoPresenca
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`‚úÖ Sucesso! ${data.sucessos} finais de semana marcados automaticamente.`);
            carregarPresencas();
        } else {
            alert(`‚ùå Erro: ${data.error}`);
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('‚ùå Erro ao marcar finais de semana: ' + error.message);
    } finally {
        document.body.removeChild(loadingDiv);
    }
}

// Obter cookie CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Fun√ß√£o para marcar semana completa com duplo clique
async function marcarSemanaCompleta(elemento, event) {
    event.preventDefault();
    event.stopPropagation();
    
    // Marcar que foi detectado duplo clique para evitar execu√ß√£o do clique simples
    duploCliqueDetectado = true;
    
    // Limpar qualquer timeout pendente do clique simples
    if (elementoInicial === elemento) {
        elementoInicial = null;
    }
    
    // Reset da flag ap√≥s um tempo para permitir novos cliques
    setTimeout(() => {
        duploCliqueDetectado = false;
    }, 500);
    
    const funcionarioId = elemento.dataset.funcionario;
    const diaInicial = parseInt(elemento.dataset.dia);
    const mes = parseInt(elemento.dataset.mes || mesAtual);
    const ano = parseInt(elemento.dataset.ano || anoAtual);
    const diaSemanaInicial = parseInt(elemento.dataset.diaSemana);
    
    // Calcular dias at√© sexta-feira (dia_semana = 4)
    let diasAMarcar = [];
    const ultimoDiaDoMes = new Date(ano, mes, 0).getDate();
    
    for (let dia = diaInicial; dia <= ultimoDiaDoMes; dia++) {
        const dataAtual = new Date(ano, mes - 1, dia);
        const diaSemana = dataAtual.getDay();
        
        // Segunda=1, Ter√ßa=2, Quarta=3, Quinta=4, Sexta=5
        // Converter: Domingo do JS (0) para o nosso sistema (6)
        const diaSemanaConvertido = diaSemana === 0 ? 6 : diaSemana - 1;
        
        diasAMarcar.push(dia);
        
        // Parar ao chegar na sexta-feira
        if (diaSemanaConvertido === 4) break;
    }
    
    if (diasAMarcar.length === 0) {
        alert('Nenhum dia para marcar.');
        return;
    }
    
    // Perguntar ao usu√°rio qual tipo de presen√ßa marcar
    const tipoPresenca = prompt(
        'Digite o c√≥digo do tipo de presen√ßa para marcar a semana:\n\n' +
        '‚Ä¢ PR = Presente\n' +
        '‚Ä¢ AU = Ausente\n' +
        '‚Ä¢ FJ = Falta Justificada\n' +
        '‚Ä¢ FE = F√©rias\n' +
        '‚Ä¢ FG = Folga\n' +
        '‚Ä¢ FD = Feriado\n' +
        '‚Ä¢ AT = Atraso\n\n' +
        'C√≥digo:'
    );
    
    if (!tipoPresenca) return;
    
    const tipoPresencaObj = tiposPresenca.find(t => t.codigo === tipoPresenca.toUpperCase());
    if (!tipoPresencaObj) {
        alert('C√≥digo de presen√ßa inv√°lido!');
        return;
    }
    
    // Solicitar justificativa se for Falta Justificada
    let justificativa = '';
    if (tipoPresenca.toUpperCase() === 'FJ') {
        justificativa = prompt('Digite a justificativa para a falta justificada:');
        if (justificativa === null) return;
        if (justificativa.trim() === '') {
            alert('A justificativa √© obrigat√≥ria para falta justificada.');
            return;
        }
    }
    
    // Confirmar a√ß√£o
    const diasTexto = diasAMarcar.length === 1 ? '1 dia' : `${diasAMarcar.length} dias`;
    if (!confirm(
        `Marcar ${diasTexto} (dias ${diasAMarcar[0]} a ${diasAMarcar[diasAMarcar.length-1]}) como "${tipoPresencaObj.nome}"?\n\n` +
        `Apenas dias vazios ser√£o marcados.`
    )) {
        return;
    }
    
    // Mostrar loading
    const loading = document.getElementById('loading');
    loading.classList.add('show');
    
    let sucessos = 0;
    let ignorados = 0;
    let erros = 0;
    
    // Marcar cada dia
    for (const dia of diasAMarcar) {
        try {
            const indicador = document.querySelector(
                `[data-funcionario="${funcionarioId}"][data-dia="${dia}"]`
            );
            
            if (!indicador) {
                erros++;
                continue;
            }
            
            // Verificar se o dia j√° tem presen√ßa marcada
            const chave = `${funcionarioId}_${dia}`;
            if (presencasData[chave] || indicador.dataset.presencaId) {
                ignorados++;
                continue; // N√£o sobrescrever
            }
            
            const dados = {
                funcionario_id: funcionarioId,
                dia: dia,
                mes: mes,
                ano: ano,
                tipo_presenca_id: tipoPresencaObj.id,
                observacoes: tipoPresenca.toUpperCase() === 'FJ' 
                    ? justificativa.trim() 
                    : 'Marcado por semana (duplo clique)'
            };
            
            const response = await fetch('{% url "rh:salvar_presenca_calendario" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(dados)
            });
            
            const resultado = await response.json();
            
            if (resultado.success) {
                // Atualizar visual
                indicador.className = `presenca-indicator ${tipoPresencaObj.classe}`;
                indicador.textContent = tipoPresencaObj.display || tipoPresencaObj.codigo;
                indicador.dataset.tipoAtual = tipoPresencaObj.codigo;
                indicador.dataset.presencaId = resultado.presenca_id;
                
                let tooltip = tipoPresencaObj.nome;
                if (tipoPresenca.toUpperCase() === 'FJ' && justificativa) {
                    tooltip += ` - ${justificativa}`;
                } else {
                    tooltip += ' - Marcado por semana';
                }
                indicador.title = tooltip;
                
                // Atualizar dados locais
                presencasData[chave] = {
                    id: resultado.presenca_id,
                    tipo: tipoPresencaObj.codigo,
                    tipo_nome: tipoPresencaObj.nome,
                    tipo_cor: tipoPresencaObj.cor,
                    observacoes: dados.observacoes
                };
                
                sucessos++;
            } else {
                erros++;
                console.error(`Erro ao marcar dia ${dia}:`, resultado.error);
            }
        } catch (error) {
            erros++;
            console.error(`Erro ao processar dia ${dia}:`, error);
        }
    }
    
    // Esconder loading
    loading.classList.remove('show');
    
    // Mostrar resultado
    let mensagem = `‚úÖ ${sucessos} dia(s) marcado(s) com sucesso!`;
    if (ignorados > 0) {
        mensagem += `\n‚ö†Ô∏è ${ignorados} dia(s) j√° tinham presen√ßa marcada (ignorados).`;
    }
    if (erros > 0) {
        mensagem += `\n‚ùå ${erros} erro(s) encontrado(s).`;
    }
    alert(mensagem);
}

// Mostrar bot√µes de a√ß√£o em lote
function mostrarBotoesAcao() {
    const batchActions = document.getElementById('batch-actions');
    const batchCount = document.getElementById('batch-count');
    
    if (alteracoesPendentes.size > 0) {
        batchCount.textContent = alteracoesPendentes.size;
        batchActions.style.display = 'block';
    } else {
        batchActions.style.display = 'none';
    }
}

// Guardar todas as altera√ß√µes pendentes
async function guardarTodasAlteracoes() {
    if (alteracoesPendentes.size === 0) {
        return;
    }
    
    const loading = document.getElementById('loading');
    loading.classList.add('show');
    
    let sucessos = 0;
    let erros = 0;
    
    try {
        for (const [chave, alteracao] of alteracoesPendentes) {
            try {
                if (alteracao.acao === 'salvar') {
                    const response = await fetch('{% url "rh:salvar_presenca_calendario" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify(alteracao.dados)
                    });
                    
                    const resultado = await response.json();
                    
                    if (resultado.success) {
                        const tipoPresencaObj = tiposPresenca.find(t => t.id == alteracao.dados.tipo_presenca_id);
                        presencasData[chave] = {
                            id: resultado.presenca_id,
                            tipo: tipoPresencaObj?.codigo || '',
                            tipo_nome: tipoPresencaObj?.nome || '',
                            tipo_cor: tipoPresencaObj?.cor || '',
                            observacoes: alteracao.dados.observacoes
                        };
                        
                        if (tipoPresencaObj?.codigo === 'FJ' && alteracao.dados.observacoes) {
                            alteracao.elemento.title = `${tipoPresencaObj.nome} - ${alteracao.dados.observacoes}`;
                        } else {
                            alteracao.elemento.title = tipoPresencaObj?.nome || '';
                        }
                        
                        alteracao.elemento.dataset.presencaId = resultado.presenca_id;
                        sucessos++;
                    } else {
                        erros++;
                        console.error('Erro ao salvar presen√ßa:', resultado.error);
                    }
                } else if (alteracao.acao === 'remover') {
                    const presencaId = alteracao.elemento.dataset.presencaId;
                    if (presencaId) {
                        const response = await fetch('{% url "rh:remover_presenca_calendario" %}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCookie('csrftoken')
                            },
                            body: JSON.stringify({ presenca_id: presencaId })
                        });
                        
                        const resultado = await response.json();
                        
                        if (resultado.success) {
                            delete presencasData[chave];
                            delete alteracao.elemento.dataset.presencaId;
                            sucessos++;
                        } else {
                            erros++;
                            console.error('Erro ao remover presen√ßa:', resultado.error);
                        }
                    } else {
                        sucessos++;
                    }
                }
            } catch (error) {
                erros++;
                console.error('Erro na opera√ß√£o:', error);
            }
        }
        
        alteracoesPendentes.clear();
        estadoOriginal.clear();
        mostrarBotoesAcao();
        contarPresencasAusencias();
        
        if (erros === 0) {
            alert(`‚úÖ Todas as ${sucessos} altera√ß√µes foram salvas com sucesso!`);
        } else {
            alert(`‚ö†Ô∏è ${sucessos} altera√ß√µes salvas, ${erros} erros encontrados.`);
        }
        
    } finally {
        loading.classList.remove('show');
    }
}

// Cancelar todas as altera√ß√µes pendentes
function cancelarTodasAlteracoes() {
    if (alteracoesPendentes.size === 0) {
        return;
    }
    
    if (!confirm(`Tem certeza que deseja cancelar todas as ${alteracoesPendentes.size} altera√ß√µes pendentes?`)) {
        return;
    }
    
    for (const [chave, alteracao] of alteracoesPendentes) {
        const estadoOrig = estadoOriginal.get(chave);
        if (estadoOrig) {
            alteracao.elemento.className = estadoOrig.classe;
            alteracao.elemento.textContent = estadoOrig.texto;
            alteracao.elemento.dataset.tipoAtual = estadoOrig.tipo;
            alteracao.elemento.title = estadoOrig.titulo;
            
            if (estadoOrig.presencaId) {
                alteracao.elemento.dataset.presencaId = estadoOrig.presencaId;
            } else {
                delete alteracao.elemento.dataset.presencaId;
            }
        }
    }
    
    alteracoesPendentes.clear();
    estadoOriginal.clear();
    mostrarBotoesAcao();
    contarPresencasAusencias();
    
    alert('‚ùå Todas as altera√ß√µes foram canceladas.');
}

// Fun√ß√£o para contar presen√ßas e aus√™ncias
function contarPresencasAusencias() {
    try {
        const elementosPresenca = document.querySelectorAll('.presenca-indicator[data-funcionario]');
        
        let totalPresencas = 0;
        let totalAusencias = 0;
        let totalFeriados = 0;
        let totalFaltas = 0;
        
        elementosPresenca.forEach(elemento => {
            const tipoPresenca = elemento.dataset.tipoAtual;
            
            if (tipoPresenca) {
                switch(tipoPresenca) {
                    case 'PR':
                        totalPresencas++;
                        break;
                    case 'AU':
                        totalAusencias++;
                        break;
                    case 'FD':
                        totalFeriados++;
                        break;
                    case 'FJ':
                        totalFaltas++;
                        break;
                }
            }
        });
        
        const contadorPresencas = document.getElementById('contador-presencas');
        const contadorAusencias = document.getElementById('contador-ausencias');
        const contadorFeriados = document.getElementById('contador-feriados');
        const contadorFaltas = document.getElementById('contador-faltas');
        
        if (contadorPresencas) contadorPresencas.textContent = totalPresencas;
        if (contadorAusencias) contadorAusencias.textContent = totalAusencias;
        if (contadorFeriados) contadorFeriados.textContent = totalFeriados;
        if (contadorFaltas) contadorFaltas.textContent = totalFaltas;
        
        console.log(`Contadores atualizados - Presen√ßas: ${totalPresencas}, Aus√™ncias: ${totalAusencias}, Feriados: ${totalFeriados}, Faltas: ${totalFaltas}`);
        
    } catch (error) {
        console.error('Erro ao contar presen√ßas e aus√™ncias:', error);
    }
}

// Fechar modal ao clicar fora dele
window.onclick = function(event) {
    const modal = document.getElementById('modal-presenca');
    if (event.target == modal) {
        fecharModal();
    }
}
</script>
{% endblock %}